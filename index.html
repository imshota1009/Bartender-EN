<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bartender Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- MediaPipe Hands for skeleton detection -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700&family=M+PLUS+Rounded+1c:wght@700&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Cinzel:wght@400;700&display=swap"
        rel="stylesheet">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111;
            background-image: radial-gradient(circle at center, #333 0%, #111 70%);
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .font-title {
            font-family: 'Playfair Display', serif;
        }

        .font-jp {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        .game-view {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            /* Fallback */
            height: 100dvh;
            max-height: 900px;
            background-image: url('images/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #262626;
            /* Fallback color */
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.5);
            border: 4px solid #4a5568;
            /* Ensure bottom doesn't get cut off on mobile browsers with bars */
            padding-bottom: env(safe-area-inset-bottom);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 768px) {
            .game-view {
                height: 95vh;
                max-height: 900px;
                border: 4px solid #4a5568;
                border-radius: 1rem;
            }
        }

        #bar-counter {
            background-color: #6d4c41;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.05) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.05) 75%, transparent 75%, transparent);
            background-size: 30px 30px;
            border-top: 5px solid #8d6e63;
        }

        .ingredient-bottle {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            height: 90px;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 4px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            box-shadow: inset 0 -10px 20px -5px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.7rem;
            text-align: center;
            line-height: 1.1;
        }

        .ingredient-bottle:hover {
            transform: scale(1.05) translateY(-5px);
            filter: brightness(1.2);
        }

        .ingredient-bottle.selected {
            transform: scale(1.1) translateY(-10px);
            filter: brightness(1.5);
            box-shadow: 0 0 15px 5px var(--glow-color, #fff);
        }

        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0) rotate(-1deg);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0) rotate(2deg);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0) rotate(-4deg);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0) rotate(4deg);
            }
        }

        #customer {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out, filter 0.3s;
            height: 120px;
            width: 120px;
            object-fit: contain;
        }

        #customer.slide-in {
            transform: translateX(0) scale(1);
            opacity: 1;
        }

        #customer.slide-out {
            transform: translateX(100px) scale(0.8);
            opacity: 0;
        }

        #customer.angry {
            filter: sepia(0.8) saturate(3) hue-rotate(-50deg) brightness(0.8);
        }

        /* Time of Day Backgrounds */
        #bg-window {
            transition: background 2s ease;
            background-size: cover;
            background-position: center;
        }

        .time-morning {
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
        }

        .time-day {
            background: linear-gradient(to bottom, #4FC3F7, #FFF59D);
        }

        /* .time-evening unused in current logic but kept for safety */
        .time-evening {
            background: linear-gradient(to bottom, #FF9800, #F57C00);
        }

        .time-night {
            background: linear-gradient(to bottom, #1a237e, #000000);
        }

        #customer-dialogue {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.98);
            color: #333;
            padding: 10px 18px;
            border-radius: 16px;
            min-width: 200px;
            max-width: 300px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            z-index: 30;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(251, 191, 36, 0.5);
            font-size: 0.9rem;
            line-height: 1.4;
            font-weight: 500;
        }

        #customer-dialogue.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #customer-dialogue::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.98) transparent transparent transparent;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
        }

        #game-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .boss-mode::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, rgba(153, 27, 27, 0.4) 100%);
            box-shadow: inset 0 0 50px rgba(153, 27, 27, 0.8);
            pointer-events: none;
            z-index: 5;
            animation: boss-pulse 2s infinite alternate;
        }

        @keyframes boss-pulse {
            from {
                opacity: 0.5;
            }

            to {
                opacity: 1;
            }
        }

        .timer-danger {
            animation: pulse-danger 1s infinite;
        }

        @keyframes pulse-danger {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 10px 10px rgba(220, 38, 38, 0);
            }
        }

        .floating-text {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            animation: float-up 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes float-up {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        /* Performance Mode Styles */
        body.low-quality * {
            text-shadow: none !important;
            box-shadow: none !important;
            transition: none !important;
            animation: none !important;
            filter: none !important;
        }

        body.low-quality .boss-mode::after,
        body.low-quality #game-overlay,
        body.low-quality .ice-cube,
        body.low-quality .floating-text,
        body.low-quality .particle {
            display: none !important;
        }

        /* Settings Range Slider Customization */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #eab308;
            cursor: pointer;
            margin-top: -6px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }

        .animate-fill {
            animation: fill-glass 0.5s ease-out forwards;
        }

        .button-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 10px 15px rgba(59, 130, 246, 0);
            }
        }

        .ice-cube {
            position: absolute;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 4px;
        }

        #happy-hour-banner {
            text-shadow: 0 0 10px #fde047, 0 0 20px #fde047;
            animation: happy-hour-glow 1.5s infinite alternate;
        }

        @keyframes happy-hour-glow {
            from {
                opacity: 0.8;
            }

            to {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        #combo-display {
            transition: transform 0.2s, opacity 0.2s;
            text-shadow: 0 0 5px #f97316, 0 0 10px #f97316;
        }

        .garnish-button {
            transition: transform 0.2s;
        }

        .garnish-button:hover {
            transform: scale(1.2);
        }

        .upgrade-button:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #recipe-display {
            transition: opacity 0.3s ease-in-out;
        }

        /* Language Switch */
        .lang-switch {
            cursor: pointer;
            width: 80px;
            height: 34px;
            background-color: #4a5568;
            border-radius: 17px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-around;
            font-weight: bold;
            font-size: 12px;
            color: white;
            padding: 0 5px;
        }

        .lang-switch-toggle {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
        }

        .lang-switch.en .lang-switch-toggle {
            transform: translateX(44px);
        }

        /* Story Overlay */
        #story-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease-in-out;
            text-align: center;
            padding: 2rem;
        }

        #story-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .story-title {
            font-size: 3rem;
            font-family: 'Playfair Display', serif;
            color: #fbbf24;
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease 0.5s;
        }

        .story-text {
            font-size: 1.2rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            line-height: 2;
            color: #e5e7eb;
            max-width: 600px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease 1s;
        }

        .story-continue {
            margin-top: 3rem;
            opacity: 0;
            transition: opacity 1s ease 2s;
            animation: pulse 2s infinite;
            cursor: pointer;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        #story-overlay.active .story-title,
        #story-overlay.active .story-text,
        #story-overlay.active .story-continue {
            opacity: 1;
            transform: translateY(0);
        }

        /* Boss Mode Styles */
        .boss-mode #game-container {
            box-shadow: 0 0 50px rgba(220, 38, 38, 0.5);
            border-color: #7f1d1d;
        }

        .boss-mode #bar-counter {
            filter: sepia(0.2) contrast(1.1);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Real-time Backgrounds */
        #bg-window {
            /* Basic Window Shape */
            background-size: cover;
            background-position: center;
        }

        .time-morning {
            background: linear-gradient(to bottom, #7dd3fc, #fde047);
        }

        /* Sky to Sun */
        .time-day {
            background: linear-gradient(to bottom, #38bdf8, #bae6fd);
        }

        /* Bright Blue */
        .time-evening {
            background: linear-gradient(to bottom, #c084fc, #f97316);
        }

        /* Purple to Orange */
        .time-night {
            background: linear-gradient(to bottom, #1e3a8a, #312e81);
        }

        /* Dark Blue */
        .time-midnight {
            background: linear-gradient(to bottom, #0f172a, #000000);
        }

        /* Deep Dark */

        /* Camera Shake Feature Styles */
        #camera-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
            z-index: 100;
            background: #000;
            display: none;
        }

        #camera-container.active {
            display: block;
            animation: camera-glow 1s infinite alternate;
        }

        @keyframes camera-glow {
            from {
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
            }

            to {
                box-shadow: 0 0 40px rgba(251, 191, 36, 0.9);
            }
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            /* Mirror effect */
        }

        #camera-canvas {
            display: none;
        }

        #shake-counter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
            color: #fbbf24;
            text-shadow: 0 0 10px #000, 0 0 20px #fbbf24;
            pointer-events: none;
            z-index: 101;
            opacity: 0;
            transition: opacity 0.3s, transform 0.2s;
        }

        #shake-counter.active {
            opacity: 1;
        }

        #shake-counter .shake-pulse {
            animation: pulse-red 0.5s ease-in-out;
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .jukebox-track {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #1f2937;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .jukebox-track:hover {
            background: #374151;
            transform: translateX(4px);
        }

        .jukebox-track.active {
            border-color: #6366f1;
            background: #312e81;
        }

        .jukebox-track .icon {
            font-size: 1.5rem;
            margin-right: 12px;
        }

        .jukebox-track .info {
            flex-grow: 1;
        }

        .jukebox-track .title {
            font-weight: bold;
            color: #e5e7eb;
            font-family: 'Noto Serif JP', serif;
        }

        /* Photo Mode Styles - Hide UI */
        body.photo-mode .no-capture {
            display: none !important;
        }

        body.photo-mode #control-panel,
        body.photo-mode footer,
        body.photo-mode #help-button,
        body.photo-mode #settings-btn,
        body.photo-mode #language-switch,
        body.photo-mode #daily-earnings-display {
            display: none !important;
        }

        /* Mystery Mode Styles */
        body.mystery-mode {
            filter: grayscale(0.8) contrast(1.2) brightness(0.7);
            background-image: radial-gradient(circle at center, #000 0%, #1a0505 100%);
        }

        body.mystery-mode #game-container {
            border-color: #4a0404;
            box-shadow: 0 0 50px rgba(74, 4, 4, 0.5);
        }

        body.mystery-mode .ingredient-bottle {
            filter: grayscale(1) !important;
        }

        body.mystery-mode #customer-dialogue {
            font-family: 'Courier New', monospace;
            color: #ff0000;
            text-shadow: 2px 2px 0px #000;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ff0000;
        }

        @keyframes shake-pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.5);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        #camera-mode-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 0.75rem;
        }

        #camera-mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.7);
        }

        #camera-mode-btn.active {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            animation: btn-active-glow 1.5s infinite alternate;
        }

        @keyframes btn-active-glow {
            from {
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            }

            to {
                box-shadow: 0 0 25px rgba(34, 197, 94, 0.9);
            }
        }

        #shake-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 6px;
            background: linear-gradient(90deg, #22c55e, #fbbf24);
            width: 0%;
            transition: width 0.2s ease-out;
            border-radius: 0 0 12px 12px;
        }

        #camera-overlay-text {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 0.65rem;
            text-shadow: 0 0 5px #000;
            pointer-events: none;
            white-space: nowrap;
        }

        .motion-flash {
            animation: motion-flash 0.15s ease-out;
        }

        @keyframes motion-flash {
            0% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.5);
            }

            100% {
                filter: brightness(1);
            }
        }

        /* Skeleton Canvas for Hand Tracking */
        #skeleton-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* Detection Status Indicator */
        #detection-status {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
            transition: all 0.3s;
        }

        #detection-status.detected {
            background: rgba(34, 197, 94, 0.9);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        #detection-status.not-detected {
            background: rgba(239, 68, 68, 0.8);
        }

        #detection-icon {
            font-size: 1rem;
        }

        #detection-text {
            color: #fff;
            font-weight: bold;
        }

        /* Hand detected animation */
        @keyframes hand-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        #detection-status.detected #detection-icon {
            animation: hand-pulse 1s infinite;
        }

        /* Help/Rules Overlay Styles */
        #help-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: 3px solid #fff;
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 90;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
            transition: all 0.3s;
            display: none;
        }

        #help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.7);
        }

        #help-button.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #help-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }

        #help-overlay.active {
            display: block;
        }

        .help-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 30px;
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 20px;
            border: 2px solid #6366f1;
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.3);
        }

        .help-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            color: #fbbf24;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }

        .help-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .help-section-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section-content {
            color: #e5e7eb;
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .help-section-content ul {
            list-style: none;
            padding: 0;
        }

        .help-section-content li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .help-section-content li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: #fbbf24;
        }

        .help-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .help-step-number {
            width: 28px;
            height: 28px;
            min-width: 28px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .help-close-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .help-close-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.5);
        }

        .help-tip {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
        }

        .help-tip strong {
            display: block;
            margin-bottom: 5px;
        }

        /* ===== NEW FEATURES STYLES ===== */

        /* Menu Button */
        #menu-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            border: 3px solid #fff;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 90;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.5);
            transition: all 0.3s;
            display: none;
        }

        #menu-button:hover {
            transform: scale(1.1);
        }

        #menu-button.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Menu Overlay */
        #menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 200;
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        #menu-overlay.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            /* Changed from center to prevent top cutoff */
            padding-top: 60px;
            gap: 12px;
            /* Reduced gap */
        }

        .menu-btn {
            width: 280px;
            padding: 14px;
            /* Reduced from 20px */
            border-radius: 16px;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .menu-btn:hover {
            transform: scale(1.05);
        }

        .menu-btn-cocktail {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
        }

        .menu-btn-customer {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: #fff;
        }

        .menu-btn-market {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }

        .menu-btn-title {
            background: linear-gradient(135deg, #ec4899, #db2777);
            color: #fff;
        }

        .menu-btn-close {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: #fff;
            margin-top: 20px;
        }

        /* Encyclopedia Overlay (shared) */
        .encyclopedia-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.97);
            z-index: 210;
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        .encyclopedia-overlay.active {
            display: block;
        }

        .encyclopedia-content {
            max-width: 700px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .encyclopedia-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        /* Interior Customization Styles */
        /* Wallpaper Styles */
        .wall-classic {
            /* background image is set in .game-view, do not override */
        }

        .wall-modern::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(180deg, rgba(55, 65, 81, 0.5) 0%, rgba(31, 41, 55, 0.5) 100%);
            z-index: 0;
        }

        .wall-fantasy::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(180deg, rgba(76, 29, 149, 0.5) 0%, rgba(49, 46, 129, 0.5) 100%);
            z-index: 0;
        }

        /* Lighting Styles */
        .light-warm::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at 50% 0%, rgba(255, 183, 77, 0.2) 0%, transparent 60%);
            z-index: 1;
        }

        .light-cool::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at 50% 0%, rgba(96, 165, 250, 0.2) 0%, transparent 60%);
            z-index: 1;
        }

        .light-neon::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at 50% 0%, rgba(236, 72, 153, 0.15) 0%, transparent 60%),
                radial-gradient(ellipse at 20% 50%, rgba(34, 211, 238, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 50%, rgba(168, 85, 247, 0.1) 0%, transparent 40%);
            z-index: 1;
            animation: neonPulse 3s ease-in-out infinite;
        }

        @keyframes neonPulse {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 1;
            }
        }

        .encyclopedia-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .encyclopedia-progress {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .encyclopedia-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .encyclopedia-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .encyclopedia-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .encyclopedia-item.locked {
            opacity: 0.5;
        }

        .encyclopedia-item-image {
            width: 80px;
            height: 80px;
            margin: 0 auto 8px;
            border-radius: 50%;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .encyclopedia-item-name {
            font-size: 0.85rem;
            font-weight: bold;
            color: #fff;
        }

        .encyclopedia-close {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 220;
        }

        /* Market Overlay */
        #market-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.97);
            z-index: 210;
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        #market-overlay.active {
            display: block;
        }

        .market-content {
            max-width: 700px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .market-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .market-title {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 8px;
        }

        .market-money {
            font-size: 1.2rem;
            color: #fbbf24;
        }

        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }

        .market-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .market-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .market-item.owned {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.2);
        }

        .market-item.affordable:not(.owned):hover {
            border-color: #fbbf24;
        }

        .market-item.too-expensive {
            opacity: 0.5;
        }

        .market-item-color {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .market-item-name {
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }

        .market-item-price {
            font-size: 0.75rem;
            color: #fbbf24;
        }

        .market-item-owned {
            font-size: 0.7rem;
            color: #10b981;
        }

        /* Title Display */
        #title-display {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.9), rgba(219, 39, 119, 0.9));
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #fff;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.4);
        }

        /* Title Celebration */
        .title-celebration {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .title-celebration.active {
            display: flex;
            animation: fadeIn 0.5s;
        }

        .title-celebration-icon {
            font-size: 5rem;
            animation: bounce 1s infinite;
        }

        .title-celebration-text {
            font-size: 1.5rem;
            color: #fff;
            text-align: center;
        }

        .title-celebration-name {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Detail Modal */
        .detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 250;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .detail-modal.active {
            display: flex;
        }

        .detail-content {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .detail-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            object-fit: cover;
        }

        .detail-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 10px;
        }

        .detail-info {
            color: #d1d5db;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .detail-close {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ===== PHASE 2: WEATHER, DRUNK, ANIMATIONS ===== */

        /* Weather Overlay */
        #weather-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 5;
            overflow: hidden;
        }

        /* Rain Effect */
        .weather-rain .rain-drop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, transparent, rgba(174, 194, 224, 0.5));
            animation: rain-fall linear infinite;
        }

        @keyframes rain-fall {
            0% {
                transform: translateY(-100vh);
            }

            100% {
                transform: translateY(100vh);
            }
        }

        /* Snow Effect */
        .weather-snow .snow-flake {
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: snow-fall linear infinite;
        }

        @keyframes snow-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Weather Indicator */
        #weather-indicator {
            position: absolute;
            top: 8px;
            right: 80px;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 50;
        }

        /* Drunk Text Effect */
        .drunk-text {
            animation: drunk-wobble 0.5s ease-in-out infinite;
        }

        @keyframes drunk-wobble {

            0%,
            100% {
                transform: rotate(-1deg);
            }

            50% {
                transform: rotate(1deg);
            }
        }

        .drunk-heavy .drunk-text {
            animation: drunk-heavy-wobble 0.3s ease-in-out infinite;
            color: #f472b6 !important;
        }

        @keyframes drunk-heavy-wobble {

            0%,
            100% {
                transform: rotate(-3deg) translateX(-2px);
            }

            50% {
                transform: rotate(3deg) translateX(2px);
            }
        }

        /* Passed Out Effect */
        .customer-passed-out {
            filter: grayscale(0.8) brightness(0.6);
            animation: passed-out 2s ease-in-out infinite;
        }

        @keyframes passed-out {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(5px);
            }
        }

        /* Drunk Meter */
        #drunk-meter {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            z-index: 25;
        }

        #drunk-meter-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
            transition: width 0.3s;
        }

        /* Liquid Shake Animation */
        .shaker-liquid-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: inherit;
            animation: liquid-wave 0.15s ease-in-out infinite alternate;
        }

        @keyframes liquid-wave {
            0% {
                transform: translateY(0) skewX(-5deg);
                border-radius: 0 0 5px 5px;
            }

            100% {
                transform: translateY(-5px) skewX(5deg);
                border-radius: 5px 5px 0 0;
            }
        }

        /* Sparkle Particles */
        .sparkle-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: visible;
        }

        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #fff 0%, #fbbf24 50%, transparent 70%);
            border-radius: 50%;
            animation: sparkle-burst 1s ease-out forwards;
        }

        @keyframes sparkle-burst {
            0% {
                opacity: 1;
                transform: scale(0) translate(0, 0);
            }

            50% {
                opacity: 1;
                transform: scale(1.5) translate(var(--tx), var(--ty));
            }

            100% {
                opacity: 0;
                transform: scale(0.5) translate(calc(var(--tx) * 2), calc(var(--ty) * 2));
            }
        }

        /* Seasonal Event Banner */
        #event-banner {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            z-index: 50;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
            display: none;
        }

        #event-banner.active {
            display: block;
            animation: event-pulse 2s infinite;
        }

        @keyframes event-pulse {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.05);
            }
        }

        /* Christmas Theme */
        .event-christmas #event-banner {
            background: linear-gradient(135deg, #dc2626, #16a34a);
        }

        /* Summer Festival Theme */
        .event-summer #event-banner {
            background: linear-gradient(135deg, #f97316, #facc15);
        }

        /* Inquiry Modal Styles */
        .inquiry-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .inquiry-modal {
            background: #2a2a2a;
            border: 2px solid #555;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 24px;
            color: white;
            position: relative;
        }

        .inquiry-modal h2 {
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
        }

        .inquiry-form-group {
            margin-bottom: 16px;
        }

        .inquiry-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }

        .inquiry-form-group select,
        .inquiry-form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
        }

        .inquiry-form-group textarea {
            height: 120px;
            resize: none;
        }

        .inquiry-submit-btn {
            width: 100%;
            padding: 12px;
            background: #d4af37;
            color: black;
            font-weight: bold;
            border-radius: 8px;
            margin-top: 10px;
        }

        .inquiry-submit-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        /* Save Slot Styles */
        .save-slot {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .save-slot:hover {
            border-color: #f59e0b;
            background: rgba(31, 41, 55, 0.95);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .save-slot.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        .save-slot.active {
            border-color: #f59e0b;
            background: rgba(67, 56, 202, 0.4);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }

        /* Avatar Card */
        .avatar-card {
            transition: all 0.3s ease;
        }

        .avatar-card:hover {
            transform: scale(1.05);
            border-color: #f59e0b;
        }

        /* --- Bottle Collection & Auction Styles --- */
        .bottle-grid-item {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #4b5563;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
        }

        .bottle-grid-item.owned {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.1), rgba(0, 0, 0, 0.3));
            border-color: #fbbf24;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.2);
        }

        .bottle-grid-item.owned:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .bottle-grid-item img {
            max-width: 80%;
            max-height: 80%;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
        }

        .bottle-grid-item.locked img {
            filter: brightness(0) invert(1) opacity(0.2);
        }

        .bottle-shiny {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bottle-shiny::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to bottom right,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0) 40%,
                    rgba(255, 255, 255, 0.4) 50%,
                    rgba(255, 255, 255, 0) 60%,
                    rgba(255, 255, 255, 0) 100%);
            transform: rotate(45deg) translate(-100%, -100%);
            animation: shiny-sweep 3s infinite;
        }

        @keyframes shiny-sweep {
            0% {
                transform: rotate(45deg) translate(-100%, -100%);
            }

            20% {
                transform: rotate(45deg) translate(100%, 100%);
            }

            100% {
                transform: rotate(45deg) translate(100%, 100%);
            }
        }

        /* Auction Specifics */
        .auction-paddle {
            transition: transform 0.1s;
        }

        .auction-paddle:active {
            transform: scale(0.9) rotate(-10deg);
        }

        .bid-log-entry {
            animation: fade-in-up 0.3s ease-out;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Vegetable Market Styles --- */
        .market-grid-item {
            background: #3f2e21;
            /* Dark wood */
            border: 4px solid #8d6e63;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .market-grid-item:hover {
            transform: translateY(-5px);
        }

        .market-price-tag {
            background: #dc2626;
            color: white;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin-top: 4px;
        }

        .harvest-item {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffffff55;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: all 0.2s;
            position: relative;
        }

        .harvest-item.owned {
            background: rgba(34, 197, 94, 0.2);
            border-color: #4ade80;
            opacity: 1;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        .harvest-item img {
            max-width: 90%;
            max-height: 90%;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        .harvest-item.locked img {
            filter: grayscale(1) brightness(0.3);
        }

        /* Cyberpunk Title Animation */
        .cyber-title-enter {
            animation: cyber-slide-in 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards, cyber-glitch 3s infinite alternate;
            background: linear-gradient(90deg, #22d3ee, #e879f9);
            /* Cyan to Pink */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 5px rgba(34, 211, 238, 0.5));
            position: relative;
            display: inline-block;
        }

        @keyframes cyber-slide-in {
            0% {
                transform: translateX(-100vw) skewX(-20deg);
                opacity: 0;
                filter: blur(10px) hue-rotate(90deg);
            }

            70% {
                transform: translateX(20px) skewX(10deg);
                opacity: 1;
                filter: blur(0);
            }

            100% {
                transform: translateX(0) skewX(0);
                opacity: 1;
            }
        }

        @keyframes cyber-glitch {
            0% {
                text-shadow: 2px 2px 0px #0ff, -2px -2px 0px #f0f;
            }

            90% {
                text-shadow: 2px 2px 0px #0ff, -2px -2px 0px #f0f;
            }

            92% {
                text-shadow: -2px 1px 0px #0ff, 1px -1px 0px #f0f;
                transform: translateX(2px);
            }

            94% {
                text-shadow: 1px -2px 0px #0ff, -1px 2px 0px #f0f;
                transform: translateX(-2px);
            }

            96% {
                text-shadow: -1px 2px 0px #0ff, 2px -1px 0px #f0f;
            }

            100% {
                text-shadow: 2px 2px 0px #0ff, -2px -2px 0px #f0f;
            }
        }

        /* Title Screen Background */
        #game-overlay {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('images/background/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="text-white flex items-center justify-center min-h-screen">

    <!-- Weather Overlay -->
    <div id="weather-overlay"></div>

    <!-- Game View -->
    <div id="game-container" class="game-view mx-auto rounded-2xl md:p-6 flex-col relative overflow-hidden hidden">
        <!-- Scrollable Game Content with Optimized Safe Area Padding -->
        <div id="game-scroll-wrapper" class="w-full h-full overflow-y-auto flex flex-col p-4 pb-24 md:pb-4"
            style="padding-bottom: max(6rem, env(safe-area-inset-bottom)); background: rgba(0, 0, 0, 0.25);">
            <!-- Title Display -->
            <div id="title-display" class="font-jp">🌱 Apprentice Bartender</div>
            <!-- Weather Indicator -->
            <div id="weather-indicator" class="font-jp">☀️ Sunny</div>
            <!-- Event Banner -->
            <div id="event-banner" class="font-jp">🎆 Event Active!</div>
            <header class="grid grid-cols-2 items-start mb-1 px-2 relative font-jp shrink-0">
                <div class="flex flex-col text-left">
                    <h2 class="text-sm md:text-lg font-bold"><span data-lang-key="dayLabel">Day</span>: <span
                            id="day-display">1</span></h2>
                    <h2 class="text-sm md:text-lg font-bold"><span data-lang-key="moneyLabel">Money</span>: ¥<span
                            id="money-display">0</span></h2>
                    <div id="score-display" class="mt-2 relative">
                        <h2 class="text-lg md:text-xl font-bold"><span data-lang-key="salesLabel">Today's Sales</span>:
                            ¥<span id="score">0</span></h2>
                    </div>
                </div>
                <div id="combo-display"
                    class="absolute left-1/2 -translate-x-1/2 top-0 text-3xl font-bold text-orange-400 opacity-0 transform scale-50">
                </div>
                <div class="flex flex-col items-start justify-end gap-2 md:gap-4">
                    <div class="flex gap-2 md:gap-4 ml-auto items-center">
                        <button id="jukebox-btn" onclick="openJukebox()"
                            class="bg-indigo-600 rounded-full p-2 w-10 h-10 flex items-center justify-center text-white hover:bg-indigo-500 shadow-lg transition-transform hover:scale-105 z-20"
                            title="BGM Select">
                            🎵
                        </button>
                        <div id="timer-display"
                            class="bg-red-600 rounded-full px-3 py-1 md:px-4 md:py-2 transition-all duration-300 flex-shrink-0">
                            <h2 class="text-lg md:text-2xl font-bold"><span data-lang-key="timeLabel">Time</span>: <span
                                    id="timer">300</span></h2>
                        </div>
                        <!-- Language Switch (Hidden - Japanese Only) -->
                        <div id="language-switch" class="lang-switch" style="display: none;">
                            <span>JA</span>
                            <span>EN</span>
                            <div class="lang-switch-toggle"></div>
                        </div>
                    </div>
                    <div class="flex items-end justify-end ml-auto">
                        <div id="recipe-display"
                            class="bg-gray-900/70 p-2 rounded-lg border border-gray-500 text-right opacity-0 text-xs md:text-sm">
                        </div>
                    </div>
                </div>
            </header>
            <main class="flex-grow flex flex-col relative">
                <div id="happy-hour-banner"
                    class="absolute -top-4 w-full text-center text-4xl font-bold text-yellow-300 font-jp hidden z-10">
                </div>
                <!-- Customer Area - Compact -->
                <div id="customer-area"
                    class="h-[200px] md:h-[280px] flex flex-col items-center justify-end mb-1 relative z-0 shrink-0 pt-10">
                    <!-- Window Background (hidden - using background image instead) -->
                    <div id="bg-window"
                        class="absolute top-4 bottom-0 left-1/2 -translate-x-1/2 w-64 h-full bg-gray-800 rounded-t-full border-4 border-amber-900 border-b-0 opacity-80 z-0 transition-all duration-1000 overflow-hidden box-border pointer-events-none"
                        style="display: none;">
                        <!-- Horizontal Grid for Window Pane Effect -->
                        <div class="absolute top-1/2 w-full h-2 bg-amber-900/50"></div>
                        <div class="absolute left-1/2 h-full w-2 bg-amber-900/50 -translate-x-1/2"></div>
                    </div>

                    <div id="customer-dialogue" class="font-jp z-20"></div>
                    <img id="customer" class="mb-2 opacity-0 transform -translate-x-12 max-h-[180px] z-20 relative"
                        src="" alt="Customer">
                    <div id="order-bubble"
                        class="bg-gray-200 p-2 md:p-3 rounded-lg shadow-lg text-gray-800 flex flex-col items-center gap-1 md:gap-2 opacity-0 transition-opacity duration-300 absolute bottom-0 right-0 md:static z-20">
                        <div id="customer-name" class="font-bold font-jp text-xs md:text-sm text-gray-600"></div>
                        <div class="flex items-center gap-2">
                            <p class="font-bold font-jp text-xs md:text-base" data-lang-key="orderLabel">Order:</p>
                            <div id="order-text" class="font-bold text-sm md:text-lg font-jp"></div>
                            <div id="order-ingredients"
                                class="flex gap-1 md:gap-2 flex-wrap max-w-[100px] md:max-w-none justify-center"></div>
                        </div>
                    </div>
                    <!-- Drunk Meter -->
                    <div id="drunk-meter">
                        <div id="drunk-meter-fill"></div>
                    </div>
                </div>
                <!-- Bar Counter -->
                <div id="bar-counter"
                    class="p-2 md:p-4 flex-grow flex items-center justify-between gap-2 md:gap-4 rounded-lg relative mb-4">
                    <!-- Shaker & Buttons -->
                    <div class="w-1/3 flex flex-col items-center justify-end h-full gap-2">
                        <div id="shaker-area"
                            class="w-16 h-28 md:w-24 md:h-40 bg-gray-400 rounded-t-lg border-4 border-gray-300 relative flex items-end overflow-hidden shadow-inner">
                            <div id="shaker-ice-cubes" class="absolute inset-0"></div>
                            <div id="shaker-contents" class="w-full h-full transition-all duration-300"></div>
                        </div>
                        <div class="flex flex-col gap-1 w-full max-w-[140px]">
                            <button id="add-ice-button" data-lang-key="addIce"
                                class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md">Ice</button>
                            <button id="glass-button" data-lang-key="glassLabel"
                                class="bg-purple-500 hover:bg-purple-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md">Glass</button>
                            <button id="ingredient-button" data-lang-key="ingredientsLabel"
                                class="bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md">Ingredients</button>

                            <div class="flex gap-1">
                                <button id="shake-button" data-lang-key="shake"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md">Shake</button>
                            </div>
                            <button id="gesture-shake-btn"
                                class="w-full bg-pink-500 hover:bg-pink-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md"
                                onclick="toggleGestureShake()">
                                📱 Gesture
                            </button>
                            <button id="photo-btn"
                                class="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md"
                                onclick="openPhotoMode()">
                                📸 Photo
                            </button>
                            <div class="flex gap-1 w-full">
                                <button id="talk-button" data-lang-key="talk"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md flex-1">Talk</button>
                                <button id="gift-button" onclick="openGiftMenu()"
                                    class="bg-pink-500 hover:bg-pink-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md flex-1">🎁
                                    Gift</button>
                                <button id="matchmake-button"
                                    class="bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md hidden flex-1"
                                    onclick="openMatchmaking()">Matchmake</button>
                            </div>
                            <button id="reset-button" data-lang-key="reset"
                                class="bg-red-700 hover:bg-red-800 text-white text-xs font-bold py-2 px-2 rounded hover:scale-105 transition-transform font-jp shadow-md">Reset</button>
                        </div>
                    </div>
                    <!-- Glass & Result -->
                    <div class="w-2/3 flex flex-col items-center justify-center">
                        <div id="cocktail-glass" class="w-24 h-32 md:w-32 md:h-40 relative">
                            <svg viewBox="0 0 100 120" class="w-full h-full filter drop-shadow-lg">
                                <!-- Paths injected by JS -->
                            </svg>
                            <div id="liquid-mask" class="absolute inset-0 w-full h-full pointer-events-none">
                                <div id="final-cocktail"
                                    class="absolute left-0 right-0 mx-auto w-full h-0 bg-transparent"></div>
                            </div>

                        </div>
                        <div id="result-text" class="text-xl md:text-2xl font-bold mt-2 h-8 font-jp text-center"></div>
                    </div>
                </div>
            </main>
            <!-- Footer Removed (Ingredients moved to overlay) -->
        </div>
    </div>

    <!-- Overlays (Fixed relative to game-container) -->
    <div id="garnish-container"
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/80 p-6 rounded-lg text-white font-jp shadow-lg z-40 hidden flex-col items-center gap-4">
    </div>
    <div id="glass-selection-overlay"
        class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center hidden">
        <h2 class="text-3xl font-bold text-white mb-8 font-jp" data-lang-key="glassLabel">Select Glass:</h2>
        <div class="grid grid-cols-3 gap-4 md:gap-8 w-full max-w-lg px-4">
            <div class="glass-option cursor-pointer bg-gray-800/80 p-4 rounded-xl hover:bg-gray-700 active:scale-95 transition-all flex flex-col items-center gap-2"
                onclick="selectGlass('collins')">
                <div
                    class="w-12 h-20 md:w-16 md:h-24 border-2 border-white/50 rounded-sm bg-white/10 pointer-events-none">
                </div>
                <span class="text-white font-jp text-sm md:text-base pointer-events-none"
                    data-lang-key="glassCollins">Collins</span>
            </div>
            <div class="glass-option cursor-pointer bg-gray-800/80 p-4 rounded-xl hover:bg-gray-700 active:scale-95 transition-all flex flex-col items-center gap-2"
                onclick="selectGlass('rocks')">
                <div
                    class="w-12 h-10 md:w-16 md:h-12 border-2 border-white/50 rounded-sm bg-white/10 mt-10 md:mt-12 pointer-events-none">
                </div>
                <span class="text-white font-jp text-sm md:text-base pointer-events-none"
                    data-lang-key="glassRocks">Rocks</span>
            </div>
            <div class="glass-option cursor-pointer bg-gray-800/80 p-4 rounded-xl hover:bg-gray-700 active:scale-95 transition-all flex flex-col items-center gap-2"
                onclick="selectGlass('cocktail')">
                <div class="w-12 h-12 md:w-16 md:h-16 border-2 border-white/50 rounded-b-full bg-white/10 mt-8 pointer-events-none"
                    style="clip-path: polygon(0 0, 100% 0, 50% 100%);"></div>
                <span class="text-white font-jp text-sm md:text-base pointer-events-none"
                    data-lang-key="glassCocktail">Cocktail</span>
            </div>
        </div>
        <button onclick="document.getElementById('glass-selection-overlay').classList.add('hidden')"
            class="mt-8 px-6 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-700 transition-colors font-jp shadow-lg border-2 border-red-400">
            Cancel
        </button>
    </div>

    <!-- Photo Mode Overlay -->
    <div id="photo-mode-overlay"
        class="fixed inset-0 bg-black/95 z-[300] flex flex-col items-center justify-center hidden">
        <div class="text-center">
            <h2 class="text-2xl font-bold text-white mb-4 font-jp" data-lang-key="photoTitle">📷 Photo Mode</h2>
            <div id="photo-preview" class="bg-gray-800 rounded-lg p-4 mb-4 inline-block">
                <canvas id="photo-canvas" style="max-width: 90vw; max-height: 50vh;"></canvas>
            </div>
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="downloadPhoto()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg font-jp text-lg">
                    💾 Save
                </button>
                <button onclick="shareToTwitter()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg font-jp text-lg">
                    𝕏 Share
                </button>
                <button onclick="shareToLINE()"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg font-jp text-lg">
                    LINE
                </button>
                <button onclick="closePhotoMode()"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg font-jp text-lg"
                    data-lang-key="menuClose">
                    ✖ Close
                </button>
            </div>
        </div>
    </div>

    <!-- Ingredient Selection Overlay -->
    <div id="ingredient-selection-overlay"
        class="absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-start pt-10 pb-4 px-4 hidden">
        <h2 class="text-3xl font-bold text-white mb-6 font-jp" data-lang-key="ingredientsLabel">Select Ingredients</h2>
        <div id="ingredient-grid"
            class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4 w-full max-w-4xl overflow-y-auto custom-scrollbar p-2 pb-20">
            <!-- Javascript will populate this -->
        </div>
        <button id="close-ingredient-overlay"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg font-jp">Close</button>
    </div>
    </div>
    </div>
    </div>

    <!-- Room View -->
    <div id="room-container" class="game-view mx-auto rounded-2xl p-6 md:p-8 flex-col relative hidden bg-gray-800">
        <header class="text-center pb-4 border-b-2 border-white/10 mb-6">
            <h1 class="font-title text-5xl" data-lang-key="dayEndTitle">Day End</h1>
            <p class="font-jp text-lg text-gray-300"><span data-lang-key="dayLabel">Day</span> <span
                    id="room-day-display">1</span> - <span data-lang-key="dayEndSubtitle">Business Closed</span></p>
        </header>

        <main class="flex-grow flex flex-col justify-between">
            <div class="bg-gray-900/50 rounded-lg p-6 text-center mb-6">
                <p class="font-jp text-xl text-gray-400" data-lang-key="dailyEarningsLabel">Today's Earnings</p>
                <p class="font-bold text-4xl text-yellow-300 my-2">¥<span id="daily-earnings-display">0</span></p>
                <hr class="border-gray-600 my-4">
                <p class="font-jp text-xl text-gray-400" data-lang-key="totalAssetsLabel">Total Assets</p>
                <p class="font-bold text-4xl">¥<span id="room-money-display">0</span></p>
            </div>

            <div id="upgrades-section"
                class="bg-gray-900/50 rounded-lg p-6 max-h-[300px] overflow-y-auto custom-scrollbar">
                <h2 class="font-jp text-2xl font-bold text-center mb-4" data-lang-key="upgradesTitle">Upgrades</h2>
                <div class="space-y-3">
                </div>
                <div class="space-y-3">
                </div>
            </div>

            <!-- Secrets Section Removed -->
        </main>
        <footer class="text-center pt-6 pb-24 md:pb-6 flex flex-col gap-4 items-center" style="padding-bottom: 200px;">
            <div class="flex gap-4">
                <button onclick="openMarket()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform font-jp">🛒
                    Buy Ingredients</button>
                <button id="room-save-button" onclick="saveGameManually()"
                    class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform font-jp">💾
                    Save Game</button>
            </div>
            <button id="next-day-button" data-lang-key="nextDayButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform font-jp button-pulse">Next
                Day</button>
        </footer>
    </div>

    <!-- Help Button (Fixed) -->
    <button id="help-button" class="font-jp">?</button>

    <!-- Help/Rules Overlay -->
    <div id="help-overlay">
        <div class="help-content font-jp">
            <h1 class="help-title" data-lang-key="helpTitle">📖 How to Play</h1>

            <div class="help-section">
                <div class="help-section-title" data-lang-key="helpBasicsTitle">🎯 Goal</div>
                <div class="help-section-content" data-lang-key="helpBasicsText">
                    Serve cocktails as ordered and earn money!<br>
                    Run the bar for 7 days and become a legend!
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title" data-lang-key="helpMakingTitle">🍸 How to Make Cocktails</div>
                <div class="help-section-content">
                    <div class="help-step">
                        <div class="help-step-number">1</div>
                        <div data-lang-key="helpStep1">Check the customer's order (Recipe shown in top right)</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">2</div>
                        <div data-lang-key="helpStep2">Tap <strong>Ingredients</strong> to select spirits/mixers</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">3</div>
                        <div data-lang-key="helpStep3">Tap <strong>Ice</strong> if the recipe requires it</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">4</div>
                        <div data-lang-key="helpStep4">Tap <strong>Glass</strong> to choose the correct glass</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">5</div>
                        <div data-lang-key="helpStep5">Tap <strong>Shake</strong> to finish!</div>
                    </div>
                </div>
            </div>



            <div class="help-section">
                <div class="help-section-title" data-lang-key="helpButtonsTitle">🔘 Buttons</div>
                <div class="help-section-content" data-lang-key="helpButtonsText">
                    <ul>
                        <li><strong>Ingredients</strong> - Choose materials</li>
                        <li><strong>Ice</strong> - Add ice</li>
                        <li><strong>Glass</strong> - Choose glass type</li>
                        <li><strong>Shake</strong> - Finish cocktail</li>
                        <li><strong>Talk</strong> - Chat with customer (Bonus!)</li>
                        <li><strong>Reset</strong> - Start over</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title" data-lang-key="helpTipsTitle">⭐ Tips</div>
                <div class="help-section-content" data-lang-key="helpTipsText">
                    <ul>
                        <li>Follow recipes for <strong>Combo Bonuses</strong>!</li>
                        <li><strong>Talk</strong> to get tips</li>
                        <li>Buy <strong>Upgrades</strong> at day end</li>
                        <li>Serve fast for high scores!</li>
                    </ul>
                </div>
            </div>

            <div class="help-tip" data-lang-key="helpHint">
                <strong>💡 Hint</strong>
                Tap the "?" button anytime to see this guide!
            </div>

            <button id="help-close-btn" class="help-close-btn" data-lang-key="helpCloseBtn">Got it! Back to
                Game</button>
        </div>
    </div>

    <!-- Save Slot Selection Screen -->
    <div id="game-overlay"
        class="absolute inset-0 flex flex-col items-center justify-center transition-opacity duration-500 z-30 bg-black/90">

        <!-- Part 1: Initial Start Screen -->
        <div id="title-screen-content" class="flex flex-col items-center justify-center gap-4">
            <h1 class="font-title text-6xl md:text-8xl mb-4 cyber-title-enter">Bartender</h1>
            <div class="flex flex-col gap-6 w-full max-w-xs">
                <button id="new-game-btn" onclick="openCharacterSelection(1)"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg transition-all hover:scale-105 active:scale-95 font-jp">New
                    Game</button>
                <button id="continue-game-btn" onclick="loadAndStart(1)"
                    class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg transition-all hover:scale-105 active:scale-95 font-jp">Continue</button>
                <button id="tutorial-btn" onclick="startTutorial()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg transition-all hover:scale-105 active:scale-95 font-jp">🔰
                    Tutorial</button>
            </div>
            <button id="help-start-btn" data-lang-key="helpViewBtn"
                class="mt-6 text-blue-400 hover:text-blue-300 font-jp text-lg border-b border-blue-500/30">📖
                How to Play</button>
        </div>

        <!-- Part 3: Character Selection -->
        <div id="character-selection-content" class="hidden w-full max-w-2xl p-6">
            <h2 class="text-3xl font-bold text-amber-500 mb-8 text-center font-jp">Select Character</h2>
            <div class="flex justify-center gap-12">
                <!-- Male Character -->
                <div onclick="startNewGame(1, 'images/avatar/man.png')"
                    class="flex flex-col items-center gap-4 cursor-pointer hover:scale-110 transition-transform group">
                    <img src="images/avatar/man.png"
                        class="w-32 h-32 rounded-full border-4 border-blue-500/50 bg-black/40 object-cover group-hover:border-blue-400 shadow-xl">
                    <span class="text-xl font-bold text-blue-400 font-jp">Male</span>
                </div>
                <!-- Female Character -->
                <div onclick="startNewGame(1, 'images/avatar/woman.png')"
                    class="flex flex-col items-center gap-4 cursor-pointer hover:scale-110 transition-transform group">
                    <img src="images/avatar/woman.png"
                        class="w-32 h-32 rounded-full border-4 border-pink-500/50 bg-black/40 object-cover group-hover:border-pink-400 shadow-xl">
                    <span class="text-xl font-bold text-pink-400 font-jp">Female</span>
                </div>
            </div>
            <div class="mt-12 flex justify-center">
                <button
                    onclick="document.getElementById('character-selection-content').classList.add('hidden'); document.getElementById('title-screen-content').classList.remove('hidden');"
                    class="text-gray-400 hover:text-white underline font-jp text-lg">Back</button>
            </div>
        </div>
    </div>

    <!-- Vegetable Collection Overlay -->
    <div id="collection-overlay"
        class="absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-center hidden p-4">
        <h2 class="text-3xl font-bold text-green-400 mb-2 font-jp">🥬 Harvest Guide</h2>
        <p class="text-gray-400 mb-6 font-jp text-sm">Fresh vegetables collected from the market (<span
                id="collection-count">0</span>/19)</p>

        <div id="vegetable-grid"
            class="grid grid-cols-6 md:grid-cols-8 gap-2 md:gap-3 overflow-y-auto custom-scrollbar p-2 max-h-[60vh] w-full max-w-3xl bg-gray-900/50 rounded-xl border border-gray-700">
            <!-- Injected by JS -->
        </div>

        <div class="mt-8 flex gap-4">
            <button onclick="openMarketOverlay()"
                class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-full font-jp shadow-[0_0_20px_rgba(245,158,11,0.4)] transition-all hover:scale-105 border-2 border-amber-400">
                🏪 Go to Market
            </button>
            <button onclick="openKitchenOverlay()"
                class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-8 rounded-full font-jp shadow-[0_0_20px_rgba(244,63,94,0.4)] transition-all hover:scale-105 border-2 border-rose-400">
                🥤 Go to Kitchen
            </button>
            <button onclick="closeCollection()"
                class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full font-jp transition-all">
                Close
            </button>
        </div>
    </div>

    <!-- Kitchen Overlay -->
    <div id="kitchen-overlay"
        class="absolute inset-0 bg-black/95 z-[70] flex flex-col items-center justify-center hidden p-4">
        <h2 class="text-3xl font-bold text-rose-400 mb-6 font-jp">🥤 Veggie Kitchen</h2>

        <!-- Mixing Area -->
        <div class="flex items-center gap-4 mb-8 bg-gray-800 p-6 rounded-xl border border-gray-600">
            <div id="kitchen-slot-1" onclick="clearKitchenSlot(0)"
                class="w-24 h-24 bg-black/40 border-2 border-dashed border-gray-500 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-700 transition-colors relative">
                <span class="text-gray-500 text-2xl font-bold">+</span>
            </div>
            <div class="text-white text-2xl font-bold">+</div>
            <div id="kitchen-slot-2" onclick="clearKitchenSlot(1)"
                class="w-24 h-24 bg-black/40 border-2 border-dashed border-gray-500 rounded-lg flex items-center justify-center cursor-pointer hover:bg-gray-700 transition-colors relative">
                <span class="text-gray-500 text-2xl font-bold">+</span>
            </div>
            <div class="text-white text-2xl font-bold">=</div>
            <button onclick="mixSmoothie()" id="kitchen-mix-btn"
                class="w-24 h-24 bg-rose-600 hover:bg-rose-500 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg border-4 border-rose-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95">
                MIX!
            </button>
        </div>

        <p class="text-gray-400 mb-2 font-jp text-sm">Select ingredients</p>
        <div id="kitchen-inventory-grid"
            class="grid grid-cols-6 md:grid-cols-8 gap-2 overflow-y-auto custom-scrollbar p-2 max-h-[30vh] w-full max-w-2xl bg-gray-900/50 rounded-xl border border-gray-700 mb-6">
            <!-- Injected by JS -->
        </div>

        <button onclick="closeKitchenOverlay()"
            class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg transition-colors">
            Back
        </button>
    </div>

    <!-- Gift Overlay -->
    <div id="gift-overlay"
        class="absolute inset-0 bg-black/95 z-[80] flex flex-col items-center justify-center hidden p-4">
        <h2 class="text-3xl font-bold text-pink-400 mb-2">🎁 Give Gift</h2>
        <p class="text-gray-400 mb-6 text-sm">A token of appreciation for your customers...</p>

        <div id="gift-grid"
            class="grid grid-cols-6 md:grid-cols-8 gap-2 overflow-y-auto custom-scrollbar p-2 max-h-[60vh] w-full max-w-3xl bg-gray-900/50 rounded-xl border border-gray-700">
            <!-- Injected by JS -->
        </div>

        <button onclick="closeGiftMenu()"
            class="mt-8 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg font-jp transition-colors">
            Cancel
        </button>
    </div>

    <!-- Market Overlay (Vegetable) -->
    <div id="vegetable-market-overlay"
        class="absolute inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center hidden p-4">
        <div class="bg-[#5d4037] p-6 rounded-lg w-full max-w-4xl border-4 border-[#3e2723] shadow-2xl relative">
            <h2 class="text-3xl font-bold text-white mb-6 font-jp text-center border-b-2 border-[#8d6e63] pb-4">
                🏪 Today's Fresh Market <span class="text-sm font-normal text-amber-300 ml-2">Every day fresh!</span>
            </h2>

            <div class="flex justify-between items-center mb-4 px-4">
                <div class="bg-black/40 px-4 py-2 rounded-lg text-white font-jp">
                    Money: <span class="text-yellow-400 font-bold text-xl">¥<span
                            id="vegetable-market-money-display">0</span></span>
                </div>
                <div class="flex gap-2">
                    <button onclick="setMarketMode('buy')" id="market-btn-buy"
                        class="px-4 py-1 rounded bg-green-600 text-white font-bold font-jp border-2 border-green-400 shadow-lg scale-105 transition-all">Buy</button>
                    <button onclick="setMarketMode('sell')" id="market-btn-sell"
                        class="px-4 py-1 rounded bg-gray-700 text-gray-400 font-bold font-jp border-2 border-gray-600 hover:bg-red-900/50 hover:text-red-200 hover:border-red-800 transition-all">Sell</button>
                </div>
            </div>

            <div id="vegetable-market-grid"
                class="grid grid-cols-2 md:grid-cols-4 gap-4 overflow-y-auto max-h-[50vh] custom-scrollbar p-2">
                <!-- Market Items Injected Here -->
            </div>

            <div class="mt-6 flex justify-center">
                <button onclick="closeMarketOverlay()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg font-jp transition-colors">
                    Leave Market
                </button>
            </div>
        </div>
    </div>

    <!-- Ending Overlay -->
    <div id="ending-overlay"
        class="absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-center hidden text-center p-8">
        <h1 id="ending-title" class="font-title text-5xl md:text-7xl mb-6 text-yellow-400">THE END</h1>
        <p id="ending-rank" class="font-jp text-2xl md:text-3xl text-white mb-4">Rank: ???</p>
        <p class="font-jp text-xl text-gray-400 mb-8">Total Assets: ¥<span id="ending-money">0</span></p>
        <p id="ending-message" class="font-jp text-lg text-white/80 max-w-2xl leading-relaxed mb-8">...</p>
        <button onclick="location.reload()"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform font-jp button-pulse">Title
            Screen</button>
    </div>

    <!-- Camera Container for Real Shake -->


    <!-- Story Overlay -->
    <div id="story-overlay">
        <h1 id="story-title" class="story-title">Chapter 1</h1>
        <p id="story-text" class="story-text">The story begins...</p>
        <p class="story-continue font-jp">Click to start</p>
    </div>

    <!-- Menu Button -->
    <button id="menu-button" class="font-jp">☰</button>

    <!-- Menu Overlay -->
    <div id="menu-overlay">
        <h2 class="text-3xl font-bold text-white mb-8 font-jp" data-lang-key="menuTitle">📋 Menu</h2>
        <button class="menu-btn menu-btn-cocktail font-jp" onclick="openCocktailEncyclopedia()"
            data-lang-key="menuCocktails">
            🍸 Cocktail Encyclopedia
        </button>
        <button class="menu-btn menu-btn-customer font-jp" onclick="openCustomerEncyclopedia()"
            data-lang-key="menuCustomers">
            👥 Customer Encyclopedia
        </button>
        <button class="menu-btn menu-btn-title font-jp" onclick="openTitleList()" data-lang-key="menuTitles">
            🏆 Titles
        </button>
        <button class="menu-btn menu-btn-interior font-jp" onclick="openInteriorShop()" data-lang-key="menuInterior">
            🏠 Interior
        </button>
        <button class="menu-btn menu-btn-settings font-jp" onclick="openSettings()" data-lang-key="menuSettings">
            ⚙️ Settings
        </button>
        <button class="menu-btn menu-btn-save font-jp text-green-400 border-green-500/50" onclick="saveGameManually()"
            data-lang-key="menuSave">
            💾 Save
        </button>
        <button class="menu-btn menu-btn-inquiry font-jp text-blue-400 border-blue-500/50" onclick="openInquiry()"
            data-lang-key="menuInquiry">
            📮 Inquiry
        </button>
        <button class="menu-btn menu-btn-collection font-jp text-green-400 border-green-500/50"
            onclick="openCollection()"
            style="border: 2px solid rgba(34, 197, 94, 0.5); background: linear-gradient(90deg, rgba(34, 197, 94, 0.1), transparent);">
            🥦 Vegetable Market & Collection
        </button>
        <button class="menu-btn bg-gray-600 text-white font-jp" onclick="returnToTitle()">
            🏠 Return to Title
        </button>
        <button class="menu-btn menu-btn-close font-jp" onclick="closeMenu()" data-lang-key="menuClose">
            ✖ Close
        </button>
    </div>

    <!-- Interior Shop Overlay -->
    <div id="interior-shop-overlay" class="encyclopedia-overlay">
        <div class="encyclopedia-content" style="max-width: 600px;">
            <div class="encyclopedia-header">
                <h2 class="encyclopedia-title text-amber-400 font-jp" data-lang-key="interiorTitle">🏠 Interior
                    Customization</h2>
                <p class="text-white/60 font-jp" id="interior-money">Money: ¥0</p>
            </div>
            <div id="interior-shop-content" style="padding: 15px; display: flex; flex-direction: column; gap: 20px;">
                <!-- Categories added dynamically -->
            </div>
            <button class="encyclopedia-close font-jp" onclick="closeInteriorShop()" data-lang-key="menuClose">✖
                Close</button>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="encyclopedia-overlay">
        <div class="encyclopedia-content" style="max-width: 400px;">
            <div class="encyclopedia-header">
                <h2 class="encyclopedia-title text-amber-400 font-jp" data-lang-key="settingsTitle">⚙️ 設定</h2>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <label class="font-jp text-white text-lg block mb-2" data-lang-key="languageLabel">🌐 言語 /
                        Language</label>
                    <select id="language-select" class="font-jp"
                        style="width: 100%; padding: 10px; border-radius: 8px; font-size: 16px; background: #333; color: white; border: 2px solid #555;">
                        <option value="ja">🇯🇵 日本語</option>
                        <option value="en">🇺🇸 English</option>
                    </select>
                    <p class="text-gray-400 text-sm mt-2 font-jp" data-lang-key="languageNote">※ 言語変更は再起動後に反映されます</p>
                </div>
                <button onclick="saveSettingsAndRestart()"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg font-jp text-lg mt-4"
                    data-lang-key="saveAndRestart">
                    💾 保存して再起動
                </button>
            </div>
            <button class="encyclopedia-close font-jp" onclick="closeSettings()" data-lang-key="menuClose">✖
                閉じる</button>
        </div>
    </div>

    <!-- Cocktail Encyclopedia Overlay -->
    <div id="cocktail-encyclopedia" class="encyclopedia-overlay">
        <div class="encyclopedia-content">
            <div class="encyclopedia-header">
                <h2 class="encyclopedia-title text-amber-400 font-jp">🍸 Cocktail Encyclopedia</h2>
                <p id="cocktail-progress" class="encyclopedia-progress">Discovered: 0 / 0</p>
            </div>
            <div id="cocktail-grid" class="encyclopedia-grid">
                <!-- Populated by JS -->
            </div>
        </div>
        <button class="encyclopedia-close font-jp" onclick="closeCocktailEncyclopedia()">Close</button>
    </div>

    <!-- Customer Encyclopedia Overlay -->
    <div id="customer-encyclopedia" class="encyclopedia-overlay">
        <div class="encyclopedia-content">
            <div class="encyclopedia-header">
                <h2 class="encyclopedia-title text-purple-400 font-jp">👥 Customer Encyclopedia</h2>
                <p id="customer-progress" class="encyclopedia-progress">Met: 0 / 0</p>
            </div>
            <div id="customer-grid" class="encyclopedia-grid">
                <!-- Populated by JS -->
            </div>
        </div>
        <button class="encyclopedia-close font-jp" onclick="closeCustomerEncyclopedia()">Close</button>
    </div>

    <!-- Title List Overlay -->
    <div id="title-overlay" class="encyclopedia-overlay">
        <div class="encyclopedia-content">
            <div class="encyclopedia-header">
                <h2 class="encyclopedia-title text-pink-400 font-jp">🏆 Title List</h2>
                <p id="title-current" class="encyclopedia-progress">Current Title: Apprentice Bartender</p>
            </div>
            <div id="title-grid" class="encyclopedia-grid">
                <!-- Populated by JS -->
            </div>
        </div>
        <button class="encyclopedia-close font-jp" onclick="closeTitleList()">Close</button>
    </div>

    <!-- Market Overlay -->
    <div id="market-overlay">
        <div class="market-content font-jp">
            <div class="market-header">
                <h2 class="market-title">🛒 Ingredient Market</h2>
                <p class="market-money">Money: ¥<span id="market-money">0</span></p>
            </div>
            <div id="market-grid" class="market-grid">
                <!-- Populated by JS -->
            </div>
        </div>
        <button class="encyclopedia-close font-jp" onclick="closeMarket()">Close</button>
    </div>

    <!-- Inquiry Overlay -->
    <div id="inquiry-overlay" class="inquiry-overlay hidden">
        <div class="inquiry-modal font-jp">
            <button class="absolute top-2 right-4 text-2xl text-gray-400" onclick="closeInquiry()">&times;</button>
            <h2>📜 Suggestion Box</h2>
            <div class="inquiry-form-group">
                <label>Type:</label>
                <select id="inquiry-type">
                    <option value="bug">🐛 Bug Report</option>
                    <option value="feature">✨ Feature Request</option>
                    <option value="other">💌 Other Inquiry</option>
                </select>
            </div>
            <div class="inquiry-form-group">
                <label>Message:</label>
                <textarea id="inquiry-message" placeholder="Please describe details here..."></textarea>
            </div>
            <button id="inquiry-submit-btn" class="inquiry-submit-btn" onclick="submitInquiry()">📮 Send</button>
            <p id="inquiry-status" class="mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="detail-modal">
        <div class="detail-content font-jp">
            <img id="detail-image" class="detail-image" src="" alt="">
            <h3 id="detail-name" class="detail-name"></h3>
            <p id="detail-info" class="detail-info"></p>
            <button class="detail-close" onclick="closeDetailModal()">Close</button>
        </div>
    </div>

    <!-- Title Celebration -->
    <div id="title-celebration" class="title-celebration" onclick="closeTitleCelebration()">
        <div class="title-celebration-icon">🏆</div>
        <p class="title-celebration-text font-jp">Title Earned!</p>
        <p id="celebration-title-name" class="title-celebration-name font-jp"></p>
        <p class="text-white/60 font-jp mt-4">Tap to Continue</p>
    </div>

    <!-- Photo Mode Overlay -->
    <div id="photo-mode-overlay" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg max-w-lg w-full text-center relative shadow-2xl border-4 border-amber-500">
            <h2 class="text-2xl font-bold mb-4 font-jp text-gray-800">📸 Photo Taken!</h2>
            <div class="border-2 border-gray-300 mb-4 p-2 bg-gray-100 rounded">
                <canvas id="photo-canvas" class="w-full h-auto rounded shadow-inner"></canvas>
            </div>
            <div class="flex gap-4 justify-center">
                <button onclick="downloadPhoto()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded font-jp flex items-center gap-2">
                    ⬇️ Save
                </button>
                <button onclick="shareToTwitter()"
                    class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded font-jp flex items-center gap-2">
                    🐦 Tweet
                </button>
                <button onclick="closePhotoMode()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded font-jp">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // DEBUG: Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line + "\nCol: " + col);
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Attempt to play Title BGM on load
            const titleBgm = document.getElementById('title-bgm');
            if (titleBgm) {
                // Browsers often block autoplay, so we catch the error.
                // It might require a user click first, which is handled by the "Start" buttons implicitly if it wasn't playing.
                titleBgm.volume = 0.5; // Set reasonable volume
                titleBgm.play().catch(e => console.log('Title BGM autoplay blocked:', e));

                // Ensure it plays on first interaction if blocked
                document.body.addEventListener('click', function playTitleBgmOnce() {
                    if (titleBgm.paused && !document.getElementById('game-overlay').classList.contains('hidden')) {
                        titleBgm.play().catch(e => { });
                    }
                    document.body.removeEventListener('click', playTitleBgmOnce);
                }, { once: true });
            }

            try {
                // --- Language Data ---
                const translations = {
                    en: {
                        dayLabel: "Day", moneyLabel: "Money", salesLabel: "Today's Sales", timeLabel: "Time", orderLabel: "Order:",
                        addIce: "Add Ice", shake: "Shake", stir: "Stir", build: "Build", talk: "Talk", reset: "Reset", cameraMode: "📷 Camera Mode",
                        glassLabel: "Glass:", glassShort: "Short", glassRocks: "Rocks", glassCollins: "Collins", glassCocktail: "Cocktail",
                        dayEndTitle: "Day End", dayEndSubtitle: "Business Closed", dailyEarningsLabel: "Today's Earnings", totalAssetsLabel: "Total Assets",
                        upgradesTitle: "Upgrades", nextDayButton: "Next Day", startButton: "Start Game",
                        purchased: "Purchased", recipe: "Recipe", ice: "Ice", garnishPrompt: "Garnish?",
                        resultSuccess: "Success! 😋", resultFail: "Failure... 😖", resultSecret: "Secret! 🍸",
                        reasonRecipe: " (Recipe)", reasonIce: " (Ice)", reasonGlass: " (Glass)",
                        bossIncoming: "[SPECIAL GUEST]",
                        ingredientsLabel: "Ingredients",
                        // Menu items
                        menuTitle: "📋 Menu",
                        menuCocktails: "🍸 Cocktail Encyclopedia",
                        menuCustomers: "👥 Customer Encyclopedia",
                        menuTitles: "🏆 Titles",
                        menuInterior: "🏠 Interior",
                        menuSettings: "⚙️ Settings",
                        menuClose: "✖ Close",
                        // Interior Shop
                        interiorTitle: "🏠 Interior Customization",
                        interiorMoney: "Money",
                        wallpaperLabel: "🖼️ Wallpaper",
                        lightingLabel: "💡 Lighting",
                        bgmLabel: "🎵 BGM",
                        interiorEquipped: "✓ Equipped",
                        interiorOwned: "Owned",
                        interiorBuy: "Buy",
                        okawari: "Another one!",
                        okawariMsg: "Give me another one of the same!",
                        // Settings
                        settingsTitle: "⚙️ Settings",
                        languageLabel: "🌐 Language / 言語",
                        languageNote: "* Language change takes effect after restart",
                        saveAndRestart: "💾 Save & Restart",
                        // Help
                        helpTitle: "📖 How to Play",
                        helpViewBtn: "📖 View How to Play",
                        helpClose: "✖ Close & Start Game",
                        helpBasicsTitle: "🎮 Basic Rules",
                        helpBasicsText: "Make the cocktails your customers order and earn money!",
                        helpMakingTitle: "🍸 How to Make Cocktails",
                        helpStep1: "Check the customer's order (recipe shown in top right)",
                        helpStep2: "Tap 'Ingredients' button and select the required ingredients",
                        helpStep3: "If the recipe needs ice, tap 'Add Ice' button",
                        helpStep4: "Tap the glass to select the correct glass type",
                        helpStep5: "Tap 'Shake' button to complete the cocktail!",
                        helpCameraTitle: "📷 Camera Mode (Shake with a real glass!)",
                        helpCameraStep1: "Tap the '📷 Camera Mode' button",
                        helpCameraStep2: "Allow camera access",
                        helpCameraStep3: "Hold a real glass and shake in front of the camera 5 times!",
                        helpButtonsTitle: "🔘 Button Guide",
                        helpButtonsText: "<ul><li><strong>Ingredients</strong> - Select cocktail ingredients</li><li><strong>Add Ice</strong> - Add ice to the shaker</li><li><strong>Glass</strong> - Choose the glass type</li><li><strong>Shake</strong> - Complete the cocktail</li><li><strong>Talk</strong> - Chat with customers (Bonus points!)</li><li><strong>Reset</strong> - Start over</li><li><strong>📷 Camera Mode</strong> - Shake with camera</li></ul>",
                        helpTipsTitle: "⭐ Tips",
                        helpTipsText: "<ul><li>Follow the recipe to get <strong>combo bonuses</strong>!</li><li><strong>Talk</strong> to customers for tips</li><li>Buy <strong>upgrades</strong> at the end of each day</li><li>Make as many cocktails as you can for high scores!</li></ul>",
                        helpHint: "<strong>💡 Hint</strong> Tap the '?' button in the top right to see this screen anytime!",
                        helpCloseBtn: "Got it! Back to Game",
                        INGREDIENTS: {
                            vodka: { name: 'Vodka', color: '#e0f7fa', glow: '#80deea' },
                            gin: { name: 'Gin', color: '#e8f5e9', glow: '#a5d6a7' },
                            rum: { name: 'Rum', color: '#ffecb3', glow: '#ffe082' },
                            tequila: { name: 'Tequila', color: '#fff9c4', glow: '#fff59d' },
                            brandy: { name: 'Brandy', color: '#d84315', glow: '#ff5722' },
                            beer: { name: 'Beer', color: '#ffeb3b', glow: '#fff176' },
                            cassis: { name: 'Cassis', color: '#4a148c', glow: '#ce93d8' },
                            lime: { name: 'Lime', color: '#d4e157', glow: '#e6ee9c' }, // Matched JA color
                            lemon: { name: 'Lemon', color: '#ffeb3b', glow: '#fff59d' },
                            orangeJuice: { name: 'Orange J', color: '#ff9800', glow: '#ffb74d' },
                            tomatoJuice: { name: 'Tomato J', color: '#d32f2f', glow: '#e57373' },
                            pineappleJuice: { name: 'Pineapple J', color: '#fdd835', glow: '#fff176' },
                            tonic: { name: 'Tonic', color: '#cfd8dc', glow: '#eceff1' },
                            cola: { name: 'Cola', color: '#3e2723', glow: '#a1887f' },
                            gingerAle: { name: 'Ginger Ale', color: '#fbc02d', glow: '#fff176' },
                            whiskey: { name: 'Whiskey', color: '#d4a017', glow: '#ffca28' },
                            soda: { name: 'Soda', color: '#e0f2f1', glow: '#b2dfdb' },
                            kahlua: { name: 'Kahlua', color: '#3e2723', glow: '#5d4037' },
                            milk: { name: 'Milk', color: '#ffffff', glow: '#f5f5f5' },
                            tripleSec: { name: 'Triple Sec', color: '#ffffff', glow: '#e0f7fa' },
                            grenadine: { name: 'Grenadine', color: '#b71c1c', glow: '#e53935' }
                        },
                        COCKTAILS: [
                            { name: 'Screwdriver', ingredients: ['vodka', 'orangeJuice'], needsIce: true, garnish: 'orange', glass: 'collins', method: 'build' },
                            { name: 'Gin and Tonic', ingredients: ['gin', 'tonic', 'lime'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'build' },
                            { name: 'Cuba Libre', ingredients: ['rum', 'cola', 'lime'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'build' },
                            { name: 'Moscow Mule', ingredients: ['vodka', 'gingerAle', 'lime'], needsIce: true, garnish: 'lime', glass: 'rocks', method: 'build' },
                            { name: 'Cassis Orange', ingredients: ['cassis', 'orangeJuice'], needsIce: true, garnish: 'orange', glass: 'collins', method: 'build' },
                            { name: 'Rum and Coke', ingredients: ['rum', 'cola'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'build' },
                            { name: 'Gin Buck', ingredients: ['gin', 'gingerAle', 'lime'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'build' },
                            { name: 'Highball', ingredients: ['whiskey', 'soda'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'build' },
                            { name: 'Whiskey Coke', ingredients: ['whiskey', 'cola'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'build' },
                            { name: 'Kahlua Milk', ingredients: ['kahlua', 'milk'], needsIce: true, garnish: 'cherry', glass: 'rocks', method: 'stir' },
                            { name: 'Black Russian', ingredients: ['vodka', 'kahlua'], needsIce: true, garnish: 'cherry', glass: 'rocks', method: 'stir' },
                            { name: 'White Russian', ingredients: ['vodka', 'kahlua', 'milk'], needsIce: true, garnish: 'cherry', glass: 'rocks', method: 'stir' },
                            { name: 'Margarita', ingredients: ['tequila', 'tripleSec', 'lime'], needsIce: false, garnish: 'lime', glass: 'cocktail', method: 'shake' },
                            { name: 'Tequila Sunrise', ingredients: ['tequila', 'orangeJuice', 'grenadine'], needsIce: true, garnish: 'orange', glass: 'collins', method: 'build' },
                            { name: 'Sidecar', ingredients: ['brandy', 'tripleSec', 'lime'], needsIce: false, garnish: 'lime', glass: 'cocktail', method: 'shake' }, // Using lime instead of lemon for simplicity unless lemon added
                            { name: 'Red Eye', ingredients: ['beer', 'tomatoJuice'], needsIce: false, garnish: 'lime', glass: 'collins', method: 'stir' },
                            { name: 'Bloody Mary', ingredients: ['vodka', 'tomatoJuice', 'lime'], needsIce: true, garnish: 'lime', glass: 'collins', method: 'stir' },
                            { name: 'Matador', ingredients: ['tequila', 'pineappleJuice', 'lime'], needsIce: false, garnish: 'lime', glass: 'cocktail', method: 'shake' }
                        ],
                        SECRET_COCKTAILS: [
                            { name: 'Gimlet', ingredients: ['gin', 'lime'], needsIce: true, bonus: 500 },
                            { name: 'Cowboy', ingredients: ['whiskey', 'milk'], needsIce: false, bonus: 600 }
                        ],
                        CUSTOMERS: [
                            // --- MORNING ---
                            { time: "morning", name: "Young Farmer", image: 'images/morning/young_farmer_man.png', lookingForPartner: true, worries: { question: "Vegetable prices are dropping lately... what should I do?", choices: [{ text: "Try growing new vegetables?", outcome: "good" }, { text: "Give up and go to the city.", outcome: "bad" }, { text: "It's just the weather.", outcome: "neutral" }] }, quotes: { order: ["Something to energize me before work!"], success: ["Yum! This helps me work harder!"], fail: ["Ugh... my stomach..."], wrongGlass: ["Hmm? Hard to drink from this."], chat: { any: ["Worried about the lack of rain.", "Morning drinks are special!"], morning: ["Up before the chickens.", "Smell the soil?"] } } },
                            { time: "morning", name: "Elderly Farmer", image: 'images/morning/old_farmer_woman.png', quotes: { order: ["Do you have some warm milk?"], success: ["Oh my, delicious."], fail: ["Is this old?"], wrongGlass: ["Oh, this might slip from my hand."], chat: { any: ["My back hurts...", "My grandkids are so cute."], morning: ["Early bird gets the worm.", "Brought fresh veggies."] } } },
                            { time: "morning", name: "Farmer's Daughter", image: 'images/morning/farmer_girl.png', lookingForPartner: true, worries: { question: "I want to go to the city, but dad is against it.", choices: [{ text: "Chase your dreams!", outcome: "good" }, { text: "Family is important.", outcome: "neutral" }, { text: "Run away!", outcome: "bad" }] }, quotes: { order: ["Can I have a sweet juice-like drink?"], success: ["Wow! Like a flower field!"], fail: ["Bitter... yuck!"], wrongGlass: ["Ehh, this glass isn't cute!"], chat: { any: ["I want to open a shop someday.", "Helping dad is hard work."], morning: ["Morning air is so fresh!", "Talked to the birds."] } } },
                            { time: "morning", name: "Village Boy", image: 'images/morning/village_boy.png', quotes: { order: ["Something cool!"], success: ["I feel stronger!"], fail: ["Ugh... tastes like adulthood..."], wrongGlass: ["Hard to hold..."], chat: { any: ["I want to be an adventurer.", "Practiced my sword fighting."], morning: ["Missed breakfast.", "Training day today!"] } } },
                            { time: "morning", name: "Straw Hat Farmer", image: 'images/morning/straw_farmer.png', quotes: { order: ["Thirsty. Gives me something like water."], success: ["Phew, I'm alive again."], fail: ["What's this? Mud water?"], wrongGlass: ["Not the usual cup?"], chat: { any: ["Market day tomorrow.", "Crows are a nuisance."], morning: ["Gonna be hot today.", "Hoes need maintenance."] } } },
                            { time: "morning", name: "Flower Girl", image: 'images/morning/flower_woman.png', quotes: { order: ["Something beautiful like a flower."], success: ["Lovely... smells great too."], fail: ["This is withered."], wrongGlass: ["Oh, the vessel doesn't match the flower."], chat: { any: ["Would you like some flowers?", "This town suits flowers."], morning: ["Dew-covered flowers are best.", "Smells nice today."] } } },
                            { time: "morning", name: "Baker", image: 'images/morning/baker_woman.png', quotes: { order: ["A drink after work, please!"], success: ["Better than fresh bread!"], fail: ["Tastes floury."], wrongGlass: ["Hey, this will spill."], chat: { any: ["Baking is difficult.", "Flour prices are up..."], morning: ["Exhausted from working before dawn.", "Morning prep is done."] } } },

                            // --- NOON ---
                            { time: "noon", name: "Bald Merchant", image: 'images/noon/bald_merchant.png', quotes: { order: ["Golden liquor that smells like profit."], success: ["My money luck is rising!"], fail: ["Tastes cheap."], wrongGlass: ["Good content, cheap vessel."], chat: { any: ["Money is power.", "Had a good deal."], day: ["Lunch deals go well.", "Checked the market rates."] } } },
                            { time: "noon", name: "Freckled Girl", image: 'images/noon/freckle_girl.png', quotes: { order: ["Something refreshing."], success: ["Refreshing and tasty!"], fail: ["Weird taste..."], wrongGlass: ["Huh? Wrong glass?"], chat: { any: ["Bought new clothes.", "Neighbor's dog is cute."], day: ["Went shopping.", "Weather is great!"] } } },
                            { time: "noon", name: "Scholar", image: 'images/noon/scholar_man.png', quotes: { order: ["I desire a drink that stimulates the intellect."], success: ["Hmm, logical taste."], fail: ["Unscientific taste."], wrongGlass: ["Illogical vessel."], chat: { any: ["Want to solve the world's mysteries.", "Looking for old books."], day: ["Coming from the library.", "Afternoon reading is bliss."] } } },
                            { time: "noon", name: "Noble Lady", image: 'images/noon/pink_lady.png', quotes: { order: ["Something elegant befitting me."], success: ["Ohoho, not bad."], fail: ["How vulgar!"], wrongGlass: ["Oh, bad taste in glasses."], chat: { any: ["Looking forward to the ball.", "This dress is custom made."], day: ["Tired of tea parties.", "Sunlight damages the skin."] } } },
                            { time: "noon", name: "Town Girl", image: 'images/noon/town_girl.png', quotes: { order: ["A cute colored cocktail please!"], success: ["Insta-worthy! Awesome!"], fail: ["Not cute and tastes bad..."], wrongGlass: ["This glass isn't photogenic~"], chat: { any: ["That soldier is cool.", "Ate the trendy sweets?"], day: ["Dessert instead of lunch.", "Meeting a friend."] } } },
                            { time: "noon", name: "Merchant's Wife", image: 'images/noon/merchant_wife.png', quotes: { order: ["Secretly from my husband... something strong."], success: ["Oh, I might get drunk."], fail: ["Husband earns better than this."], wrongGlass: ["Oh, no better glass?"], chat: { any: ["My husband works too much.", "Secret savings expanding."], day: ["Afternoon affair... just kidding.", "Just shopping."] } } },
                            { time: "noon", name: "Blacksmith", image: 'images/noon/blacksmith_man.png', quotes: { order: ["Cool down my hot body!"], success: ["Kuu~! That hits the spot!"], fail: ["Lukewarm! Can't hit iron with this!"], wrongGlass: ["Oops, too small for my hands."], chat: { any: ["Iron doesn't lie.", "Good swords from good iron."], day: ["Furnace is too hot.", "Lunch break."] } } },
                            { time: "noon", name: "Bandana Girl", image: 'images/noon/bandana_girl.png', quotes: { order: ["Something to energize me!"], success: ["Energy 100%!"], fail: ["Tension down..."], wrongGlass: ["Hmm, no atmosphere."], chat: { any: ["Gotta finish cleaning.", "Cute bandana, right?"], day: ["Gossip is tiring.", "Good laundry weather!"] } } },
                            { time: "noon", name: "Maid", image: 'images/noon/maid_woman.png', quotes: { order: ["Secretly from master... something sweet."], success: ["Dreamy taste..."], fail: ["Punishment level..."], wrongGlass: ["Ah, different glass than usual..."], chat: { any: ["I broke a plate...", "Master is strict."], day: ["Shopping for the mansion.", "Just a little break."] } } },
                            { time: "noon", name: "Artist", image: 'images/noon/artist_man.png', quotes: { order: ["A color that sparks inspiration."], success: ["I see it! A masterpiece!"], fail: ["Mediocre color..."], wrongGlass: ["Beauty is lost in this glass."], chat: { any: ["Art is not explosion, it's harmony.", "Your face is picturesque."], day: ["Good lighting time.", "Going for a sketch."] } } },
                            { time: "noon", name: "Craftsman", image: 'images/noon/craftsman_man.png', quotes: { order: ["The usual, simple one."], success: ["Good work."], fail: ["No cutting corners."], wrongGlass: ["mph, choosing tools is training too."], chat: { any: ["Craftsman's soul is in details.", "Cherish your tools."], day: ["Pumping up before afternoon work.", "Got good materials."] } } },
                            { time: "noon", name: "Jeweler", image: 'images/noon/jeweler_woman.png', quotes: { order: ["A drink shining like a gem."], success: ["Diamond class brilliance!"], fail: ["Cloudy stone."], wrongGlass: ["Shine is good, setting is bad."], chat: { any: ["Brilliance is eternal.", "Shall I appraise it?"], day: ["Pre-negotiation drink.", "Gold never betrays."] } } },
                            { time: "noon", name: "Pink Hair Girl", image: 'images/noon/pink_town_girl.png', quotes: { order: ["Something fizzy!"], success: ["Popping and fun!"], fail: ["Flat..."], wrongGlass: ["Hmm, something's wrong."], chat: { any: ["Noticed my hair color?", "Collecting ribbons."], day: ["Walking is fun.", "Town is lively."] } } },

                            // --- NIGHT ---
                            { time: "night", name: "Old Sage", image: 'images/night/old_wise_man.png', quotes: { order: ["Liquor that feels like eternity."], success: ["...Splendid. Tastes of history."], fail: ["...Youngster who knows no history."], wrongGlass: ["Content good, vessel bad..."], chat: { any: ["World is vast, young one.", "Stars are ominous..."], night: ["Night is best for thinking.", "Recalling old adventures."] } } },
                            { time: "night", name: "Green Noble", image: 'images/night/green_noble_man.png', quotes: { order: ["A drink full of elegance."], success: ["I want this flavor in my domain."], fail: ["Peasant taste."], wrongGlass: ["We don't use such glasses at home."], chat: { any: ["Peasants' lives are hard.", "Tax rates..."], night: ["Balls are boring.", "Calmer drinking here."] } } },
                            { time: "night", name: "Blonde Noble Lady", image: 'images/night/blonde_noble_woman.png', quotes: { order: ["Like an elixir for beauty."], success: ["My skin looks glowing!"], fail: ["More wrinkles..."], wrongGlass: ["Oh, an ugly glass."], chat: { any: ["Youth is fleeting.", "That man is persistent."], night: ["Moonlight makes skin pretty.", "I'll tell you a secret."] } } },
                            { time: "night", name: "Butler", image: 'images/night/butler_man.png', quotes: { order: ["Checking my master's preference."], success: ["Master will be satisfied."], fail: ["Poor quality."], wrongGlass: ["Lack of consideration in vessel selection."], chat: { any: ["All for my master.", "Be perfect, that is a butler."], night: ["Rest after master sleeps.", "Mansion management is hard."] } } },
                            { time: "night", name: "Dancer", image: 'images/night/dancer_woman.png', quotes: { order: ["Passionate red one!"], success: ["Makes me want to dance!"], fail: ["Rhythm is off."], wrongGlass: ["Glass taste is so-so."], chat: { any: ["Dance is conversation of the soul.", "Legs are tired."], night: ["Tonight's stage was great.", "Love dancing in moonlight."] } } },
                            { time: "night", name: "Traveler", image: 'images/night/traveler_man.png', quotes: { order: ["Heal my travel fatigue."], success: ["Reminds me of home..."], fail: ["Better to sleep outside."], wrongGlass: ["I use better cups camping."], chat: { any: ["How far to next town?", "I like uncharted roads."], night: ["Camping is good, tavern is better.", "Walked by the stars."] } } },
                            { time: "night", name: "Curly Lady", image: 'images/night/curly_lady.png', quotes: { order: ["Sweet and melting."], success: ["Like a prince's kiss!"], fail: ["Child's play."], wrongGlass: ["I'll tell my father!"], chat: { any: ["Came secretly from father.", "Want to grow up fast."], night: ["First time out at night.", "So exciting."] } } },
                            { time: "night", name: "Guard", image: 'images/night/guard_man.png', quotes: { order: ["Drink after patrol!"], success: ["I can protect tomorrow too!"], fail: ["Yuck! Wakes me up!"], wrongGlass: ["Hard to hold!"], chat: { any: ["I protect the town peace.", "Seen any suspicious guys?"], night: ["Night watch is cold.", "Off duty, let me relax."] } } },
                            { time: "night", name: "Bard", image: 'images/night/bard_man.png', quotes: { order: ["Inspire my poetry."], success: ["Magnificent! A poem comes!"], fail: ["Cannot write with this."], wrongGlass: ["Vessel is not poetic."], chat: { any: ["You shall be the hero of my next tale.", "This glass shines like a gem."], night: ["Night silence is a poet's friend.", "Hear the starlight melody?"] } } },
                            { time: "night", name: "Tavern Hostess", image: 'images/night/tavern_lady.png', quotes: { order: ["Show me your skills, colleague!"], success: ["Not bad! I want this at my place!"], fail: ["Start over!"], wrongGlass: ["Choosing vessel is also work!"], chat: { any: ["Customer service needs smiles.", "Splash water on drunks."], night: ["Business is booming?", "Come drink at my place sometime."] } } },
                            { time: "night", name: "Wizard", image: 'images/night/wizard_man.png', quotes: { order: ["Potion to restore mana."], success: ["Magic is filling up...!"], fail: ["Just water?"], wrongGlass: ["Magic dissipates in this vessel."], chat: { any: ["Magic has a price.", "Fire spirits are noisy."], night: ["Magic is strong at night.", "Star alignment is ominous..."] } } },
                            { time: "night", name: "Pink Dancer", image: 'images/night/pink_dancer.png', quotes: { order: ["Sparkly and cute!"], success: ["Good for the stage!"], fail: ["Plain..."], wrongGlass: ["Any cuter ones?"], chat: { any: ["Got a fan letter.", "Watch my new step!"], night: ["After-party!", "Night is young!"] } } },
                            { time: "night", name: "Sailor", image: 'images/night/sailor_man.png', quotes: { order: ["Salty like the sea!"], success: ["Feel the sea breeze!"], fail: ["Like fresh water!"], wrongGlass: ["Spills on a ship!"], chat: { any: ["Sea men don't fit on land.", "Ever seen a Kraken?"], night: ["Dumped by a port girl.", "Moon is beautiful, good sailing."] } } },
                            { time: "night", name: "Mercenary", image: 'images/night/mercenary_man.png', quotes: { order: ["Strong liquor to boil blood."], success: ["Wanna go back to battlefield."], fail: ["Goes flat."], wrongGlass: ["Don't use this on battlefield."], chat: { any: ["Fight anyone for money.", "Never show your back."], night: ["Toast to dead comrades.", "Night wind stings wounds."] } } },
                            { time: "night", name: "Iron Knight", image: 'images/night/knight_helmet.png', quotes: { order: ["Drink to show loyalty to King."], success: ["My life for the King!"], fail: ["Disrespectful!"], wrongGlass: ["No etiquette."], chat: { any: ["Hard to see in helmet.", "Chivalry is..."], night: ["Night watch is knight's duty.", "Must prevent rust."] } } },
                            { time: "night", name: "Soldier", image: 'images/night/chain_soldier.png', quotes: { order: ["Cheap and strong!"], success: ["Whoo! Kicks!"], fail: ["Diluted?"], wrongGlass: ["Don't care details but feels off."], chat: { any: ["Chainmail is heavy.", "Broke before payday."], night: ["Drill tomorrow.", "Just one more cup..."] } } },
                            { time: "night", name: "Captain", image: 'images/night/captain_man.png', quotes: { order: ["Bring the world's best rum!"], success: ["Yo-ho! The best!"], fail: ["Deck scrubbing for you!"], wrongGlass: ["Not fit for Pirate King!"], chat: { any: ["Join my crew?", "I have a treasure map."], night: ["Land night is too quiet.", "Compass brought me here."] } } },
                            { time: "night", name: "Red Knight", image: 'images/night/red_scarf_knight.png', quotes: { order: ["Passionate red one."], success: ["I'm burning up!"], fail: ["Cooled down..."], wrongGlass: ["Justice heart needs better vessel."], chat: { any: ["This scarf is mom's keepsake.", "Fight for justice!"], night: ["Night patrol.", "Evil moves at night."] } } },
                            { time: "night", name: "Fat Noble", image: 'images/night/fat_noble_man.png', quotes: { order: ["I desire the most expensive one."], success: ["Money is no object!"], fail: ["Cheap taste."], wrongGlass: ["Not fitting my hand."], chat: { any: ["Gaining weight...", "Gourmet is my life."], night: ["What for midnight snack?", "Back from a banquet."] } } },
                            { time: "night", name: "Tavern Master", image: 'images/night/red_beard_man.png', quotes: { order: ["Show me your skill."], success: ["Damn, it's good!"], fail: ["Retrain!"], wrongGlass: ["That glass for this cocktail?"], chat: { any: ["Tavern management is hard.", "Customer handling is key."], night: ["Good to be a customer.", "Closed my shop."] } } },
                            { time: "night", name: "Priest", image: 'images/night/priest_man.png', quotes: { order: ["Pure water... no, liquor to thank God."], success: ["Amen... magnificent."], fail: ["Sinful taste."], wrongGlass: ["Not a holy vessel."], chat: { any: ["Lost lamb...", "Donations please."], night: ["Must pray.", "God is watching."] } } },
                            { time: "night", name: "Witch", image: 'images/night/witch_woman.png', quotes: { order: ["Lizard tail inside... just kidding."], success: ["Hehe, good magic power."], fail: ["I'll curse you."], wrongGlass: ["Wrong mixing dish?"], chat: { any: ["Stewing in cauldron is key.", "Seen my cat?"], night: ["Sabbat time.", "Brooms fly well on moonlit nights."] } } },
                            { time: "night", name: "Green Mage", image: 'images/night/green_mage_woman.png', quotes: { order: ["Feel the forest's blessing."], success: ["Forest is happy."], fail: ["Artificial taste."], wrongGlass: ["Not natural shape."], chat: { any: ["Live with nature.", "Ask me about herbs."], night: ["Forest murmer.", "Moon is beautiful."] } } },
                            { time: "night", name: "King", image: 'images/night/king_man.png', quotes: { order: ["Satisfy me."], success: ["National treasure class!"], fail: ["To the dungeon!"], wrongGlass: ["Serving me in this?!"], chat: { any: ["Ruling is tiring.", "Incognito! Keep voice down!"], night: ["Sneaked out of castle.", "Kings must know commoners."] } } },
                            { time: "night", name: "Princess", image: 'images/night/princess_woman.png', quotes: { order: ["Exciting one I can't drink at castle!"], success: ["Taste of the lower world... lovely!"], fail: ["Castle water is better."], wrongGlass: ["Don't use this at castle."], chat: { any: ["Secret from father.", "Long for adventure."], night: ["Broke curfew.", "Where is my glass slipper?"] } } },
                            { time: "night", name: "Red King", image: 'images/night/red_king.png', quotes: { order: ["Fierce liquor for a conqueror!"], success: ["Can conquer the world!"], fail: ["Off with your head!"], wrongGlass: ["Drink in this?!"], chat: { any: ["How to attack neighbor...", "Might is justice."], night: ["Planning night raid.", "No defeat in my dictionary."] } } },
                            { time: "night", name: "Queen", image: 'images/night/queen_woman.png', quotes: { order: ["Elegant and strong."], success: ["Kneel, I'll reward you."], fail: ["Boring taste."], wrongGlass: ["Lacks aesthetic."], chat: { any: ["I control the King.", "Beauty is power."], night: ["Night ball is my stage.", "Foolish commoners..."] } } }
                        ],
                        MILLIONAIRE_CUSTOMER: { name: "Elder Tycoon", image: 'images/night/fat_noble_man.png', quotes: { order: ["Something fit for a King."], success: ["Splendid! Here is gold."], fail: ["Swill for pigs."], chat: ["Merchants rival Kings.", "It is lonely at the top.", "I might buy you a new shop."] } },
                        DEATH_CUSTOMER: { name: "The Witch", image: 'images/night/witch_woman.png', quotes: { order: ["...I need a potion to restore my mana."], success: ["...Hehe, power flows through me."], fail: ["...This is just muddy water."], chat: ["...The deep forest is peaceful.", "...Interested in eternal life?", "...Have you seen my black cat?"] } },
                        UPGRADES: {
                            shaker: { name: 'Mithril Shaker', description: 'Combo bonus increases to 1.2x' },
                            iceMachine: { name: 'Ice Magic Tool', description: 'Slightly improves score for cocktails with ice' },
                            barManual: { name: 'Ancient Recipe Scroll', description: 'Halves the penalty for mistakes' }
                        },
                        STORY: {
                            1: { title: "Day 1: A New Adventure", text: "Finally, my own tavern is open.\nA haven for the weary souls of the kingdom.\nWhere warriors and mages rest their wings." },
                            3: { title: "Day 3: The Royal Gourmet", text: "\"There's an interesting tavern keeper here.\"\nHearing the rumors, the Royal Gourmet\nis visiting tonight.", boss: { name: "Royal Gourmet", image: 'images/night/green_noble_man.png', quotes: { order: ["A Gin Short Cocktail. Fit for a King?"], success: ["...I admit it. Rivals the Royal Chef."], fail: ["Disappointing. I shall not return."], chat: ["Manners matter too.", "I've closed many taverns.", "Show me quality."] }, constraints: { includes: ['gin'], glass: 'cocktail' } } },
                            5: { title: "Day 5: The Captain's Worry", text: "A rainy night.\nA tired Guard Captain seeks answers.\nWill he find them at the bottom of a glass?", boss: { name: "Guard Captain", image: 'images/night/mercenary_man.png', quotes: { order: ["Strong, on the rocks. Clear my head."], success: ["...The fog lifts. I see the beast now."], fail: ["...No use. The mist remains."], chat: ["The darkness is deep...", "You saw nothing. Understood?", "Where were you last night?"] }, constraints: { minAlcohol: 80, glass: 'rocks' } } },
                            7: { title: "Day 7: The Legendary Witch", text: "After a week, your name is known across the land.\nTonight, the legendary \"Great Witch\"\ncomes to test your soul.", boss: { name: "Legendary Witch", image: 'images/night/witch_woman.png', quotes: { order: ["A supreme 5-ingredient potion to boost my magic."], success: ["Magnificent... Tastes like magic."], fail: ["You lack discipline."], chat: ["Mixing cocktails is like alchemy.", "Magic alone is not enough.", "Show me your 'soul'."] }, constraints: { exactCount: 5 } } }
                        }
                    }
                };
                translations.ja = translations.en;

                const UPGRADES_DATA = {
                    shaker: { cost: 2000, purchased: false },
                    iceMachine: { cost: 1500, purchased: false },
                    barManual: { cost: 3000, purchased: false }
                };

                const GARNISHES = { lime: '🍋', orange: '🍊', cherry: '🍒' };

                // SVG Paths for Glass Types
                // Cocktail: V-shape with stem
                const PATH_COCKTAIL_GLASS = "M 10 10 L 50 70 L 90 10 Z";
                const PATH_COCKTAIL_STEM = "M 50 70 L 50 110 M 30 115 L 70 115";

                // Collins: Tall straight
                const PATH_COLLINS = "M 20 10 L 25 115 L 75 115 L 80 10";

                // Rocks: Short wide
                const PATH_ROCKS = "M 15 40 L 20 115 L 80 115 L 85 40";

                // --- DOM Elements ---
                const dom = {};

                // --- Ingredient Prices ---
                const INGREDIENT_PRICES = {
                    vodka: 300, gin: 350, rum: 300, tequila: 400, brandy: 500,
                    beer: 150, cassis: 250, lime: 50, orangeJuice: 80, tomatoJuice: 100,
                    pineappleJuice: 120, tonic: 60, cola: 50, gingerAle: 60,
                    whiskey: 450, soda: 40, kahlua: 350, milk: 40, tripleSec: 300, grenadine: 150
                };

                // --- Starter Ingredients ---
                const STARTER_INGREDIENTS = ['vodka', 'rum', 'cola', 'orangeJuice', 'cassis', 'kahlua', 'grenadine', 'tomatoJuice', 'beer'];

                // --- Title Definitions ---
                const TITLES = [
                    { id: 'beginner', name: 'Apprentice Bartender', nameEn: 'Apprentice Bartender', icon: '🌱', condition: () => true },
                    { id: 'mixologist', name: 'Mixologist', nameEn: 'Mixologist', icon: '🍸', condition: () => state.discoveredCocktails.length >= 10 },
                    { id: 'socialite', name: 'Socialite', nameEn: 'Socialite', icon: '💬', condition: () => state.totalTalks >= 20 },
                    { id: 'wealthy', name: 'Wealthy', nameEn: 'Wealthy', icon: '💰', condition: () => state.totalMoney >= 50000 },
                    { id: 'collector', name: 'Collector', nameEn: 'Collector', icon: '📚', condition: () => state.metCustomers.length >= 30 },
                    { id: 'master', name: 'Legendary Bartender', nameEn: 'Legendary Bartender', icon: '👑', condition: () => state.discoveredCocktails.length >= (translations.en.COCKTAILS ? translations.en.COCKTAILS.length : 18) }
                ];

                // --- Interior Customization Items ---
                const INTERIOR_ITEMS = {
                    wallpaper: [
                        { id: 'classic', name: 'Classic', nameEn: 'Classic', price: 0, description: 'Calm wood grain', descEn: 'Calm wood grain', customerBonus: [] },
                        { id: 'modern', name: 'Modern', nameEn: 'Modern', price: 5000, description: 'Urban white walls', descEn: 'Urban white walls', customerBonus: ['noble', 'merchant'] },
                        { id: 'fantasy', name: 'Fantasy', nameEn: 'Fantasy', price: 8000, description: 'Magical purple walls', descEn: 'Magical purple walls', customerBonus: ['wizard', 'witch'] }
                    ],
                    lighting: [
                        { id: 'warm', name: 'Warm', nameEn: 'Warm', price: 0, description: 'Warm lighting', descEn: 'Warm lighting', customerBonus: [] },
                        { id: 'cool', name: 'Cool', nameEn: 'Cool', price: 3000, description: 'Refined cool light', descEn: 'Refined cool light', customerBonus: ['knight', 'guard'] },
                        { id: 'neon', name: 'Neon', nameEn: 'Neon', price: 6000, description: 'Colorful party lights', descEn: 'Colorful party lights', customerBonus: ['dancer', 'bard'] }
                    ],
                    bgm: [
                        { id: 'standard_jazz', name: 'Jazz', nameEn: 'Jazz', price: 0, description: 'Standard Jazz', descEn: 'Standard Jazz', customerBonus: [] },
                        { id: 'medieval', name: 'Medieval', nameEn: 'Medieval', price: 4000, description: 'Lute melodies', descEn: 'Lute melodies', customerBonus: ['knight', 'princess'] },
                        { id: 'tavern', name: 'Tavern', nameEn: 'Tavern', price: 4000, description: 'Lively tavern music', descEn: 'Lively tavern music', customerBonus: ['sailor', 'mercenary'] }
                    ]
                };

                // --- Game State ---
                let state = {
                    score: 0, timeLeft: 300, timerInterval: null,
                    isTutorial: false, tutorialStep: 0,
                    shakerContents: [], shakerHasIce: false, isGameRunning: false,
                    shakerContents: [], shakerHasIce: false, isGameRunning: false,
                    canInteract: true, combo: 0, isHappyHour: false,
                    happyHourTimeout: null, garnishTimeout: null,
                    day: 1, totalMoney: 0,
                    upgrades: JSON.parse(JSON.stringify(UPGRADES_DATA)),
                    currentCustomer: null, currentOrder: null,
                    language: 'en',
                    isBossActive: false,
                    hasTalked: false,
                    selectedGlass: null,
                    discoveredSecrets: [],
                    timeOfDay: 'morning',
                    ownedIngredients: [...STARTER_INGREDIENTS],
                    discoveredCocktails: [],
                    metCustomers: [],
                    currentTitle: 'beginner',
                    unlockedTitles: ['beginner'],
                    totalTalks: 0,
                    currentWeather: 'sunny',
                    currentEvent: null,
                    customerDrunkLevel: 0,
                    settings: {
                        volume: { bgm: 30, se: 100 },
                        performanceMode: false
                    },
                    interior: {
                        wallpaper: 'classic',
                        lighting: 'warm',
                        bgm: 'skyline_serenity'
                    },
                    ownedInterior: {
                        wallpaper: ['classic'],
                        lighting: ['warm'],
                        bgm: ['skyline_serenity']
                    },
                    isMysteryMode: false,
                    currentSaveSlot: 1,
                    avatar: 'images/night/bartender_man.png',
                    timer: 300
                };


                // --- Sound Engine ---
                let sounds = {};
                let isAudioReady = false;
                function setupSounds() { try { sounds = { pour: new Tone.Synth({ oscillator: { type: 'fmsine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.2 } }).toDestination(), shake: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.1 } }).toDestination(), ice: new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.001, decay: 0.1, release: 0.01 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(), success: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(), fail: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.2 } }).toDestination(), tip: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.2, release: 0.3 } }).toDestination(), combo: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fmsquare' }, envelope: { attack: 0.01, decay: 0.1, release: 0.1 } }).toDestination(), happyHour: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'pulse' }, envelope: { attack: 0.01, decay: 0.5, release: 0.2 } }).toDestination(), cash: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, release: 0.1 } }).toDestination() }; isAudioReady = true; } catch (e) { console.error("Sound engine failed to initialize:", e); } }
                async function startAudio() {
                    if (isAudioReady && Tone.context.state !== 'running') { await Tone.start(); }

                    const savedSettings = localStorage.getItem('bartenderSettings');
                    let bgmVol = 0.3;
                    if (savedSettings) {
                        try {
                            const s = JSON.parse(savedSettings);
                            if (s.volume && s.volume.bgm !== undefined) {
                                bgmVol = (s.volume.bgm / 100) * 0.3; // Scale to max 0.3
                            }
                        } catch (e) { }
                    }

                    if (dom.bgmAudioEl) {
                        dom.bgmAudioEl.volume = bgmVol;
                        dom.bgmAudioEl.play().catch(e => { });
                    }
                }
                function stopAudio() { if (dom.bgmAudioEl) { dom.bgmAudioEl.pause(); dom.bgmAudioEl.currentTime = 0; } }
                function playSound(sound, ...args) {
                    if (!isAudioReady) return;

                    // SE Volume Check
                    const seVol = (state.settings && state.settings.volume) ? state.settings.volume.se / 100 : 1.0;
                    if (seVol <= 0) return;

                    const db = seVol > 0 ? 20 * Math.log10(seVol) : -Infinity;
                    try { Tone.Destination.volume.value = db; } catch (e) { }

                    try { if (sound === 'success') sounds.success.triggerAttackRelease(['C4', 'E4', 'G4'], '8n'); else if (sound === 'fail') sounds.fail.triggerAttackRelease(['C3', 'C#3'], '4n'); else if (sound === 'ice') sounds.ice.triggerAttackRelease('C3', '8n', Tone.now() + 0.05); else if (sound === 'tip') sounds.tip.triggerAttackRelease(['C5', 'E5', 'G5', 'C6'], '4n'); else if (sound === 'happyHour') sounds.happyHour.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '2n'); else if (sound === 'cash') sounds.cash.triggerAttackRelease(['E5', 'G5', 'C6'], '8n'); else if (sound === 'combo' && sounds.combo) { const notes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5']; sounds.combo.triggerAttackRelease(notes[Math.min(state.combo - 1, notes.length - 1)], '8n'); } else if (sounds[sound]) sounds[sound].triggerAttackRelease(...args); } catch (e) { }
                }

                // --- Language & View Management ---
                // --- Language & View Management ---
                function setLanguage(lang) {
                    state.language = lang;
                    document.documentElement.lang = lang;
                    localStorage.setItem('bartenderLang', lang);

                    // Update all static text
                    document.querySelectorAll('[data-lang-key]').forEach(el => {
                        const key = el.dataset.langKey;
                        if (translations[lang] && translations[lang][key]) {
                            el.innerHTML = translations[lang][key];
                        }
                    });

                    // Update dynamic content
                    generateIngredients();
                    renderUpgrades();
                    document.title = lang === 'ja' ? 'バーテンダーゲーム' : 'Bartender Game';

                    // Update Order Text if game running
                    if (state.isGameRunning && state.currentOrder) {
                        const currentLangData = translations[state.language];
                        const cocktailData = currentLangData.COCKTAILS.find(c => c.ingredients.join(',') === state.currentOrder.ingredients.join(','));
                        if (cocktailData) {
                            dom.orderTextEl.textContent = cocktailData.name;
                        }
                        updateRecipeDisplay();
                    }
                }

                function showView(view) {
                    dom.gameContainerEl.style.display = 'none';
                    dom.roomContainerEl.style.display = 'none';
                    if (view === 'game') {
                        dom.gameContainerEl.style.display = 'flex';
                    } else if (view === 'room') {
                        dom.roomContainerEl.style.display = 'flex';
                    }
                }

                // Get time of day based on real world time
                function getRealTimeOfDay() {
                    const hour = new Date().getHours();
                    if (hour >= 6 && hour < 12) return 'morning';
                    if (hour >= 12 && hour < 18) return 'noon';
                    return 'night';
                }

                function startDay() {
                    const realTimeOfDay = getRealTimeOfDay();
                    Object.assign(state, { score: 0, timer: 300, isGameRunning: false, canInteract: false, combo: 0, isHappyHour: false, currentCustomer: null, currentOrder: null, isBossActive: false, hasTalked: false, timeOfDay: realTimeOfDay });
                    dom.gameContainerEl.classList.remove('boss-mode');

                    showView('game');
                    dom.gameOverlayEl.style.opacity = '0';
                    dom.gameOverlayEl.style.pointerEvents = 'none';

                    // === NEW: Show menu button and update title display ===
                    showMenuButton();
                    updateTitleDisplay();

                    // Initial BGM setup
                    if (state.interior.bgm) {
                        applyBGM(state.interior.bgm);
                    }

                    // === PHASE 2: Weather, Events, Reset Drunk ===
                    setRandomWeather(); // Now async but we don't await strictly
                    // checkMysteryTime(); // Disabled per user request (was causing red screen at 3 AM)
                    checkSeasonalEvent();
                    resetDrunkLevel();

                    updateEnvironmentVisuals(); // Initial visual update

                    const currentLangData = translations[state.language];
                    const storyEvent = currentLangData.STORY && currentLangData.STORY[state.day];

                    if (storyEvent) {
                        showStoryOverlay(storyEvent, () => {
                            initGameLoop();
                        });
                    } else {
                        initGameLoop();
                    }
                }

                function updateTimer() {
                    if (!state.isGameRunning || state.bossEncounterActive) return; // Only update timer if game is running and not in boss encounter
                    if (state.timer > 0) {
                        state.timer--;
                        dom.timerEl.textContent = state.timer;

                        // Real-time based visuals - timeOfDay is set at startDay based on real time
                        // No in-game time progression needed
                    } else {
                        endDay();
                    }
                }

                // --- Time Logic ---
                function updateEnvironmentVisuals() {
                    const windowEl = document.getElementById('bg-window');
                    // Remove all time classes (including old ones if any)
                    windowEl.classList.remove('time-morning', 'time-day', 'time-evening', 'time-night', 'time-midnight');

                    // Map game time to CSS classes
                    let cssClass = 'time-morning';
                    if (state.timeOfDay === 'noon') cssClass = 'time-day'; // Use time-day for noon
                    if (state.timeOfDay === 'night') cssClass = 'time-night';

                    windowEl.classList.add(cssClass);
                }

                function showStoryOverlay(eventData, callback) {
                    const overlay = document.getElementById('story-overlay');
                    const title = document.getElementById('story-title');
                    const text = document.getElementById('story-text');
                    const cont = document.querySelector('.story-continue');

                    title.textContent = eventData.title;
                    text.innerText = eventData.text;

                    overlay.classList.add('active');

                    const clickHandler = () => {
                        overlay.classList.remove('active');
                        cont.removeEventListener('click', clickHandler);
                        setTimeout(callback, 1000);
                    };
                    cont.addEventListener('click', clickHandler);
                }

                function initGameLoop() {
                    state.isGameRunning = true;
                    updateScore();
                    resetShaker();
                    updateComboDisplay();
                    updateUIDisplays();
                    generateOrder();
                    state.timerInterval = setInterval(updateTimer, 1000);
                    scheduleHappyHour();
                    startAudio();
                    updateEnvironmentVisuals(); // Initial call for environment
                }

                function endDay() {
                    state.isGameRunning = false;
                    clearInterval(state.timerInterval);
                    clearTimeout(state.happyHourTimeout);
                    clearTimeout(state.garnishTimeout);
                    stopAudio();
                    if (dom.bgmAudioEl) dom.bgmAudioEl.playbackRate = 1.0;

                    state.totalMoney += state.score;

                    // === NEW: Increment day and Save progress ===
                    state.day++;
                    showFloatingText("Autosaving...", '#4ade80', dom.gameContainerEl);
                    saveGameData();

                    checkTitles();
                    // hideMenuButton(); // Keep menu button visible for Day End screen as per request

                    if (dom.timerDisplayEl) dom.timerDisplayEl.classList.remove('timer-danger');

                    if (state.day >= 7) {
                        showEndingScreen();
                    } else {
                        showView('room');
                        updateRoomUI();
                    }
                }

                function showEndingScreen() {
                    const overlay = document.getElementById('ending-overlay');
                    const rankEl = document.getElementById('ending-rank');
                    const moneyEl = document.getElementById('ending-money');
                    const msgEl = document.getElementById('ending-message');

                    document.getElementById('game-container').classList.add('hidden'); // Hide game
                    document.getElementById('room-container').classList.add('hidden');

                    let rank = "C";
                    let title = "Apprentice Bartender";
                    let msg = "";

                    if (state.totalMoney >= 50000) {
                        rank = "S"; title = "Legendary Bartender";
                        msg = "Your name has become a legend, a goal for bartenders worldwide.";
                    } else if (state.totalMoney >= 30000) {
                        rank = "A"; title = "Master Bartender";
                        msg = "With great skill and service, your bar is loved by many.";
                    } else if (state.totalMoney >= 10000) {
                        rank = "B"; title = "Professional Bartender";
                        msg = "You continue stable operations. You fit right into this city.";
                    } else {
                        title = "Novice Bartender";
                        msg = "Still need more training. Let's try again tomorrow.";
                    }

                    rankEl.textContent = `Rank ${rank}: ${title}`;
                    moneyEl.textContent = state.totalMoney.toLocaleString();
                    msgEl.textContent = msg;

                    overlay.classList.remove('hidden');
                    playSound('success');
                }

                function updateRoomUI() {
                    dom.roomDayDisplayEl.textContent = state.day;
                    dom.dailyEarningsDisplayEl.textContent = state.score.toLocaleString();
                    dom.roomMoneyDisplayEl.textContent = state.totalMoney.toLocaleString();
                    renderUpgrades();
                }

                function startNextDay() {
                    startDay();
                }

                // Removed duplicate renderUpgrades and buyUpgrade functions

                // --- Game Logic ---
                // updateTimer function moved above showStoryOverlay

                function startBossEncounter(bossData) {
                    clearInterval(state.timerInterval);
                    state.bossEncounterActive = true; // Set boss encounter active
                    state.isBossActive = true; // Keep for general boss state
                    dom.gameContainerEl.classList.add('boss-mode');
                    if (dom.bgmAudioEl) dom.bgmAudioEl.playbackRate = 0.7; // Slow down music
                    showFloatingText(translations[state.language].bossIncoming, '#dc2626', dom.gameContainerEl);
                    playSound('fail');

                    // Wait for current customer to finish or force clear (if idle)
                    // For simplicity, we just force generate after a delay
                    setTimeout(() => {
                        generateOrder(bossData); // Pass bossData to generateOrder
                    }, 2000);
                }
                // Removed obsolete populateShelf and addIngredient functions
                function addIce() {
                    if (!state.isGameRunning || !state.canInteract || state.shakerHasIce) return;
                    if (!checkTutorialStep('ice')) return;
                    state.shakerHasIce = true; updateShakerVisual(); playSound('ice');
                }
                function talk() {
                    if (!state.isGameRunning || !state.canInteract || !state.currentCustomer || state.hasTalked) return;
                    state.hasTalked = true;
                    if (dom.talkButtonEl) dom.talkButtonEl.classList.add('opacity-50', 'cursor-not-allowed');

                    // Check for serious counseling opportunity (30% chance or specific customer trait)
                    if (state.currentCustomer.worries && (Math.random() < 0.3 || state.currentCustomer.alwaysWorry)) {
                        startCounseling();
                        return;
                    }

                    // Normal Talk
                    // Time-based Chat Logic
                    let chats = [];
                    const rawChat = state.currentCustomer.quotes.chat;

                    if (Array.isArray(rawChat)) {
                        chats = rawChat;
                    } else if (typeof rawChat === 'object') {
                        const phase = state.timeOfDay;
                        if (rawChat.any) chats = chats.concat(rawChat.any);
                        if (rawChat[phase]) chats = chats.concat(rawChat[phase]);
                        if (chats.length === 0) chats = ["..."];
                    } else {
                        chats = ["..."];
                    }

                    showDialogue(chats);

                    // Bonus for talking
                    let points = 50 * (state.isHappyHour ? 2 : 1);
                    state.score += points;
                    updateScore();
                    showFloatingText(`+¥${points} (Talk)`, "#60a5fa", dom.customerEl.parentElement);
                    playSound('pop', '8n');

                    // Record talk
                    recordTalk();

                    // Check Matchmaking
                    if (state.currentCustomer.lookingForPartner && !state.hasMatchmade) {
                        const btn = document.getElementById('matchmake-button');
                        if (btn) btn.classList.remove('hidden');
                    }
                }

                // === COUNSELING MODE ===
                function startCounseling() {
                    const worryData = state.currentCustomer.worries;
                    if (!worryData) return;

                    const overlay = document.getElementById('counseling-overlay');
                    const img = document.getElementById('counseling-customer-img');
                    const question = document.getElementById('counseling-question');
                    const choicesDiv = document.getElementById('counseling-choices');

                    if (img) img.src = state.currentCustomer.image;
                    if (question) question.textContent = `「${worryData.question}」`;

                    if (choicesDiv) {
                        choicesDiv.innerHTML = '';
                        worryData.choices.forEach(choice => {
                            const btn = document.createElement('button');
                            btn.className = "w-full bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg font-jp text-left border border-slate-500 hover:border-pink-400 transition-colors";
                            btn.textContent = choice.text;
                            btn.onclick = () => resolveCounseling(choice);
                            choicesDiv.appendChild(btn);
                        });
                    }

                    if (overlay) overlay.classList.remove('hidden');
                }

                function resolveCounseling(choice) {
                    document.getElementById('counseling-overlay').classList.add('hidden');
                    const outcome = choice.outcome; // 'good', 'bad', 'neutral'

                    let points = 0;
                    let color = '#fff';
                    let response = "";

                    if (outcome === 'good') {
                        points = 150;
                        color = '#f472b6'; // pink
                        response = "ありがとう！心が軽くなったよ！";
                        playSound('success');
                        createHearts(dom.customerEl);
                    } else if (outcome === 'bad') {
                        points = -20;
                        color = '#94a3b8';
                        response = "そうかなぁ…余計に落ち込んできた。";
                        playSound('fail');
                    } else {
                        points = 50;
                        color = '#60a5fa';
                        response = "なるほど、一理あるね。";
                        playSound('pop');
                    }

                    if (state.isHappyHour) points *= 2;
                    state.score += points;
                    updateScore();
                    showFloatingText(`${points > 0 ? '+' : ''}${points}`, color, dom.scoreDisplayEl);
                    showDialogue([response]);

                    // Check Matchmaking opportunity even after counseling
                    if (state.currentCustomer.lookingForPartner && !state.hasMatchmade) {
                        const btn = document.getElementById('matchmake-button');
                        if (btn) btn.classList.remove('hidden');
                    }
                }

                function createHearts(targetEl) {
                    if (!targetEl) return;
                    for (let i = 0; i < 8; i++) {
                        const heart = document.createElement('div');
                        heart.textContent = '💖';
                        heart.style.position = 'absolute';
                        const rect = targetEl.getBoundingClientRect();
                        // Position relative to parent container usually, but let's try fixed or simple offset
                        // Simpler: append to parent of customerEl
                        heart.style.left = (targetEl.offsetLeft + targetEl.offsetWidth / 2) + 'px';
                        heart.style.top = (targetEl.offsetTop + targetEl.offsetHeight / 2) + 'px';
                        heart.style.fontSize = '24px';
                        heart.style.pointerEvents = 'none';
                        heart.style.zIndex = '100';
                        heart.animate([
                            { transform: 'translate(0,0) scale(0)', opacity: 1 },
                            { transform: `translate(${Math.random() * 100 - 50}px, -100px) scale(1.5)`, opacity: 0 }
                        ], {
                            duration: 1000 + Math.random() * 500,
                            easing: 'ease-out'
                        });
                        targetEl.parentElement.appendChild(heart);
                        setTimeout(() => heart.remove(), 1500);
                    }
                }

                // === MATCHMAKING SYSTEM ===
                function openMatchmaking() {
                    if (!state.isGameRunning || !state.canInteract) return;
                    const overlay = document.getElementById('matchmaking-overlay');
                    const list = document.getElementById('matchmaking-list');
                    if (!list) return;

                    list.innerHTML = '';

                    // Filter valid candidates (met customers excluding current one and special chars)
                    const candidates = state.metCustomers.filter(name =>
                        name !== state.currentCustomer.name &&
                        !['???', 'Death', 'Millionaire', 'Boss'].some(x => name.includes(x))
                    );

                    if (candidates.length === 0) {
                        list.innerHTML = '<div class="text-white font-jp text-center p-4">まだ紹介できる人がいないようだ…</div>';
                    } else {
                        candidates.forEach(name => {
                            // Find image URL from CUSTOMERS data
                            const langData = translations[state.language];
                            const customerData = [...langData.CUSTOMERS].find(c => c.name === name);
                            const img = customerData ? customerData.image : 'images/icon.png'; // Fallback

                            const btn = document.createElement('div');
                            btn.className = "flex items-center gap-3 bg-slate-800 p-2 rounded cursor-pointer hover:bg-slate-700 border border-slate-600 shrink-0";
                            btn.innerHTML = `
                                <img src="${img}" class="w-10 h-10 rounded-full bg-slate-900 object-cover">
                                <span class="text-white font-jp font-bold">${name}</span>
                             `;
                            btn.onclick = () => resolveMatchmaking(name);
                            list.appendChild(btn);
                        });
                    }

                    if (overlay) overlay.classList.remove('hidden');
                }

                function closeMatchmaking() {
                    const overlay = document.getElementById('matchmaking-overlay');
                    if (overlay) overlay.classList.add('hidden');
                }

                function resolveMatchmaking(partnerName) {
                    closeMatchmaking();
                    state.hasMatchmade = true;
                    const btn = document.getElementById('matchmake-button');
                    if (btn) btn.classList.add('hidden');

                    // Compatibility Logic (Simple Mockup)
                    // In future, use compatibility tags. For now, 50% chance.
                    const isSuccess = Math.random() > 0.5;

                    if (isSuccess) {
                        showDialogue([`えっ、${partnerName}さん？ 気になってたんだ！紹介して！`]);
                        createHearts(dom.customerEl);
                        state.score += 300;
                        updateScore();
                        showFloatingText("+300 Match!", "#ec4899", dom.scoreDisplayEl);
                        playSound('success');
                    } else {
                        showDialogue([`うーん、${partnerName}さんはちょっとタイプじゃないかな…`]);
                        state.score += 50;
                        updateScore();
                        showFloatingText("+50", "#94a3b8", dom.scoreDisplayEl);
                    }
                }

                window.openMatchmaking = openMatchmaking;
                window.closeMatchmaking = closeMatchmaking;
                window.startCounseling = startCounseling;
                window.resolveCounseling = resolveCounseling;
                window.resolveMatchmaking = resolveMatchmaking;
                // Removed unused shake function

                function resetShaker() {
                    state.shakerContents = [];
                    state.shakerHasIce = false;
                    updateShakerVisual();
                    if (typeof generateIngredients === 'function') generateIngredients();
                    dom.finalCocktailEl.classList.remove('animate-fill');
                    dom.finalCocktailEl.style.height = '0%';
                    dom.resultTextEl.textContent = '';
                }

                function updateGlassVisuals(type) {
                    let pathD = '';
                    if (type === 'collins') pathD = PATH_COLLINS;
                    else if (type === 'rocks') pathD = PATH_ROCKS;
                    else if (type === 'cocktail') pathD = PATH_COCKTAIL_GLASS + " " + PATH_COCKTAIL_STEM;
                    else pathD = PATH_COLLINS;

                    const svg = dom.cocktailGlassEl.querySelector('svg');
                    if (svg) {
                        svg.innerHTML = `<path d="${pathD}" fill="none" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px rgba(255,255,255,0.5))" />`;
                    }

                    // Adjust glass visuals container if needed (width/height are managed by CSS classes or existing style)
                }

                function updateShakerVisual() { const liquidHeight = (state.shakerContents.length / 5) * 100; const currentIngredients = translations[state.language].INGREDIENTS; const mixedColor = state.shakerContents.length > 0 ? '#' + state.shakerContents.reduce((avg, key) => { let c = currentIngredients[key].color.substring(1); avg[0] += parseInt(c.substring(0, 2), 16); avg[1] += parseInt(c.substring(2, 4), 16); avg[2] += parseInt(c.substring(4, 6), 16); return avg; }, [0, 0, 0]).map(c => Math.round(c / state.shakerContents.length).toString(16).padStart(2, '0')).join('') : 'transparent'; dom.shakerContentsEl.style.background = `linear-gradient(to top, ${mixedColor} 0%, ${mixedColor} ${liquidHeight}%, transparent ${liquidHeight}%)`; dom.shakerIceCubesEl.innerHTML = ''; if (state.shakerHasIce) { for (let i = 0; i < 5; i++) { const ice = document.createElement('div'); ice.className = 'ice-cube'; ice.style.cssText = `width:${Math.random() * 10 + 15}px; height:${Math.random() * 10 + 15}px; left:${Math.random() * 70}%; bottom:${Math.random() * (liquidHeight > 20 ? liquidHeight - 20 : 0)}%; transform:rotate(${Math.random() * 90}deg);`; dom.shakerIceCubesEl.appendChild(ice); } } }
                function showFloatingText(text, color, element) { const el = document.createElement('div'); el.className = 'floating-text'; el.textContent = text; el.style.color = color; element.appendChild(el); setTimeout(() => el.remove(), 1500); }
                function showDialogue(lines) {
                    if (typeof lines === 'string') {
                        dom.customerDialogueEl.textContent = lines;
                    } else if (Array.isArray(lines)) {
                        dom.customerDialogueEl.textContent = lines[Math.floor(Math.random() * lines.length)];
                    }
                    dom.customerDialogueEl.classList.add('show');
                }
                function updateScore() { if (state.score < 0) state.score = 0; dom.scoreEl.textContent = state.score.toLocaleString(); }
                function updateUIDisplays() { dom.dayDisplayEl.textContent = state.day; dom.moneyDisplayEl.textContent = state.totalMoney.toLocaleString(); }

                function renderUpgrades() {
                    dom.upgradesSectionEl.innerHTML = '';
                    const currentLangData = translations[state.language];
                    dom.upgradesSectionEl.innerHTML = `<h2 class="font-jp text-2xl font-bold text-center mb-4">${currentLangData.upgradesTitle}</h2>`;
                    const list = document.createElement('div');
                    list.className = 'space-y-3';

                    Object.keys(currentLangData.UPGRADES).forEach(key => {
                        const data = state.upgrades[key];
                        const info = currentLangData.UPGRADES[key];

                        const div = document.createElement('div');
                        div.className = 'bg-gray-800 p-4 rounded flex justify-between items-center';

                        let btnText = `¥${data.cost}`;
                        let btnClass = 'bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded font-jp';
                        let disabled = false;

                        if (!data.consumable && data.purchased) {
                            btnText = currentLangData.purchased;
                            btnClass = 'bg-gray-600 text-gray-400 cursor-not-allowed py-2 px-4 rounded font-jp';
                            disabled = true;
                        } else if (state.totalMoney < data.cost) {
                            btnClass = 'bg-gray-600 text-gray-400 cursor-not-allowed py-2 px-4 rounded font-jp';
                            disabled = true;
                        }

                        div.innerHTML = `
                        <div>
                            <h3 class="font-bold text-lg font-jp text-yellow-300">${info.name}</h3>
                            <p class="text-sm text-gray-300 font-jp">${info.description}</p>
                        </div>
                        <button class="${btnClass}" ${disabled ? 'disabled' : ''} onclick="buyUpgrade('${key}')">${btnText}</button>
                    `;
                        list.appendChild(div);
                    });
                    dom.upgradesSectionEl.appendChild(list);
                }

                window.buyUpgrade = function (key) {
                    const upgrade = state.upgrades[key];
                    if (state.totalMoney >= upgrade.cost) {
                        if (!upgrade.consumable && upgrade.purchased) return;
                        state.totalMoney -= upgrade.cost;
                        if (!upgrade.consumable) {
                            upgrade.purchased = true;
                        }
                        playSound('cash');
                        updateRoomUI(); // Use updateRoomUI instead of updateUIDisplays to refresh room money
                        renderUpgrades();
                    }
                };

                function updateComboDisplay() { if (state.combo > 1) { dom.comboDisplayEl.textContent = `${state.combo} COMBO!`; dom.comboDisplayEl.style.opacity = '1'; dom.comboDisplayEl.style.transform = 'translateX(-50%) scale(1)'; } else { dom.comboDisplayEl.style.opacity = '0'; dom.comboDisplayEl.style.transform = 'translateX(-50%) scale(0.5)'; } }
                function scheduleHappyHour() { const delay = Math.random() * 20000 + 15000; state.happyHourTimeout = setTimeout(startHappyHour, delay); }
                function startHappyHour() { if (!state.isGameRunning) return; state.isHappyHour = true; dom.happyHourBannerEl.classList.remove('hidden'); playSound('happyHour'); }

                function generateOrder(forcedCustomer = null, isOkawari = false) {
                    state.canInteract = false;
                    if (state.currentCustomer && !isOkawari) {
                        dom.customerEl.classList.remove('slide-in', 'angry');
                        dom.customerEl.classList.add('slide-out');
                        dom.orderBubbleEl.style.opacity = '0';
                        dom.customerDialogueEl.classList.remove('show');
                        if (dom.dialogueEl) dom.dialogueEl.classList.add('opacity-0');
                    }

                    const delay = isOkawari ? 0 : 800;
                    setTimeout(() => {
                        state.hasTalked = false; // Reset talk status for new customer
                        if (dom.talkButtonEl) dom.talkButtonEl.classList.remove('opacity-50', 'cursor-not-allowed'); // Reset button visual
                        if (!state.isGameRunning && !state.bossEncounterActive) return; // Check bossEncounterActive instead of isBossActive

                        const currentLangData = translations[state.language];

                        // Boss Encounter Override
                        const dayStory = currentLangData.STORY[state.day];
                        if (dayStory && dayStory.boss && !state.bossDefeated && !state.bossEncounterActive) {
                            // Boss appears if time is low (e.g., last 15 seconds) or if forced
                            if (state.timer <= 15 || forcedCustomer) { // Trigger boss if time is low or explicitly forced
                                startBossEncounter(dayStory.boss);
                                return; // Stop normal customer generation
                            }
                        }

                        // --- Time-based Customer Selection ---
                        let potentialCustomers = currentLangData.CUSTOMERS.filter(c => c.time === state.timeOfDay);

                        // Fallback
                        if (potentialCustomers.length === 0) potentialCustomers = currentLangData.CUSTOMERS;

                        // Special Customers Chance
                        if (forcedCustomer) { // If a boss is forced or Okawari
                            state.currentCustomer = forcedCustomer;
                            if (!isOkawari) {
                                state.bossEncounterActive = true; // Ensure boss mode is active ONLY if not okawari
                            }
                        } else if (Math.random() < 0.10 && state.timeOfDay === 'night') { // Millionaire (Night only)
                            state.currentCustomer = JSON.parse(JSON.stringify(currentLangData.MILLIONAIRE_CUSTOMER));
                        } else if (Math.random() < 0.05 && state.timeOfDay === 'night') { // Death/Witch (Night only)
                            state.currentCustomer = JSON.parse(JSON.stringify(currentLangData.DEATH_CUSTOMER));
                        } else {
                            // Prevent consecutive same customer
                            let template;
                            let attempts = 0;
                            const maxAttempts = 5;
                            do {
                                template = potentialCustomers[Math.floor(Math.random() * potentialCustomers.length)];
                                attempts++;
                            } while (
                                potentialCustomers.length > 1 &&
                                state.lastCustomerId &&
                                template.name === state.lastCustomerId &&
                                attempts < maxAttempts
                            );
                            state.lastCustomerId = template.name; // Store for next check
                            state.currentCustomer = JSON.parse(JSON.stringify(template));
                        }

                        // Update Window immediately
                        updateEnvironmentVisuals();

                        dom.customerDialogueEl.classList.remove('show');
                        dom.customerEl.src = state.currentCustomer.image;
                        if (!isOkawari) {
                            dom.customerEl.classList.remove('slide-out', 'angry');
                            dom.customerEl.classList.add('slide-in');
                        }
                        dom.customerEl.style.opacity = '1'; // Ensure visible

                        // Generate Cocktail Order
                        if (state.currentCustomer.constraints) {
                            state.currentOrder = {
                                isConstraint: true,
                                constraints: state.currentCustomer.constraints,
                                text: state.currentCustomer.quotes.order[0]
                            };
                        } else {
                            // Normal Customer order generation
                            if (!isOkawari) {
                                // 85% Chance to order something makable with current ingredients
                                const makableCocktails = currentLangData.COCKTAILS.filter(c =>
                                    c.ingredients.every(ing => state.ownedIngredients.includes(ing))
                                );

                                let randomCocktail;
                                if (Math.random() < 0.85 && makableCocktails.length > 0) {
                                    randomCocktail = makableCocktails[Math.floor(Math.random() * makableCocktails.length)];
                                } else {
                                    // 15% chance (or if no makable cocktails) to pick any
                                    randomCocktail = currentLangData.COCKTAILS[Math.floor(Math.random() * currentLangData.COCKTAILS.length)];
                                }
                                state.currentOrder = { ...randomCocktail, isConstraint: false };
                            }
                            // If isOkawari, we keep state.currentOrder as is
                        }

                        // === MYSTERY MODE OVERRIDE ===
                        if (state.isMysteryMode) {
                            state.currentCustomer.name = "???";
                            // Scramble quotes
                            state.currentCustomer.quotes = {
                                order: ["..."],
                                success: ["...フフ..."],
                                fail: ["...チッ..."],
                                chat: ["..."]
                            };
                        }

                        // Check for missing ingredients
                        const isMissing = checkMissingIngredients();
                        if (isMissing) {
                            // Show Recommendation Button
                            setTimeout(() => {
                                showRecommendationOption();
                            }, 800);
                        }

                        setTimeout(() => {
                            if (!state.currentOrder.isFreeChoice) {
                                dom.orderTextEl.textContent = state.currentOrder.isConstraint
                                    ? state.currentOrder.text
                                    : state.currentOrder.name;
                            } else {
                                dom.orderTextEl.textContent = state.language === 'ja' ? 'おまかせ (おすすめ)' : 'Recommendation';
                            }

                            dom.orderIngredientsEl.innerHTML = '';
                            if (state.currentOrder.isConstraint || state.currentOrder.isFreeChoice) {
                                // Show nothing or hint
                                if (state.currentOrder.isFreeChoice) {
                                    const div = document.createElement('div');
                                    div.textContent = '✨';
                                    div.className = 'animate-pulse text-2xl';
                                    dom.orderIngredientsEl.appendChild(div);
                                }
                            } else {
                                state.currentOrder.ingredients.forEach(ingKey => {
                                    const ingredient = currentLangData.INGREDIENTS[ingKey];
                                    if (ingredient) {
                                        const div = document.createElement('div');
                                        div.style.backgroundColor = ingredient.color;
                                        div.style.boxShadow = `0 0 5px ${ingredient.glow}`;
                                        div.className = 'w-4 h-4 md:w-6 md:h-6 rounded-full border border-gray-400';
                                        div.title = ingredient.name;
                                        dom.orderIngredientsEl.appendChild(div);
                                    }
                                });
                            }

                            dom.orderBubbleEl.style.opacity = '1';
                            const orderMsg = state.currentOrder.isFreeChoice
                                ? (state.language === 'ja' ? 'じゃあ、君のおすすめを頼むよ！' : 'Alright, surprise me!')
                                : (isOkawari ? currentLangData.okawariMsg : state.currentCustomer.quotes.order);

                            showDialogue(orderMsg);

                            updateRecipeDisplay();
                            // ... existing update code ...
                            if (isOkawari) {
                                showFloatingText(currentLangData.okawari, '#f472b6', dom.customerEl);
                                playSound('tip');
                            }

                            state.canInteract = true;
                            // Glass Selection: Default to Collins, user can change it
                            state.selectedGlass = 'collins';
                            updateGlassVisuals('collins');
                            state.canInteract = true;
                        }, 700); // Wait for slide-in animation
                    }, delay); // Wait for slide-out animation (if exiting)
                }

                function updateRecipeDisplay() {
                    const currentLangData = translations[state.language];
                    if (state.currentOrder) {
                        if (state.currentOrder.isConstraint) {
                            // Special Order Display
                            const constraints = state.currentOrder.constraints;
                            let desc = [];
                            if (constraints.includes) desc.push(`${currentLangData.recipe}: ${constraints.includes.join(', ')}`);
                            if (constraints.minAlcohol) desc.push(`Alcohol >= ${constraints.minAlcohol}`);
                            if (constraints.exactCount) desc.push(`${currentLangData.recipe} x ${constraints.exactCount}`);

                            let glassName = constraints.glass ? currentLangData['glass' + constraints.glass.charAt(0).toUpperCase() + constraints.glass.slice(1)] : "Any";

                            dom.recipeDisplayEl.innerHTML = `
                                <p class="font-bold font-jp text-center text-amber-300 border-b border-amber-300/50 mb-1">SPECIAL ORDER</p>
                                <p class="text-xs font-jp text-gray-400 mb-1">${currentLangData.glassLabel} ${glassName}</p>
                                <p class="text-sm font-jp text-red-300 animate-pulse">${desc.join('<br>')}</p>
                            `;
                        } else {
                            const recipeItems = state.currentOrder.ingredients.map(key => {
                                const ing = currentLangData.INGREDIENTS[key];
                                return ing ? ing.name.replace('\n', '') : key;
                            });
                            if (state.currentOrder.needsIce) recipeItems.push(currentLangData.ice);

                            // Show Glass Type
                            let glassName = currentLangData.glassCollins;
                            if (state.currentOrder.glass === 'cocktail') glassName = currentLangData.glassCocktail;
                            else if (state.currentOrder.glass === 'rocks') glassName = currentLangData.glassRocks;
                            else if (state.currentOrder.glass === 'short') glassName = currentLangData.glassShort;

                            dom.recipeDisplayEl.innerHTML = `
                            <p class="font-bold font-jp text-center text-amber-300 border-b border-amber-300/50 mb-1">${currentLangData.recipe}</p>
                            <p class="text-xs font-jp text-gray-400 mb-1">${currentLangData.glassLabel} ${glassName}</p>
                            <p class="text-sm font-jp">${recipeItems.join(', ')}</p>
                        `;
                        }
                        dom.recipeDisplayEl.style.opacity = '1';
                    } else {
                        dom.recipeDisplayEl.style.opacity = '0';
                    }
                }

                window.finishCocktail = function (method) {
                    if (!state.isGameRunning || !state.canInteract || (state.shakerContents.length === 0 && !state.shakerHasIce)) return;
                    if (!checkTutorialStep('shake')) return;

                    // Animation - always shake for now since it's the "Finish" button
                    let sound = 'shake';
                    state.canInteract = false;
                    dom.customerDialogueEl.classList.remove('show');

                    // === PHASE 2: Add liquid wave effect during shake ===
                    addLiquidWaveEffect();

                    dom.shakerAreaEl.classList.add('shake-animation');
                    // Play sound multiple times for effect
                    for (let i = 0; i < 5; i++) setTimeout(() => playSound('shake'), i * 80);

                    setTimeout(() => {
                        dom.shakerAreaEl.classList.remove('shake-animation');
                        removeLiquidWaveEffect(); // Remove wave after shake

                        if (state.isTutorial) {
                            runTutorialEnding();
                        } else {
                            validateCocktail();
                        }
                    }, 800);
                };

                function proceedToNextCustomer(wasSuccess = false) {
                    resetShaker();

                    // Low probability of "Okawari" (20%) - ONLY on success
                    const isOkawari = wasSuccess && Math.random() < 0.2 && state.currentCustomer && !state.bossEncounterActive;
                    generateOrder(isOkawari ? state.currentCustomer : null, isOkawari);
                }

                function proceedAfterCustomer(wasSuccess = false) {
                    if (state.bossEncounterActive) {
                        state.bossEncounterActive = false;
                        setTimeout(endDay, 1000);
                    } else {
                        proceedToNextCustomer(wasSuccess);
                    }
                }

                function startGarnishMiniGame() {
                    // Simplified Garnish: Auto-apply for now to unblock
                    // Future: Add garnish selection UI similar to glass/ingredients
                    const currentLangData = translations[state.language];
                    let garnish = state.currentOrder.garnish;
                    if (!garnish) garnish = 'lime'; // Default

                    // Just show success immediately for this phase
                    setTimeout(() => {
                        showFloatingText(`${GARNISHES[garnish] || '👌'} Perfect!`, '#22c55e', dom.cocktailGlassEl);
                        setTimeout(() => proceedAfterCustomer(true), 1500);
                    }, 500);
                }

                function validateCocktail() {

                    const currentLangData = translations[state.language];
                    dom.finalCocktailEl.style.background = dom.shakerContentsEl.style.background;
                    dom.finalCocktailEl.style.setProperty('--fill-height', '80%');
                    dom.finalCocktailEl.classList.add('animate-fill');

                    // Alcohol Calculation (Moved up for logic)
                    let totalAlcohol = 0;
                    state.shakerContents.forEach(key => {
                        const ing = currentLangData.INGREDIENTS[key];
                        if (ing && ing.alcohol) totalAlcohol += ing.alcohol;
                    });

                    let isCorrect = false;
                    let ingredientMatch = false;
                    let iceMatch = false;
                    let glassMatch = false;

                    if (state.currentOrder.isConstraint) {
                        const c = state.currentOrder.constraints;
                        glassMatch = (!c.glass) || (state.selectedGlass === c.glass);

                        let includesMatch = true;
                        if (c.includes) includesMatch = c.includes.every(req => state.shakerContents.includes(req));

                        let alcoholMatch = true;
                        if (c.minAlcohol) alcoholMatch = totalAlcohol >= c.minAlcohol;

                        let countMatch = true;
                        if (c.exactCount) countMatch = state.shakerContents.length === c.exactCount;

                        // Constraints Logic
                        isCorrect = glassMatch && includesMatch && alcoholMatch && countMatch;

                    } else if (state.currentOrder.isFreeChoice) {
                        // Free Choice / Recommendation Logic
                        // Correct if Shaker is not empty
                        isCorrect = state.shakerContents.length > 0;
                        glassMatch = true;
                        ingredientMatch = true;
                        iceMatch = true; // lenient

                        // Check if it matches a real cocktail for bonus?
                        const foundCocktail = currentLangData.COCKTAILS.find(c => {
                            if (c.ingredients.length !== state.shakerContents.length) return false;
                            const sortedA = [...c.ingredients].sort();
                            const sortedB = [...state.shakerContents].sort();
                            return sortedA.every((val, index) => val === sortedB[index]);
                        });

                        if (foundCocktail) {
                            // Bonus handling could go here
                            state.discoveredCocktails.push(foundCocktail.name);
                        }

                    } else {
                        // Normal Recipe Logic
                        const madeRecipeSorted = JSON.stringify([...state.shakerContents].sort());
                        const targetRecipeSorted = JSON.stringify([...state.currentOrder.ingredients].sort());

                        ingredientMatch = madeRecipeSorted === targetRecipeSorted;
                        iceMatch = state.currentOrder.needsIce === state.shakerHasIce;
                        if (state.currentOrder.needsIce === false) iceMatch = true; // Lenient on ice if not needed? Or strict? 
                        // Original was: iceMatch = state.currentOrder.needsIce === state.shakerHasIce;
                        // Actually, looking at previous code, let's restore exact logic.
                        iceMatch = state.currentOrder.needsIce === state.shakerHasIce;

                        glassMatch = state.selectedGlass === state.currentOrder.glass;

                        isCorrect = ingredientMatch && iceMatch && glassMatch;
                    }

                    // Secret check (Only applies if not already correct and NOT a special order - simplified)
                    let foundSecret = (!isCorrect && !state.currentOrder.isConstraint) ? currentLangData.SECRET_COCKTAILS.find(c => JSON.stringify([...c.ingredients].sort()) === JSON.stringify([...state.shakerContents].sort()) && c.needsIce === state.shakerHasIce) : null;

                    // Drunkenness (Simple Text Effect) - Future expansion: scramble text
                    if (totalAlcohol >= 50 && isCorrect) {
                        showFloatingText("STRONG!", "#dc2626", dom.scoreDisplayEl);
                    }

                    if (isCorrect) {
                        state.combo++;
                        let comboBonus = state.combo * 10 * (state.upgrades.shaker.purchased ? 1.2 : 1);
                        let points = 100 + comboBonus;
                        if (state.currentCustomer.name === currentLangData.DEATH_CUSTOMER.name) points = 300;
                        if (state.isHappyHour) points *= 2;
                        if (state.currentOrder.needsIce && state.upgrades.iceMachine.purchased) points += 20;

                        // === PHASE 2: Event multiplier ===
                        points *= getEventMultiplier();

                        state.score += Math.round(points);
                        showFloatingText(`+¥${Math.round(points)}`, '#84cc16', dom.scoreDisplayEl);

                        // === PHASE 2: Weather tip multiplier ===
                        if (state.currentCustomer.name === currentLangData.MILLIONAIRE_CUSTOMER.name) {
                            const tip = Math.round(200 * (state.isHappyHour ? 2 : 1) * getWeatherTipMultiplier());
                            state.score += tip;
                            setTimeout(() => { showFloatingText(`Tip +¥${tip}!`, '#ffd700', dom.scoreDisplayEl); playSound('tip'); }, 300);
                        }

                        showDialogue(state.currentCustomer.quotes.success);
                        dom.resultTextEl.textContent = currentLangData.resultSuccess;
                        dom.resultTextEl.style.color = '#65a30d';
                        playSound('success'); playSound('combo');
                        if (state.bossEncounterActive && isCorrect) {
                            state.bossDefeated = true;
                        }

                        // === NEW: Record cocktail and customer for encyclopedias ===
                        if (state.currentOrder.name) {
                            recordCocktailDiscovery(state.currentOrder.name);
                        }
                        if (state.currentCustomer.name) {
                            recordCustomerMet(state.currentCustomer.name);
                        }

                        // === PHASE 2: Add drunk level and sparkle effect ===
                        addDrunkLevel(totalAlcohol);
                        createSparkles(dom.cocktailGlassEl);

                        startGarnishMiniGame();
                    } else if (foundSecret) {
                        let bonus = foundSecret.bonus * (state.isHappyHour ? 2 : 1);
                        state.score += bonus;
                        showFloatingText(`SECRET! +¥${bonus}`, '#f0abfc', dom.scoreDisplayEl);
                        dom.resultTextEl.textContent = currentLangData.resultSecret;
                        dom.resultTextEl.style.color = '#c026d3';
                        playSound('tip');

                        // Add to discovered secrets
                        if (!state.discoveredSecrets.includes(foundSecret.name)) {
                            state.discoveredSecrets.push(foundSecret.name);
                            setTimeout(() => showFloatingText("New Recipe Discovered!", "#fff", dom.scoreDisplayEl), 1000);
                        }

                        setTimeout(() => proceedAfterCustomer(true), 2000);
                    } else if (ingredientMatch && iceMatch && !glassMatch) {
                        // === WRONG GLASS SCENARIO ===
                        // Feedback on Wrong Glass (Custom Quote + Gentler Penalty)
                        state.combo = 0;
                        let points = -10; // Smaler penalty than full fail
                        if (state.upgrades.barManual.purchased) points /= 2;
                        state.score += Math.round(points);

                        showFloatingText(`Glass? ¥${Math.round(points)}`, '#f59e0b', dom.scoreDisplayEl);

                        // Try to get specific wrongGlass quote
                        const glassQuote = state.currentCustomer.quotes.wrongGlass || state.currentCustomer.quotes.fail;
                        showDialogue(glassQuote);

                        dom.resultTextEl.textContent = currentLangData.reasonGlass; // Just show "Glass" or similar
                        dom.resultTextEl.style.color = '#f59e0b';

                        // Neutral expression if possible, or keep normal
                        // dom.customerEl.classList.add('angry'); // Maybe don't make them angry for just glass?
                        playSound('fail'); // Or maybe a different sound? 'fail' is okay for now.
                        setTimeout(() => proceedAfterCustomer(false), 2000);

                    } else {
                        // Feedback on failure (Total Fail)
                        let failMsg = currentLangData.resultFail;
                        if (!ingredientMatch) failMsg += currentLangData.reasonRecipe;
                        else if (!iceMatch) failMsg += currentLangData.reasonIce;
                        else if (!glassMatch) failMsg += currentLangData.reasonGlass;

                        state.combo = 0;
                        let points = (state.currentCustomer.name === currentLangData.DEATH_CUSTOMER.name ? -50 : -20);
                        if (state.upgrades.barManual.purchased) points /= 2;
                        state.score += Math.round(points);

                        showFloatingText(`¥${Math.round(points)}`, '#ef4444', dom.scoreDisplayEl);
                        showDialogue(state.currentCustomer.quotes.fail);
                        dom.resultTextEl.textContent = failMsg;
                        dom.resultTextEl.style.color = '#dc2626';
                        if (state.currentCustomer.name !== currentLangData.DEATH_CUSTOMER.name) dom.customerEl.classList.add('angry');
                        playSound('fail');
                        setTimeout(() => proceedAfterCustomer(false), 2000);
                    }
                    updateScore();
                    updateComboDisplay();
                }

                function updateGlassVisuals(type) {
                    let pathD = '';
                    let maskClip = '';
                    let liquidBottom = '';

                    // Define Glass Data: path, clipPath (for liquid mask), liquidBottom (position)
                    if (type === 'rocks') {
                        pathD = PATH_ROCKS;
                        maskClip = 'polygon(15% 33.3%, 85% 33.3%, 80% 95.8%, 20% 95.8%)';
                        liquidBottom = '4.2%'; // 115/120 from top
                    } else if (type === 'cocktail') {
                        pathD = PATH_COCKTAIL_GLASS + " " + PATH_COCKTAIL_STEM;
                        maskClip = 'polygon(10% 8.3%, 90% 8.3%, 50% 58.3%)';
                        liquidBottom = '41.7%'; // 70/120 from top
                    } else { // Collins (Default)
                        pathD = PATH_COLLINS;
                        maskClip = 'polygon(20% 8.3%, 80% 8.3%, 75% 95.8%, 25% 95.8%)';
                        liquidBottom = '4.2%';
                    }

                    const svg = dom.cocktailGlassEl.querySelector('svg');
                    if (svg) {
                        svg.innerHTML = `<path d="${pathD}" fill="none" stroke="white" stroke-width="2" filter="drop-shadow(0 0 2px rgba(255,255,255,0.5))" />`;
                    }

                    // Update Liquid Mask and Position
                    const mask = document.getElementById('liquid-mask');
                    const liquid = document.getElementById('final-cocktail');

                    if (mask) mask.style.clipPath = maskClip;
                    if (liquid) liquid.style.bottom = liquidBottom;
                }

                // --- Glass Selection Logic ---
                window.selectGlass = function (type) {
                    state.selectedGlass = type;
                    if (!checkTutorialStep('glass', type)) {
                        // Even if validation fails, close the overlay so user can see the hint/try again
                        document.getElementById('glass-selection-overlay').classList.add('hidden');
                        return;
                    }
                    state.canInteract = true;
                    updateGlassVisuals(type);
                    document.getElementById('glass-selection-overlay').classList.add('hidden');
                    playSound('ice');
                };

                function openGlassSelection() {
                    if (!state.isGameRunning || (dom.shakerAreaEl.classList.contains('shake-animation'))) return;
                    document.getElementById('glass-selection-overlay').classList.remove('hidden');
                }

                // New: Ingredient Overlay Logic
                function openIngredientSelection() {
                    if (!state.isGameRunning || !state.canInteract) return;
                    document.getElementById('ingredient-selection-overlay').classList.remove('hidden');
                }

                document.getElementById('close-ingredient-overlay').onclick = () => {
                    document.getElementById('ingredient-selection-overlay').classList.add('hidden');
                };

                function checkMissingIngredients() {
                    if (!state.currentOrder || state.currentOrder.isConstraint || state.currentOrder.isFreeChoice) return false;
                    // Check if we own all required ingredients
                    return state.currentOrder.ingredients.some(ing => !state.ownedIngredients.includes(ing));
                }

                function showRecommendationOption() {
                    // Create a temporary button near the talk button
                    let btn = document.getElementById('recommend-btn');
                    if (!btn) {
                        btn = document.createElement('button');
                        btn.id = 'recommend-btn';
                        // Positioned at bottom-32 left-4 to avoid recipe overlap (top-right) and talk button (bottom-center/right)
                        btn.className = 'absolute bottom-32 left-4 bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-full shadow-lg font-jp animate-bounce z-50';
                        btn.onclick = applyRecommendation;
                        dom.customerAreaEl.appendChild(btn);
                    }
                    // Update text to "Tell them you are out of stock"
                    btn.textContent = state.language === 'ja' ? '🗣️ 在庫切れを伝える' : '🗣️ Inform Out of Stock';
                    btn.classList.remove('hidden');
                }

                function applyRecommendation() {
                    const btn = document.getElementById('recommend-btn');
                    if (btn) btn.classList.add('hidden');

                    // Step 1: Customer reacts to the bad news
                    const msg1 = state.language === 'ja' ? 'えっ？材料がないのかい？困ったな…' : 'Huh? You\'re out of ingredients? That\'s a problem...';
                    showDialogue(msg1);
                    playSound('low_tone'); // A sad/confused sound if available, otherwise reuse pop or omit

                    // Step 2: Customer agrees to a recommendation
                    setTimeout(() => {
                        const msg2 = state.language === 'ja' ? '…仕方ない。じゃあ、君のおすすめを作ってくれ。' : '...Well, can\'t be helped. Just make me your recommendation.';
                        showDialogue(msg2);

                        state.currentOrder = {
                            isFreeChoice: true,
                            name: 'Recommendation',
                            ingredients: [], // No specific constraints
                            glass: 'any'
                        };

                        // Update UI text
                        dom.orderTextEl.textContent = state.language === 'ja' ? 'おまかせ (おすすめ)' : 'Recommendation';
                        dom.orderIngredientsEl.innerHTML = '<div class="animate-pulse text-2xl">✨</div>';
                        dom.recipeDisplayEl.style.opacity = '0';
                        playSound('sparkle');
                    }, 2000); // 2 second delay for reading
                }

                function generateIngredients() {
                    const grid = document.getElementById('ingredient-grid');
                    grid.innerHTML = '';
                    const currentLangData = translations[state.language];
                    Object.keys(currentLangData.INGREDIENTS).forEach(key => {
                        const ing = currentLangData.INGREDIENTS[key];
                        const isOwned = state.ownedIngredients.includes(key);
                        const btn = document.createElement('button');
                        btn.id = 'ing-' + key;

                        // Visual Feedback for Selection
                        const isSelected = state.shakerContents.includes(key);
                        let baseClasses = 'w-full aspect-square rounded shadow-md flex items-center justify-center text-xs md:text-sm font-bold font-jp break-words p-1 md:p-2 transition-transform border-2 border-transparent';

                        if (isOwned) {
                            const selectedClass = isSelected ? 'ring-4 ring-white scale-95' : 'hover:scale-105 hover:border-white';
                            btn.className = `${baseClasses} ${selectedClass}`;
                            btn.style.backgroundColor = ing.color;
                            btn.style.color = '#333';
                            if (['cassis', 'cola', 'kahlua', 'coffee'].includes(key)) btn.style.color = '#fff';
                        } else {
                            // Locked State
                            btn.className = `${baseClasses} opacity-40 grayscale cursor-not-allowed`;
                            btn.style.backgroundColor = ing.color; // Show color but grayscale filter will mute it
                            btn.style.color = '#333';
                        }

                        btn.textContent = ing.name;

                        if (isOwned) {
                            btn.onclick = () => {
                                if (state.canInteract) {
                                    if (!checkTutorialStep('ingredient', key)) return;
                                    if (state.shakerContents.length < 5) {
                                        state.shakerContents.push(key);
                                        updateShakerVisual();
                                        playSound('pour');
                                        generateIngredients(); // Refresh to show selection
                                    }
                                }
                            };
                        } else {
                            // Optional: Click on locked item prompt "Buy in Market"
                            btn.onclick = () => {
                                showFloatingText(state.language === 'ja' ? '市場で購入できます' : 'Available in Market', '#fbbf24', btn);
                            };
                        }
                        grid.appendChild(btn);
                    });
                }

                // ... (initialSetup) ...
                // --- Tutorial Functions ---
                function startTutorial() {
                    state.isTutorial = true;
                    state.tutorialStep = 1;
                    state.day = 1;
                    state.totalMoney = 1000;
                    state.timeOfDay = 'night'; // Tutorial is set at night
                    state.score = 0;

                    // Reset Game State (similar to startDay)
                    Object.assign(state, {
                        isGameRunning: true, // Start running immediately
                        canInteract: false,
                        isHappyHour: false,
                        currentCustomer: null,
                        currentOrder: null,
                        isBossActive: false,
                        hasTalked: false,
                        shakerContents: [],
                        shakerHasIce: false,
                        combo: 0
                    });

                    dom.gameContainerEl.classList.remove('boss-mode');
                    showView('game');
                    dom.gameOverlayEl.style.opacity = '0';
                    dom.gameOverlayEl.style.pointerEvents = 'none';

                    showMenuButton();
                    updateTitleDisplay();
                    updateUIDisplays();
                    updateScore();

                    // Tutorial Customer
                    state.currentCustomer = {
                        name: "Master Bartender",
                        image: "images/night/red_beard_man.png",
                        quotes: {
                            order: ["..."],
                            success: ["Good job. You have potential."],
                            fail: ["No, no. Focus."],
                            chat: ["Pay attention to the order."]
                        }
                    };

                    // Start Sequence
                    setTimeout(() => {
                        showFloatingText("Welcome to the Tutorial", "#fff", dom.gameContainerEl);

                        // Fake Arrival
                        dom.customerEl.src = state.currentCustomer.image;
                        dom.customerEl.classList.remove('slide-out');
                        dom.customerEl.classList.add('slide-in');
                        dom.customerEl.style.opacity = '1';

                        setTimeout(() => {
                            showDialogue(["兼業バーテンダーへようこそ。", "まずは基本のカクテル『スクリュードライバー』を作ってもらおう。"]);

                            setTimeout(() => {
                                // Set Order
                                state.currentOrder = {
                                    name: 'Screwdriver',
                                    ingredients: ['vodka', 'orangeJuice'],
                                    needsIce: true,
                                    glass: 'collins',
                                    isConstraint: false
                                };

                                updateRecipeDisplay();
                                showDialogue("注文は『スクリュードライバー』だ。レシピは右上に表示されているぞ。");

                                // Step 1: Vodka
                                state.tutorialStep = 1;
                                highlightElement('ing-vodka');
                                showFloatingText("Select Vodka", "#fbbf24", dom.gameContainerEl);
                                state.canInteract = true;

                            }, 3000);
                        }, 1000);
                    }, 500);
                }
                window.startTutorial = startTutorial;

                function checkTutorialStep(action, value) {
                    if (!state.isTutorial) return true;

                    const currentStep = state.tutorialStep;
                    let valid = false;
                    let nextStep = currentStep;
                    let hint = "";

                    // Step 1: Add Vodka
                    if (currentStep === 1) {
                        if (action === 'ingredient' && value === 'vodka') {
                            valid = true;
                            nextStep = 2;
                            showDialogue("いいぞ。次は『オレンジジュース』を入れろ。");
                            highlightElement('ing-orangeJuice');
                        } else {
                            hint = "まずは『ウォッカ』を選んでくれ。";
                            highlightElement('ing-vodka');
                        }
                    }
                    // Step 2: Add Orange Juice
                    else if (currentStep === 2) {
                        if (action === 'ingredient' && value === 'orangeJuice') {
                            valid = true;
                            nextStep = 3;
                            showDialogue("よし。材料は揃ったな。次は氷を入れるんだ。");
                            highlightElement('add-ice-button');
                        } else {
                            hint = "次は『オレンジジュース』だ。";
                            highlightElement('ing-orangeJuice');
                        }
                    }
                    // Step 3: Add Ice
                    else if (currentStep === 3) {
                        if (action === 'ice') {
                            valid = true;
                            nextStep = 4;
                            showDialogue("次はグラスを選ぶぞ。スクリュードライバーには『ロンググラス』がいい。");
                            highlightElement('cocktail-glass');
                        } else {
                            hint = "『氷を入れる』ボタンを押してくれ。";
                            highlightElement('add-ice-button');
                        }
                    }
                    // Step 4: Select Glass
                    else if (currentStep === 4) {
                        if (action === 'glass' && value === 'collins') {
                            valid = true;
                            nextStep = 5;
                            showDialogue("準備完了だ！『シェイク』して仕上げろ！");
                            highlightElement('shake-button');
                        } else if (action === 'glass') { // Wrong glass
                            hint = "スクリュードライバーには『ロンググラス』(Collins) を選ぶんだ。";
                            highlightElement('cocktail-glass');
                        } else {
                            hint = "グラスをタップして選んでくれ。";
                            highlightElement('cocktail-glass');
                        }
                    }
                    // Step 5: Shake / Finish
                    else if (currentStep === 5) {
                        if (action === 'shake') {
                            valid = true;
                            nextStep = 0; // Done
                            // Previous logic removed. Now delegated to runTutorialEnding via finishCocktail check.
                            highlightElement(null); // Clear
                        } else {
                            hint = "『シェイク』ボタンで完成させるんだ！";
                            highlightElement('shake-button');
                        }
                    }

                    if (!valid && hint) {
                        showFloatingText(hint, '#f59e0b', dom.gameContainerEl);
                        playSound('fail');
                        return false;
                    }

                    if (valid && nextStep !== currentStep) {
                        state.tutorialStep = nextStep;
                    }
                    return true;
                }

                function runTutorialEnding() {
                    // Visuals: Fill Glass
                    dom.finalCocktailEl.style.background = dom.shakerContentsEl.style.background;
                    dom.finalCocktailEl.style.setProperty('--fill-height', '80%');
                    dom.finalCocktailEl.classList.add('animate-fill');

                    // Sequential Dialogue for ending
                    const dialogues = [
                        "よくやった！それが基本だ。",
                        "筋がいいな。これなら店を任せられるだろう。",
                        "さあ、お前の店を開ける時が来たぞ。健闘を祈る！"
                    ];

                    let delay = 500; // Start slightly after shake ends
                    dialogues.forEach((text) => {
                        setTimeout(() => {
                            showDialogue(text);
                        }, delay);
                        delay += 3500; // Time to read
                    });

                    setTimeout(() => {
                        showFloatingText("Tutorial Complete!", "#4ade80", dom.gameContainerEl);
                        playSound('success');
                        setTimeout(() => {
                            location.reload(); // Return to title screen
                        }, 3000);
                    }, delay + 500);
                }

                function highlightElement(id) {
                    // Remove existing highlights and cancel animations
                    document.querySelectorAll('.tutorial-highlight').forEach(el => {
                        el.classList.remove('tutorial-highlight');
                        el.getAnimations().forEach(anim => anim.cancel());
                        el.style.transform = '';
                        el.style.boxShadow = '';
                    });

                    if (id) {
                        const el = document.getElementById(id);
                        if (el) {
                            el.classList.add('tutorial-highlight');
                            el.animate([
                                { transform: 'scale(1)', boxShadow: '0 0 0 rgba(255,255,0,0)' },
                                { transform: 'scale(1.1)', boxShadow: '0 0 20px rgba(251, 191, 36, 0.8)' },
                                { transform: 'scale(1)', boxShadow: '0 0 0 rgba(255,255,0,0)' }
                            ], {
                                duration: 1000,
                                iterations: Infinity
                            });
                        }
                    }
                }

                function initialSetup() {
                    const allElementIds = [
                        'initial-start-btn', 'game-overlay', 'game-container', 'room-container', 'room-day-display',
                        'room-money-display', 'daily-earnings-display', 'next-day-button', 'upgrades-section',
                        'bgm-audio', 'day-display', 'money-display', 'combo-display', 'timer-display', 'timer',
                        'score-display', 'score', 'happy-hour-banner', 'customer-area', 'customer-dialogue', 'customer',
                        'order-bubble', 'customer-name', 'order-text', 'order-ingredients', 'bar-counter',
                        'shaker-area', 'shaker-ice-cubes', 'shaker-contents', 'add-ice-button',
                        'shake-button', 'glass-button',
                        'talk-button',
                        'reset-button', 'cocktail-glass', 'final-cocktail', 'result-text', 'ingredient-shelf',
                        'garnish-container', 'recipe-display'
                    ];
                    allElementIds.forEach(id => {
                        const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                        dom[camelCaseId + 'El'] = document.getElementById(id);
                    });

                    setupSounds();

                    // Bind all buttons
                    // Note: initial-start-btn has onclick in HTML, no need for addEventListener here
                    // if it just calls showSaveSlots().
                    dom.nextDayButtonEl.addEventListener('click', startNextDay);
                    dom.addIceButtonEl.addEventListener('click', () => { if (state.canInteract) addIce(); });

                    // New Bindings
                    dom.shakeButtonEl.addEventListener('click', () => finishCocktail('shake'));

                    dom.talkButtonEl.addEventListener('click', talk);
                    dom.resetButtonEl.addEventListener('click', () => { if (state.canInteract) resetShaker(); });

                    // Allow clicking glass to change it
                    dom.cocktailGlassEl.addEventListener('click', openGlassSelection);
                    dom.cocktailGlassEl.style.cursor = 'pointer'; // Make it look clickable

                    // Language switch removed
                    dom.glassButtonEl.addEventListener('click', () => { if (state.canInteract) openGlassSelection(); });
                    // Add ingredient button listener
                    document.getElementById('ingredient-button').addEventListener('click', () => { if (state.canInteract) openIngredientSelection(); });

                    // Initialize Ingredients
                    generateIngredients();

                    // Load BGM List and Start
                    fetchBGMList().then(() => {
                        console.log('BGM Tracks initialized');
                    });

                    // Load Settings
                    // Load Settings
                    const savedSettings = localStorage.getItem('bartenderSettings');
                    if (savedSettings) {
                        try {
                            state.settings = JSON.parse(savedSettings);
                            if (state.settings.performanceMode) {
                                document.body.classList.add('low-quality');
                            }
                        } catch (e) { }
                    }
                    // Set initial language (load from localStorage or default to English)
                    const savedLang = localStorage.getItem('bartenderLang') || 'en';
                    setLanguage(savedLang);

                    // Force hide old shelf logic if any
                    if (dom.ingredientShelfEl) dom.ingredientShelfEl.style.display = 'none';



                    // Help Button Logic
                    const helpButton = document.getElementById('help-button');
                    const helpOverlay = document.getElementById('help-overlay');
                    const helpCloseBtn = document.getElementById('help-close-btn');
                    const helpStartBtn = document.getElementById('help-start-btn');

                    function openHelp() {
                        helpOverlay.classList.add('active');
                    }

                    function closeHelp() {
                        helpOverlay.classList.remove('active');
                    }

                    helpButton.addEventListener('click', openHelp);
                    helpCloseBtn.addEventListener('click', closeHelp);
                    helpStartBtn.addEventListener('click', openHelp);

                    // Show help button when game is running
                    const originalStartDay = startDay;
                    startDay = function () {
                        helpButton.classList.add('visible');
                        originalStartDay();
                    };

                    // Load saved game data and apply interior
                    loadGameData();
                    applyInteriorVisuals();
                }



                // =============================================
                // ===== NEW FEATURES: MENU & ENCYCLOPEDIAS =====
                // =============================================

                // --- Menu Functions ---
                function openMenu() {
                    document.getElementById('menu-overlay').classList.add('active');
                }
                function closeMenu() {
                    document.getElementById('menu-overlay').classList.remove('active');
                }

                // --- Settings Functions ---
                window.updateVolume = function (type, value) {
                    state.settings.volume[type] = parseInt(value);
                    const displayEl = document.getElementById(type + '-val');
                    if (displayEl) displayEl.textContent = value + '%';

                    if (type === 'bgm') {
                        if (dom.bgmAudioEl) dom.bgmAudioEl.volume = (value / 100) * 0.3; // max 0.3
                    }
                    // SE volume is checked in playSound dynamically

                    localStorage.setItem('bartenderSettings', JSON.stringify(state.settings));
                };

                window.togglePerformanceMode = function () {
                    state.settings.performanceMode = !state.settings.performanceMode;
                    if (state.settings.performanceMode) {
                        document.body.classList.add('low-quality');
                    } else {
                        document.body.classList.remove('low-quality');
                    }
                    // Update button UI
                    const btn = document.getElementById('perf-toggle');
                    if (btn) {
                        btn.className = `px-4 py-2 rounded font-bold font-jp transition-colors ${state.settings.performanceMode ? 'bg-green-600 text-white' : 'bg-gray-600 text-gray-300'}`;
                        btn.textContent = state.settings.performanceMode ? 'ON' : 'OFF';
                    }
                    localStorage.setItem('bartenderSettings', JSON.stringify(state.settings));
                };

                function openSettings() {
                    closeMenu();
                    const overlay = document.getElementById('settings-overlay');
                    const modalInner = overlay.querySelector('.bg-gray-900') || overlay.querySelector('.bg-gray-800') || overlay.firstElementChild; // Flexible selector

                    if (modalInner) {
                        modalInner.innerHTML = `
                        <h2 class="text-2xl font-bold font-jp text-white mb-6 text-center">⚙️ Settings</h2>
                        
                        <div class="space-y-6">
                            <!-- BGM Volume -->
                            <div>
                                <div class="flex justify-between text-white font-jp mb-2">
                                    <span>🎵 BGM Volume</span>
                                    <span id="bgm-val">${state.settings.volume.bgm}%</span>
                                </div>
                                <input type="range" min="0" max="100" value="${state.settings.volume.bgm}" 
                                       oninput="updateVolume('bgm', this.value)" class="w-full">
                            </div>

                            <!-- SE Volume -->
                            <div>
                                <div class="flex justify-between text-white font-jp mb-2">
                                    <span>🔊 SE Volume</span>
                                    <span id="se-val">${state.settings.volume.se}%</span>
                                </div>
                                <input type="range" min="0" max="100" value="${state.settings.volume.se}" 
                                       oninput="updateVolume('se', this.value)" class="w-full">
                            </div>

                            <!-- Performance Mode -->
                            <div class="flex items-center justify-between">
                                <span class="text-white font-jp">🚀 Performance Mode</span>
                                <button id="perf-toggle" onclick="togglePerformanceMode()" 
                                        class="px-4 py-2 rounded font-bold font-jp transition-colors ${state.settings.performanceMode ? 'bg-green-600 text-white' : 'bg-gray-600 text-gray-300'}">
                                    ${state.settings.performanceMode ? 'ON' : 'OFF'}
                                </button>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-center">
                            <button onclick="closeSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full font-jp">
                                Close
                            </button>
                        </div>
                       `;
                    }
                    overlay.classList.add('active');
                }
                function closeSettings() {
                    document.getElementById('settings-overlay').classList.remove('active');
                }

                // Make settings functions globally accessible
                window.openSettings = openSettings;
                window.closeSettings = closeSettings;

                // --- Interior Shop Functions ---
                function openInteriorShop() {
                    closeMenu();
                    const overlay = document.getElementById('interior-shop-overlay');
                    const content = document.getElementById('interior-shop-content');
                    const moneyDisplay = document.getElementById('interior-money');
                    const lang = translations[state.language];

                    moneyDisplay.textContent = `${lang.interiorMoney}: ¥${state.totalMoney.toLocaleString()}`;
                    content.innerHTML = '';

                    const categories = [
                        { key: 'wallpaper', label: lang.wallpaperLabel },
                        { key: 'lighting', label: lang.lightingLabel }
                    ];

                    categories.forEach(cat => {
                        const section = document.createElement('div');
                        section.innerHTML = `<h3 class="text-lg font-bold text-white mb-2 font-jp">${cat.label}</h3>`;
                        const grid = document.createElement('div');
                        grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;';

                        INTERIOR_ITEMS[cat.key].forEach(item => {
                            const isOwned = state.ownedInterior[cat.key].includes(item.id);
                            const isEquipped = state.interior[cat.key] === item.id;
                            const canAfford = state.totalMoney >= item.price;
                            const itemName = state.language === 'ja' ? item.name : item.nameEn;
                            const itemDesc = state.language === 'ja' ? item.description : item.descEn;

                            const card = document.createElement('div');
                            card.className = 'interior-item';
                            card.style.cssText = `
                                background: ${isEquipped ? 'linear-gradient(135deg, #065f46, #059669)' : '#374151'};
                                border-radius: 10px; padding: 12px; cursor: pointer;
                                border: 2px solid ${isEquipped ? '#10b981' : isOwned ? '#6b7280' : canAfford ? '#fbbf24' : '#4b5563'};
                                transition: all 0.2s;
                            `;

                            let buttonText = '';
                            if (isEquipped) {
                                buttonText = `<span class="text-green-300">${lang.interiorEquipped}</span>`;
                            } else if (isOwned) {
                                buttonText = `<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-jp">使用</button>`;
                            } else if (item.price === 0) {
                                buttonText = `<span class="text-gray-400">${lang.interiorOwned}</span>`;
                            } else {
                                buttonText = `<button class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm font-jp ${!canAfford ? 'opacity-50' : ''}">${lang.interiorBuy} ¥${item.price.toLocaleString()}</button>`;
                            }

                            card.innerHTML = `
                                <div class="font-bold text-white font-jp">${itemName}</div>
                                <div class="text-xs text-gray-300 font-jp mb-2">${itemDesc}</div>
                                ${buttonText}
                            `;

                            if (!isEquipped) {
                                card.onclick = () => {
                                    if (isOwned) {
                                        equipInterior(cat.key, item.id);
                                    } else if (canAfford && item.price > 0) {
                                        buyInterior(cat.key, item);
                                    }
                                };
                            }

                            grid.appendChild(card);
                        });

                        section.appendChild(grid);
                        content.appendChild(section);
                    });

                    overlay.classList.add('active');
                }

                function closeInteriorShop() {
                    document.getElementById('interior-shop-overlay').classList.remove('active');
                }

                function buyInterior(category, item) {
                    if (state.totalMoney >= item.price) {
                        state.totalMoney -= item.price;
                        state.ownedInterior[category].push(item.id);
                        equipInterior(category, item.id);
                        saveGameData();
                        openInteriorShop(); // Refresh
                        playSound('cash');
                    }
                }

                function equipInterior(category, itemId) {
                    state.interior[category] = itemId;
                    applyInteriorVisuals();
                    saveGameData();
                    openInteriorShop(); // Refresh
                }

                function applyInteriorVisuals() {
                    const gameContainer = document.getElementById('game-container');
                    const roomContainer = document.getElementById('room-container');

                    // Apply wallpaper class
                    ['classic', 'modern', 'fantasy'].forEach(w => {
                        gameContainer?.classList.remove(`wall-${w}`);
                        roomContainer?.classList.remove(`wall-${w}`);
                    });
                    gameContainer?.classList.add(`wall-${state.interior.wallpaper}`);
                    roomContainer?.classList.add(`wall-${state.interior.wallpaper}`);

                    // Apply lighting class
                    ['warm', 'cool', 'neon'].forEach(l => {
                        gameContainer?.classList.remove(`light-${l}`);
                        roomContainer?.classList.remove(`light-${l}`);
                    });
                    gameContainer?.classList.add(`light-${state.interior.lighting}`);
                    roomContainer?.classList.add(`light-${state.interior.lighting}`);
                }

                // --- Save/Load Game Data ---
                function saveGameData() {
                    try {
                        console.log('[SAVE] saveGameData called');
                        console.log('[SAVE] Current state.currentSaveSlot:', state.currentSaveSlot);
                        let slot = parseInt(state.currentSaveSlot);
                        if (!slot || isNaN(slot)) {
                            console.warn("[SAVE] Invalid save slot, defaulting to 1");
                            slot = 1;
                        }
                        state.currentSaveSlot = slot;

                        const slotKey = `bartenderSave_${slot}`;
                        const saveData = {
                            interior: state.interior,
                            ownedInterior: state.ownedInterior,
                            totalMoney: state.totalMoney,
                            day: state.day,
                            discoveredCocktails: state.discoveredCocktails,
                            metCustomers: state.metCustomers,
                            unlockedTitles: state.unlockedTitles,
                            ownedIngredients: state.ownedIngredients,
                            upgrades: state.upgrades,
                            totalTalks: state.totalTalks,
                            avatar: state.avatar || 'images/night/bartender_man.png'
                        };
                        const jsonString = JSON.stringify(saveData);
                        localStorage.setItem(slotKey, jsonString);

                        // Verify immediately
                        const verify = localStorage.getItem(slotKey);
                        if (!verify) {
                            throw new Error("Verification failed: Data not found in localStorage immediately after save.");
                        }

                        console.log(`Game saved to slot ${slot}`);
                        // Show explicit success visualization
                        showFloatingText(`Saved to Slot ${slot}`, '#4ade80', dom.gameContainerEl);
                    } catch (e) {
                        console.error("Save failed:", e);
                        // Using alert to ensure user sees this critical error
                        alert(`Save Error: ${e.message}\nSlot: ${state.currentSaveSlot}`);
                        showFloatingText("CRITICAL SAVE ERROR", '#ef4444', document.body);
                    }
                }

                function loadGameData(slotId) {
                    const slotKey = `bartenderSave_${slotId || 1}`;
                    const saved = localStorage.getItem(slotKey);
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            if (data.interior) state.interior = data.interior;
                            if (data.ownedInterior) state.ownedInterior = data.ownedInterior;
                            if (data.totalMoney !== undefined) state.totalMoney = data.totalMoney;
                            if (data.day !== undefined) state.day = data.day;
                            if (data.discoveredCocktails) state.discoveredCocktails = data.discoveredCocktails;
                            if (data.metCustomers) state.metCustomers = data.metCustomers;
                            if (data.unlockedTitles) state.unlockedTitles = data.unlockedTitles;
                            if (data.ownedIngredients) state.ownedIngredients = data.ownedIngredients;
                            if (data.upgrades) state.upgrades = data.upgrades;
                            if (data.totalTalks) state.totalTalks = data.totalTalks;
                            state.avatar = data.avatar || 'images/avatar/man.png'; // Use default fallback if missing, corrected path
                            state.currentSaveSlot = parseInt(slotId) || 1;
                        } catch (e) {
                            console.error('Failed to load save data:', e);
                            alert("Corrupted Save Data encountered.");
                        }
                    }
                }

                function showSaveSlots() {
                    document.getElementById('title-screen-content').classList.add('hidden');
                    document.getElementById('slot-selection-content').classList.remove('hidden');
                    renderSaveSlots();
                }

                function hideSaveSlots() {
                    document.getElementById('title-screen-content').classList.remove('hidden');
                    document.getElementById('slot-selection-content').classList.add('hidden');
                }

                function renderSaveSlots() {
                    const grid = document.getElementById('save-slots-grid');
                    if (!grid) return;
                    grid.innerHTML = '';

                    for (let i = 1; i <= 3; i++) {
                        const card = document.createElement('div');
                        card.className = "bg-slate-800/80 p-6 rounded-2xl border-2 border-slate-700 flex flex-col items-center gap-4 relative overflow-hidden transition-all";

                        if (i === 1) {
                            // Slot 1: Active
                            const key = `bartenderSave_${i}`;
                            const saved = localStorage.getItem(key);
                            let data = null;
                            if (saved) {
                                try { data = JSON.parse(saved); } catch (e) { }
                            }

                            if (data) {
                                card.innerHTML = `
                                    <button onclick="deleteSave(${i})" class="absolute top-2 right-2 text-red-500 hover:text-red-400 text-xl p-2 z-10" title="Delete Save">🗑️</button>
                                    <img src="${data.avatar || 'images/night/bartender_man.png'}" class="w-24 h-24 rounded-full border-2 border-amber-500/50 bg-black/40">
                                    <div class="text-center">
                                        <div class="text-amber-400 font-jp font-bold text-xl">Slot ${i}</div>
                                        <div class="text-white font-jp text-lg">Day ${data.day || 1}</div>
                                        <div class="text-green-400 font-bold">¥${(data.totalMoney || 0).toLocaleString()}</div>
                                    </div>
                                    <button onclick="loadAndStart(${i})" class="w-full py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg font-jp transition-all hover:scale-105">ロード</button>
                                `;
                            } else {
                                card.innerHTML = `
                                    <div class="w-24 h-24 rounded-full border-2 border-slate-700 border-dashed flex items-center justify-center text-slate-600 text-4xl">?</div>
                                    <div class="text-center">
                                        <div class="text-slate-500 font-jp font-bold text-xl">Slot ${i}</div>
                                        <div class="text-slate-600 font-jp">空きスロット</div>
                                    </div>
                                    <button onclick="openCharacterSelection(${i})" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg font-jp transition-all hover:scale-105">冒険を始める</button>
                                `;
                            }
                        } else {
                            // Slot 2 & 3: Locked (Coming Soon)
                            card.classList.add('opacity-50', 'grayscale');
                            card.innerHTML = `
                                <div class="absolute top-2 right-2 text-gray-500 text-xl p-2">🔒</div>
                                <div class="w-24 h-24 rounded-full border-2 border-slate-700 bg-black/40 flex items-center justify-center text-3xl">🚫</div>
                                <div class="text-center">
                                    <div class="text-slate-500 font-jp font-bold text-xl">Slot ${i}</div>
                                    <div class="text-slate-500 font-jp">Coming Soon</div>
                                    <div class="text-slate-600 text-sm font-jp mt-1">追加スロット (課金予定)</div>
                                </div>
                                <button disabled class="w-full py-3 bg-gray-700 text-gray-500 font-bold rounded-lg font-jp cursor-not-allowed">ロック中</button>
                            `;
                        }
                        grid.appendChild(card);
                    }
                }

                function deleteSave(slotId) {
                    const confirmMsg = state.language === 'ja' ? `スロット ${slotId} のデータを削除しますか？` : `Delete slot ${slotId} data?`;
                    if (confirm(confirmMsg)) {
                        localStorage.removeItem(`bartenderSave_${slotId}`);
                        renderSaveSlots();
                    }
                }

                function loadAndStart(slotId) {
                    loadGameData(slotId);
                    document.getElementById('game-overlay').classList.add('opacity-0');
                    setTimeout(() => {
                        document.getElementById('game-overlay').classList.add('hidden');

                        // Stop Title BGM
                        const titleBgm = document.getElementById('title-bgm');
                        if (titleBgm) {
                            titleBgm.pause();
                        }

                        startAudio();
                        showView('room');
                        updateRoomUI();
                    }, 500);
                }

                let pendingSlotId = 1;
                function openCharacterSelection(slotId) {
                    // Default avatar for immediate start
                    const defaultAvatar = 'images/avatar/man.png';
                    startNewGame(slotId, defaultAvatar);
                }

                window.selectCharacter = function (avatarPath) {
                    startNewGame(pendingSlotId, avatarPath);
                }

                function startNewGame(slotId, avatarPath) {
                    state.currentSaveSlot = slotId;
                    state.avatar = avatarPath;
                    state.totalMoney = 1000;
                    state.day = 1;
                    state.discoveredCocktails = [];
                    state.metCustomers = [];
                    state.unlockedTitles = ['beginner'];
                    state.ownedIngredients = [...STARTER_INGREDIENTS];
                    state.upgrades = JSON.parse(JSON.stringify(UPGRADES_DATA));
                    state.totalTalks = 0;
                    // Reset BGM preferences to default
                    state.interior.bgm = 'skyline_serenity';
                    state.ownedInterior.bgm = ['skyline_serenity'];

                    saveGameData();

                    document.getElementById('game-overlay').classList.add('opacity-0');
                    setTimeout(() => {
                        document.getElementById('game-overlay').classList.add('hidden');

                        // Stop Title BGM
                        const titleBgm = document.getElementById('title-bgm');
                        if (titleBgm) {
                            titleBgm.pause();
                        }

                        startAudio();
                        startDay();
                    }, 500);
                }

                function saveGameManually() {
                    const dayEndScreen = document.getElementById('day-end-screen');
                    const isDayEnd = dayEndScreen && dayEndScreen.classList.contains('active');

                    if (state.isGameRunning && state.day > 0 && !isDayEnd) {
                        const msg = state.language === 'ja' ? "営業中はセーブできません！" : "Cannot save during business hours!";
                        showFloatingText(msg, '#ef4444', document.getElementById('menu-overlay'));
                        playSound('fail');
                        return;
                    }

                    saveGameData();
                    const msg = state.language === 'ja' ? "セーブしました！" : "Game Saved!";
                    showFloatingText(msg, '#4ade80', document.getElementById('menu-overlay'));
                    playSound('success');
                }

                window.showSaveSlots = showSaveSlots;
                window.hideSaveSlots = hideSaveSlots;
                window.deleteSave = deleteSave;
                window.loadAndStart = loadAndStart;
                window.openCharacterSelection = openCharacterSelection;
                window.saveGameManually = saveGameManually;

                // --- Photo Mode Functions ---
                let photoData = null;

                function openPhotoMode() {
                    const shakerArea = document.getElementById('shaker-area');
                    const gameContainer = document.getElementById('game-container');

                    // Capture the shaker area as screenshot
                    html2canvas(gameContainer, {
                        backgroundColor: '#1a1a2e',
                        scale: 2,
                        logging: false,
                        useCORS: true
                    }).then(canvas => {
                        const photoCanvas = document.getElementById('photo-canvas');
                        const ctx = photoCanvas.getContext('2d');

                        // Set canvas size
                        photoCanvas.width = canvas.width;
                        photoCanvas.height = canvas.height;

                        // Draw captured image
                        ctx.drawImage(canvas, 0, 0);

                        // Add watermark/branding
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        ctx.font = '24px "M PLUS Rounded 1c", sans-serif';
                        ctx.fillText('🍸 Bartender Game', 20, canvas.height - 20);

                        // Store for download
                        photoData = photoCanvas.toDataURL('image/png');

                        // Show overlay
                        document.getElementById('photo-mode-overlay').classList.remove('hidden');
                    });
                }

                function closePhotoMode() {
                    document.getElementById('photo-mode-overlay').classList.add('hidden');
                }

                function downloadPhoto() {
                    if (!photoData) return;
                    const link = document.createElement('a');
                    link.download = `cocktail_${Date.now()}.png`;
                    link.href = photoData;
                    link.click();
                }

                function shareToTwitter() {
                    const cocktailName = state.currentOrder ? state.currentOrder.name : 'カクテル';
                    const text = encodeURIComponent(`${cocktailName}を作りました！ #バーテンダーゲーム #カクテル`);
                    const url = encodeURIComponent(window.location.href);
                    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
                }

                function shareToLINE() {
                    const cocktailName = state.currentOrder ? state.currentOrder.name : 'カクテル';
                    const text = encodeURIComponent(`${cocktailName}を作りました！ バーテンダーゲーム`);
                    window.open(`https://social-plugins.line.me/lineit/share?text=${text}`, '_blank');
                }

                // Make photo functions globally accessible
                window.openPhotoMode = openPhotoMode;
                window.closePhotoMode = closePhotoMode;
                window.downloadPhoto = downloadPhoto;
                window.shareToTwitter = shareToTwitter;
                window.shareToLINE = shareToLINE;

                // --- Gesture Shake Functions ---
                let gestureState = {
                    isActive: false,
                    shakeCount: 0,
                    shakesRequired: 5,
                    lastAcceleration: { x: 0, y: 0, z: 0 },
                    shakeThreshold: 15,
                    lastShakeTime: 0,
                    shakeCooldown: 300 // ms between shakes
                };

                async function toggleGestureShake() {
                    if (gestureState.isActive) {
                        stopGestureShake();
                    } else {
                        await startGestureShake();
                    }
                }

                async function startGestureShake() {
                    // Request permission for iOS 13+
                    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                        try {
                            const permission = await DeviceMotionEvent.requestPermission();
                            if (permission !== 'granted') {
                                alert(state.language === 'ja'
                                    ? 'モーションセンサーの許可が必要です'
                                    : 'Motion sensor permission required');
                                return;
                            }
                        } catch (e) {
                            console.error('DeviceMotion permission error:', e);
                            alert(state.language === 'ja'
                                ? 'このブラウザでは使用できません'
                                : 'Not supported in this browser');
                            return;
                        }
                    }

                    gestureState.isActive = true;
                    gestureState.shakeCount = 0;

                    // Update button appearance
                    const btn = document.getElementById('gesture-shake-btn');
                    btn.classList.remove('bg-pink-500', 'hover:bg-pink-600');
                    btn.classList.add('bg-green-500', 'hover:bg-green-600', 'animate-pulse');
                    btn.innerHTML = `📱 振って！ (${gestureState.shakeCount}/${gestureState.shakesRequired})`;

                    // Start listening to device motion
                    window.addEventListener('devicemotion', handleDeviceMotion);

                    // Show instruction
                    showFloatingText(state.language === 'ja' ? '📱 スマホを振ろう！' : '📱 Shake your phone!', '#ec4899', document.getElementById('shaker-area'));
                }

                function stopGestureShake() {
                    gestureState.isActive = false;
                    window.removeEventListener('devicemotion', handleDeviceMotion);

                    // Reset button
                    const btn = document.getElementById('gesture-shake-btn');
                    btn.classList.remove('bg-green-500', 'hover:bg-green-600', 'animate-pulse');
                    btn.classList.add('bg-pink-500', 'hover:bg-pink-600');
                    btn.innerHTML = '📱 ジェスチャー';
                }

                function handleDeviceMotion(event) {
                    if (!gestureState.isActive || !state.isGameRunning || !state.canInteract) return;

                    const acceleration = event.accelerationIncludingGravity;
                    if (!acceleration) return;

                    const now = Date.now();
                    if (now - gestureState.lastShakeTime < gestureState.shakeCooldown) return;

                    // Calculate acceleration change
                    const deltaX = Math.abs(acceleration.x - gestureState.lastAcceleration.x);
                    const deltaY = Math.abs(acceleration.y - gestureState.lastAcceleration.y);
                    const deltaZ = Math.abs(acceleration.z - gestureState.lastAcceleration.z);
                    const totalDelta = deltaX + deltaY + deltaZ;

                    // Update last acceleration
                    gestureState.lastAcceleration = {
                        x: acceleration.x || 0,
                        y: acceleration.y || 0,
                        z: acceleration.z || 0
                    };

                    // Detect shake
                    if (totalDelta > gestureState.shakeThreshold) {
                        gestureState.shakeCount++;
                        gestureState.lastShakeTime = now;

                        // Update UI
                        const btn = document.getElementById('gesture-shake-btn');
                        btn.innerHTML = `📱 振って！ (${gestureState.shakeCount}/${gestureState.shakesRequired})`;

                        // Trigger shaker animation
                        const shakerArea = document.getElementById('shaker-area');
                        shakerArea.classList.add('shake-animation');
                        setTimeout(() => shakerArea.classList.remove('shake-animation'), 200);

                        // Play sound
                        playSound('shake');

                        // Check completion
                        if (gestureState.shakeCount >= gestureState.shakesRequired) {
                            stopGestureShake();
                            showFloatingText('🎉 シェイク完了！', '#22c55e', shakerArea);
                            setTimeout(() => validateCocktail(), 500);
                        }
                    }
                }

                // Make gesture functions globally accessible
                window.toggleGestureShake = toggleGestureShake;

                // --- Cocktail Encyclopedia ---
                function openCocktailEncyclopedia() {
                    closeMenu();
                    const overlay = document.getElementById('cocktail-encyclopedia');
                    const grid = document.getElementById('cocktail-grid');
                    const progress = document.getElementById('cocktail-progress');
                    const currentLangData = translations[state.language];
                    const cocktails = currentLangData.COCKTAILS;

                    grid.innerHTML = '';
                    cocktails.forEach(cocktail => {
                        const isDiscovered = state.discoveredCocktails.includes(cocktail.name);
                        const item = document.createElement('div');
                        item.className = `encyclopedia-item ${isDiscovered ? '' : 'locked'}`;
                        item.innerHTML = `
                            <div class="encyclopedia-item-image" style="background: ${isDiscovered ? getCocktailColor(cocktail.ingredients) : '#333'}">
                                ${isDiscovered ? '🍸' : '❓'}
                            </div>
                            <div class="encyclopedia-item-name">${isDiscovered ? cocktail.name : '？？？'}</div>
                        `;
                        if (isDiscovered) {
                            item.onclick = () => showCocktailDetail(cocktail);
                        }
                        grid.appendChild(item);
                    });

                    progress.textContent = `Discovered: ${state.discoveredCocktails.length} / ${cocktails.length}`;
                    overlay.classList.add('active');
                }
                function closeCocktailEncyclopedia() {
                    document.getElementById('cocktail-encyclopedia').classList.remove('active');
                }
                function getCocktailColor(ingredients) {
                    const currentLangData = translations[state.language];
                    if (ingredients.length > 0) {
                        const ing = currentLangData.INGREDIENTS[ingredients[0]];
                        return ing ? ing.color : '#666';
                    }
                    return '#666';
                }
                function showCocktailDetail(cocktail) {
                    const modal = document.getElementById('detail-modal');
                    const currentLangData = translations[state.language];
                    document.getElementById('detail-image').style.display = 'none';
                    document.getElementById('detail-name').textContent = cocktail.name;
                    const ingredientNames = cocktail.ingredients.map(i => currentLangData.INGREDIENTS[i]?.name || i).join(', ');
                    const glassName = cocktail.glass === 'collins' ? 'Collins Glass' : cocktail.glass === 'rocks' ? 'Rocks Glass' : 'Cocktail Glass';
                    document.getElementById('detail-info').innerHTML = `
                        <p><strong>Ingredients:</strong> ${ingredientNames}</p>
                        <p><strong>Glass:</strong> ${glassName}</p>
                        <p><strong>Ice:</strong> ${cocktail.needsIce ? 'Required' : 'Not Required'}</p>
                    `;
                    modal.classList.add('active');
                }

                // --- Customer Encyclopedia ---
                function openCustomerEncyclopedia() {
                    closeMenu();
                    const overlay = document.getElementById('customer-encyclopedia');
                    const grid = document.getElementById('customer-grid');
                    const progress = document.getElementById('customer-progress');
                    const currentLangData = translations[state.language];
                    const allCustomers = currentLangData.CUSTOMERS;

                    grid.innerHTML = '';
                    allCustomers.forEach(customer => {
                        const isMet = state.metCustomers.includes(customer.name);
                        const item = document.createElement('div');
                        item.className = `encyclopedia-item ${isMet ? '' : 'locked'}`;
                        item.innerHTML = `
                            <img class="encyclopedia-item-image" src="${isMet ? customer.image : ''}" 
                                 style="${isMet ? '' : 'background:#333'}" 
                                 onerror="this.style.background='#333';this.src=''">
                            <div class="encyclopedia-item-name">${isMet ? customer.name : '？？？'}</div>
                        `;
                        if (isMet) {
                            item.onclick = () => showCustomerDetail(customer);
                        }
                        grid.appendChild(item);
                    });

                    progress.textContent = `Met: ${state.metCustomers.length} / ${allCustomers.length}`;
                    overlay.classList.add('active');
                }
                function closeCustomerEncyclopedia() {
                    document.getElementById('customer-encyclopedia').classList.remove('active');
                }
                function showCustomerDetail(customer) {
                    const modal = document.getElementById('detail-modal');
                    document.getElementById('detail-image').src = customer.image;
                    document.getElementById('detail-image').style.display = 'block';
                    document.getElementById('detail-name').textContent = customer.name;
                    const quote = customer.quotes.order[0] || '';
                    document.getElementById('detail-info').innerHTML = `
                        <p>「${quote}」</p>
                    `;
                    modal.classList.add('active');
                }
                function closeDetailModal() {
                    document.getElementById('detail-modal').classList.remove('active');
                }

                // --- Title System ---
                function openTitleList() {
                    closeMenu();
                    const overlay = document.getElementById('title-overlay');
                    const grid = document.getElementById('title-grid');
                    const currentDisplay = document.getElementById('title-current');

                    const currentTitleObj = TITLES.find(t => t.id === state.currentTitle);
                    const titleName = state.language === 'ja' ? (currentTitleObj?.name || 'Apprentice Bartender') : (currentTitleObj?.nameEn || 'Apprentice Bartender');
                    const labelText = state.language === 'ja' ? 'Current Title:' : 'Current Title:';
                    currentDisplay.textContent = `${labelText} ${titleName}`;

                    grid.innerHTML = '';
                    TITLES.forEach(title => {
                        const isUnlocked = state.unlockedTitles?.includes(title.id) || title.id === 'beginner';
                        const isCurrent = state.currentTitle === title.id;
                        const displayName = state.language === 'ja' ? title.name : title.nameEn;
                        const item = document.createElement('div');
                        item.className = `encyclopedia-item ${isUnlocked ? '' : 'locked'}`;
                        item.style.border = isCurrent ? '2px solid #ec4899' : '';
                        item.innerHTML = `
                            <div class="encyclopedia-item-image" style="font-size:3rem">
                                ${isUnlocked ? title.icon : '🔒'}
                            </div>
                            <div class="encyclopedia-item-name">${isUnlocked ? displayName : '？？？'}</div>
                        `;
                        grid.appendChild(item);
                    });

                    overlay.classList.add('active');
                }
                function closeTitleList() {
                    document.getElementById('title-overlay').classList.remove('active');
                }
                function checkTitles() {
                    if (!state.unlockedTitles) state.unlockedTitles = ['beginner'];
                    let newTitle = null;
                    TITLES.forEach(title => {
                        if (!state.unlockedTitles.includes(title.id) && title.condition()) {
                            state.unlockedTitles.push(title.id);
                            newTitle = title;
                            state.currentTitle = title.id;
                        }
                    });
                    if (newTitle) {
                        showTitleCelebration(newTitle);
                    }
                    updateTitleDisplay();
                }
                function showTitleCelebration(title) {
                    const displayName = state.language === 'ja' ? title.name : title.nameEn;
                    document.getElementById('celebration-title-name').textContent = title.icon + ' ' + displayName;
                    document.getElementById('title-celebration').classList.add('active');
                }
                function closeTitleCelebration() {
                    document.getElementById('title-celebration').classList.remove('active');
                }
                function updateTitleDisplay() {
                    const titleEl = document.getElementById('title-display');
                    if (titleEl) {
                        const currentTitleObj = TITLES.find(t => t.id === state.currentTitle);
                        const displayName = state.language === 'ja' ? (currentTitleObj?.name || '見習いバーテンダー') : (currentTitleObj?.nameEn || 'Apprentice Bartender');
                        titleEl.textContent = currentTitleObj ? currentTitleObj.icon + ' ' + displayName : '🌱 ' + (state.language === 'ja' ? '見習いバーテンダー' : 'Apprentice Bartender');
                    }
                }

                // --- Market System ---
                function openMarket() {
                    const overlay = document.getElementById('market-overlay');
                    const grid = document.getElementById('market-grid');
                    const moneyDisplay = document.getElementById('market-money');
                    const currentLangData = translations[state.language];
                    const ingredients = currentLangData.INGREDIENTS;

                    moneyDisplay.textContent = state.totalMoney;
                    grid.innerHTML = '';

                    Object.keys(ingredients).forEach(key => {
                        const ing = ingredients[key];
                        const price = INGREDIENT_PRICES[key] || 100;
                        const isOwned = state.ownedIngredients.includes(key);
                        const canAfford = state.totalMoney >= price;

                        const item = document.createElement('div');
                        item.className = `market-item ${isOwned ? 'owned' : canAfford ? 'affordable' : 'too-expensive'}`;
                        const ownedText = state.language === 'ja' ? '✓ 所持' : '✓ Owned';
                        item.innerHTML = `
                            <div class="market-item-color" style="background: ${ing.color}"></div>
                            <div class="market-item-name">${ing.name}</div>
                            ${isOwned ? `<div class="market-item-owned">${ownedText}</div>` : `<div class="market-item-price">¥${price}</div>`}
                        `;
                        if (!isOwned && canAfford) {
                            item.onclick = () => buyIngredient(key, price);
                        }
                        grid.appendChild(item);
                    });

                    overlay.classList.add('active');
                }
                function closeMarket() {
                    document.getElementById('market-overlay').classList.remove('active');
                }
                function buyIngredient(key, price) {
                    if (state.totalMoney >= price && !state.ownedIngredients.includes(key)) {
                        state.totalMoney -= price;
                        state.ownedIngredients.push(key);
                        playSound('cash');
                        openMarket(); // Refresh
                        saveGameData();
                    }
                }

                // --- Save/Load System ---
                function saveGameData() {
                    const saveData = {
                        totalMoney: state.totalMoney,
                        day: state.day,
                        ownedIngredients: state.ownedIngredients,
                        discoveredCocktails: state.discoveredCocktails,
                        metCustomers: state.metCustomers,
                        currentTitle: state.currentTitle,
                        unlockedTitles: state.unlockedTitles || ['beginner'],
                        totalTalks: state.totalTalks,
                        upgrades: state.upgrades
                    };
                    localStorage.setItem('bartenderSaveData', JSON.stringify(saveData));
                }
                function loadGameData() {
                    const saved = localStorage.getItem('bartenderSaveData');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            state.totalMoney = data.totalMoney || 0;
                            state.day = data.day || 1;
                            state.ownedIngredients = data.ownedIngredients || [...STARTER_INGREDIENTS];
                            state.discoveredCocktails = data.discoveredCocktails || [];
                            state.metCustomers = data.metCustomers || [];
                            state.currentTitle = data.currentTitle || 'beginner';
                            state.unlockedTitles = data.unlockedTitles || ['beginner'];
                            state.totalTalks = data.totalTalks || 0;
                            if (data.upgrades) state.upgrades = data.upgrades;
                        } catch (e) { console.error('Load error:', e); }
                    }
                }

                // --- Record Functions (called during gameplay) ---
                function recordCocktailDiscovery(cocktailName) {
                    if (!state.discoveredCocktails.includes(cocktailName)) {
                        state.discoveredCocktails.push(cocktailName);
                        saveGameData();
                    }
                }
                function recordCustomerMet(customerName) {
                    if (!state.metCustomers.includes(customerName)) {
                        state.metCustomers.push(customerName);
                        saveGameData();
                    }
                }
                function recordTalk() {
                    state.totalTalks++;
                    saveGameData();
                }

                // --- Menu Button Visibility ---
                function showMenuButton() {
                    document.getElementById('menu-button').classList.add('visible');
                }
                function hideMenuButton() {
                    document.getElementById('menu-button').classList.remove('visible');
                }

                // --- Bind Menu Button ---
                document.getElementById('menu-button').addEventListener('click', openMenu);

                // --- Make functions globally accessible ---
                window.openCocktailEncyclopedia = openCocktailEncyclopedia;
                window.closeCocktailEncyclopedia = closeCocktailEncyclopedia;
                window.openCustomerEncyclopedia = openCustomerEncyclopedia;
                window.closeCustomerEncyclopedia = closeCustomerEncyclopedia;
                window.openTitleList = openTitleList;
                window.closeTitleList = closeTitleList;
                window.closeMenu = closeMenu;
                window.openMarket = openMarket;
                window.closeMarket = closeMarket;
                window.closeDetailModal = closeDetailModal;
                window.closeTitleCelebration = closeTitleCelebration;

                function returnToTitle() {
                    const msg = 'Return to Title?\n(Unsaved progress may be lost)';
                    if (confirm(msg)) {
                        location.reload();
                    }
                }
                window.returnToTitle = returnToTitle;

                // Load saved data on init
                loadGameData();

                // ===== PHASE 2: WEATHER, DRUNK, ANIMATIONS =====

                // --- Weather System ---
                // --- Weather System (Real API Integration) ---
                async function fetchRealWeather() {
                    try {
                        // Default to Tokyo if geolocation fails
                        let lat = 35.6895;
                        let lon = 139.6917;

                        // Try to get user location
                        try {
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 3000 });
                            });
                            lat = position.coords.latitude;
                            lon = position.coords.longitude;
                        } catch (e) {
                            console.log("Location access denied or timeout, using default (Tokyo).");
                        }

                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const data = await response.json();
                        const code = data.current_weather.weathercode;

                        // Map WMO codes to game weather
                        // 0-3: Sunny/Cloudy, 45-48: Fog, 51-67: Rain, 71-77: Snow, 80-82: Rain Showers, 85-86: Snow Showers, 95-99: Thunderstorm
                        if (code >= 71 && code <= 77 || code === 85 || code === 86) {
                            return 'snowy';
                        } else if (code >= 51 || code >= 80 || code >= 95) {
                            return 'rainy';
                        } else {
                            return 'sunny';
                        }
                    } catch (e) {
                        console.error("Weather API failed:", e);
                        return null; // Fallback to random
                    }
                }

                async function setRandomWeather() {
                    // 1. Try Real Weather first
                    const realWeather = await fetchRealWeather();

                    if (realWeather) {
                        state.currentWeather = realWeather;
                        // Notification for Real Weather
                        const msg = `Synced with local weather: ${state.currentWeather}`;
                        showFloatingText(msg, '#60a5fa', dom.gameContainerEl);
                    } else {
                        // 2. Fallback to Random
                        const weathers = ['sunny', 'sunny', 'sunny', 'rainy', 'snowy'];
                        state.currentWeather = weathers[Math.floor(Math.random() * weathers.length)];
                    }

                    updateWeatherDisplay();
                    createWeatherEffects();
                }

                function updateWeatherDisplay() {
                    const indicator = document.getElementById('weather-indicator');
                    if (!indicator) return;
                    const weatherData = {
                        sunny: { icon: '☀️', name: 'Sunny' },
                        rainy: { icon: '🌧️', name: 'Rainy' },
                        snowy: { icon: '❄️', name: 'Snowy' }
                    };
                    const w = weatherData[state.currentWeather] || weatherData.sunny;
                    indicator.textContent = `${w.icon} ${w.name}`;
                }

                function createWeatherEffects() {
                    const overlay = document.getElementById('weather-overlay');
                    if (!overlay) return;
                    overlay.innerHTML = '';
                    overlay.className = '';

                    if (state.currentWeather === 'rainy') {
                        overlay.classList.add('weather-rain');
                        for (let i = 0; i < 50; i++) {
                            const drop = document.createElement('div');
                            drop.className = 'rain-drop';
                            drop.style.left = Math.random() * 100 + '%';
                            drop.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                            drop.style.animationDelay = Math.random() * 2 + 's';
                            overlay.appendChild(drop);
                        }
                    } else if (state.currentWeather === 'snowy') {
                        overlay.classList.add('weather-snow');
                        for (let i = 0; i < 30; i++) {
                            const flake = document.createElement('div');
                            flake.className = 'snow-flake';
                            flake.style.left = Math.random() * 100 + '%';
                            flake.style.animationDuration = (3 + Math.random() * 4) + 's';
                            flake.style.animationDelay = Math.random() * 5 + 's';
                            flake.style.width = (4 + Math.random() * 6) + 'px';
                            flake.style.height = flake.style.width;
                            overlay.appendChild(flake);
                        }
                    }
                }

                function getWeatherTipMultiplier() {
                    if (state.currentWeather === 'rainy') return 1.5;
                    return 1;
                }

                // --- Seasonal Events ---
                function checkSeasonalEvent() {
                    const banner = document.getElementById('event-banner');
                    const container = document.getElementById('game-container');
                    if (!banner || !container) return;

                    state.currentEvent = null;
                    banner.classList.remove('active');
                    container.classList.remove('event-summer', 'event-christmas');

                    if (state.day === 4) {
                        state.currentEvent = 'summer';
                        banner.textContent = '🎆 Summer Festival!';
                        banner.classList.add('active');
                        container.classList.add('event-summer');
                    } else if (state.day === 6) {
                        state.currentEvent = 'christmas';
                        banner.textContent = '🎄 Christmas Event!';
                        banner.classList.add('active');
                        container.classList.add('event-christmas');
                    }
                }

                function getEventMultiplier() {
                    if (state.currentEvent === 'christmas') return 2;
                    return 1;
                }

                // --- Drunk System ---
                function addDrunkLevel(alcoholAmount) {
                    state.customerDrunkLevel += alcoholAmount * 2; // Alcohol adds to drunk level
                    updateDrunkMeter();
                    updateDrunkVisuals();
                }

                function updateDrunkMeter() {
                    const fill = document.getElementById('drunk-meter-fill');
                    if (!fill) return;
                    fill.style.width = Math.min(state.customerDrunkLevel, 100) + '%';
                }

                function updateDrunkVisuals() {
                    const dialogue = document.getElementById('customer-dialogue');
                    const customer = document.getElementById('customer');
                    if (!dialogue || !customer) return;

                    dialogue.classList.remove('drunk-text');
                    customer.classList.remove('customer-passed-out', 'drunk-heavy');

                    if (state.customerDrunkLevel >= 100) {
                        customer.classList.add('customer-passed-out');
                    } else if (state.customerDrunkLevel >= 60) {
                        dialogue.classList.add('drunk-text');
                        customer.parentElement.classList.add('drunk-heavy');
                    } else if (state.customerDrunkLevel >= 30) {
                        dialogue.classList.add('drunk-text');
                    }
                }

                function slurText(text) {
                    if (state.customerDrunkLevel < 30) return text;

                    // Simple English drunk effects
                    let result = text;
                    if (state.customerDrunkLevel >= 30) {
                        result = result.replace(/s/g, 'sh').replace(/S/g, 'Sh');
                    }
                    if (state.customerDrunkLevel >= 60) {
                        result = result.replace(/\./g, '... hic!');
                    }
                    if (state.customerDrunkLevel >= 80) {
                        result = 'Whaa... ' + result + '... urgh...';
                    }
                    return result;
                }

                function isCustomerPassedOut() {
                    return state.customerDrunkLevel >= 100;
                }

                function resetDrunkLevel() {
                    state.customerDrunkLevel = 0;
                    updateDrunkMeter();
                    updateDrunkVisuals();
                }

                function checkMysteryTime() {
                    const hour = new Date().getHours();
                    // Mystery Hour: 0:00 to 3:59
                    const isMystery = (hour >= 0 && hour < 4);

                    state.isMysteryMode = isMystery;
                    const body = document.body;

                    if (isMystery) {
                        body.classList.add('mystery-mode');
                        if (dom.bgmAudioEl) dom.bgmAudioEl.pause(); // Stop BGM
                        showFloatingText("The Witching Hour...", "#ff0000", dom.gameContainerEl);
                    } else {
                        body.classList.remove('mystery-mode');
                        // BGM will be handled by regular logic
                    }
                }



                // --- Sparkle Animation ---
                function createSparkles(targetElement) {
                    if (!targetElement) return;

                    const container = document.createElement('div');
                    container.className = 'sparkle-container';
                    targetElement.appendChild(container);

                    for (let i = 0; i < 12; i++) {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'sparkle';
                        const angle = (i / 12) * Math.PI * 2;
                        const distance = 30 + Math.random() * 30;
                        sparkle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                        sparkle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                        sparkle.style.left = '50%';
                        sparkle.style.top = '50%';
                        sparkle.style.animationDelay = (i * 0.05) + 's';
                        container.appendChild(sparkle);
                    }

                    // Remove after animation
                    setTimeout(() => container.remove(), 1500);
                }

                // --- Liquid Wave Animation ---
                function addLiquidWaveEffect() {
                    const contents = document.getElementById('shaker-contents');
                    if (!contents || !contents.querySelector('.shaker-liquid-wave')) {
                        const wave = document.createElement('div');
                        wave.className = 'shaker-liquid-wave';
                        if (contents) contents.appendChild(wave);
                    }
                }

                function removeLiquidWaveEffect() {
                    const wave = document.querySelector('.shaker-liquid-wave');
                    if (wave) wave.remove();
                }

                // ===========================================
                // GESTURE & PHOTO FEATURES (Restored)
                // ===========================================
                // (Gesture logic exists around line 3800)

                // --- Photo Mode Functions ---
                window.openPhotoMode = function () {
                    document.body.classList.add('photo-mode');
                    setTimeout(() => {
                        html2canvas(document.getElementById('game-container'), {
                            backgroundColor: null,
                            scale: 2
                        }).then(canvas => {
                            document.body.classList.remove('photo-mode');
                            const photoCanvas = document.getElementById('photo-canvas');
                            const ctx = photoCanvas.getContext('2d');
                            photoCanvas.width = canvas.width;
                            photoCanvas.height = canvas.height;
                            ctx.drawImage(canvas, 0, 0);

                            // Watermark
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.font = '24px "Noto Serif JP", serif';
                            ctx.fillText('🍸 Bartender Game', 20, canvas.height - 20);

                            document.getElementById('photo-mode-overlay').classList.remove('hidden');
                        }).catch(err => {
                            document.body.classList.remove('photo-mode');
                            console.error(err);
                            alert('Photo capture failed');
                        });
                    }, 200);
                };

                window.closePhotoMode = function () {
                    document.getElementById('photo-mode-overlay').classList.add('hidden');
                };

                window.downloadPhoto = function () {
                    const canvas = document.getElementById('photo-canvas');
                    const link = document.createElement('a');
                    link.download = `bartender-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                };

                window.shareToTwitter = function () {
                    const text = encodeURIComponent("Made a cocktail in Bartender Game! 🍸 #BartenderGame");
                    window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
                };

                // ===========================================
                // JUKEBOX FEATURE
                // ===========================================
                let BGM_TRACKS = [];

                async function fetchBGMList() {
                    // 外部サーバーへの依存を減らし、ローカルのジュークボックスフォルダ内の曲を優先します
                    BGM_TRACKS = [
                        { id: 'skyline_serenity', name: '🏙️ Skyline Serenity', src: 'jukebox/Skyline_Serenity.mp3', icon: '🏙️' },
                        { id: 'standard_jazz', name: '🍸 Standard Jazz', src: 'jukebox/standard_jazz.mp3', icon: '🎷' },
                        { id: 'barcarolle', name: '🌙 Barcarolle of the Blue Moonlit Night', src: 'jukebox/Barcarolle of the Blue Moonlit Night.mp3', icon: '🎻' },

                        { id: 'coffee_break', name: '☕ Coffee Break', src: 'jukebox/Coffee_Break.mp3', icon: '☕' },
                        { id: 'whisky_nights', name: '🥃 Whisky Nights', src: 'jukebox/Whisky_Nights.mp3', icon: '🥃' },
                        { id: 'winter_night', name: '❄️ Winter Night Street', src: 'jukebox/Winter_Night_Street.mp3', icon: '❄️' }
                    ];

                    try {
                        const response = await fetch('http://localhost:3000/api/music');
                        if (response.ok) {
                            const tracks = await response.json();
                            if (tracks && tracks.length > 0) {
                                BGM_TRACKS = tracks.map(t => ({
                                    id: t.id,
                                    name: t.name,
                                    src: t.src,
                                    icon: t.icon || '🎵'
                                }));
                            }
                        }
                    } catch (e) {
                        console.log('Using local BGM list.');
                    }

                    // ゲーム開始時のBGMを設定 (再生は待機)
                    if (!state.interior.bgm) {
                        state.interior.bgm = BGM_TRACKS[0].id; // Defaults to skyline_serenity
                    }
                    applyBGM(state.interior.bgm, false); // false = Don't play immediately
                }

                function openJukebox() {
                    const listEl = document.getElementById('jukebox-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';

                    const currentId = state.interior.bgm || 'jazz';

                    BGM_TRACKS.forEach(track => {
                        const div = document.createElement('div');
                        div.className = `jukebox-track ${track.id === currentId ? 'active' : ''}`;
                        div.onclick = () => changeBGM(track.id);
                        div.innerHTML = `
                            <span class="icon">${track.icon}</span>
                            <div class="info">
                                <div class="title">${track.name}</div>
                            </div>
                            ${track.id === currentId ? '<span class="text-indigo-400 text-xl">▶</span>' : ''}
                        `;
                        listEl.appendChild(div);
                    });

                    const currentTrack = BGM_TRACKS.find(t => t.id === currentId);
                    const nameEl = document.getElementById('current-bgm-name');
                    if (nameEl) nameEl.textContent = currentTrack ? currentTrack.name : 'Unknown';

                    document.getElementById('jukebox-overlay').classList.remove('hidden');
                }

                function closeJukebox() {
                    document.getElementById('jukebox-overlay').classList.add('hidden');
                }

                window.openJukebox = openJukebox;
                window.closeJukebox = closeJukebox;

                function applyBGM(trackId, shouldPlay = true) {
                    const track = BGM_TRACKS.find(t => t.id === trackId);
                    if (!track) return;

                    const audioEl = dom.bgmAudioEl;
                    if (audioEl) {
                        // Only change src if different to avoid reloading if already set
                        if (audioEl.getAttribute('src') !== track.src) {
                            audioEl.src = track.src;
                        }
                        audioEl.loop = true;

                        // FIX: Play if game-overlay IS hidden (Game is active)
                        const isGameActive = document.getElementById('game-overlay').classList.contains('hidden');

                        if (shouldPlay && !state.isMysteryMode && isGameActive) {
                            audioEl.play().catch(e => console.log('Playback failed:', e));
                        } else if (!shouldPlay) {
                            audioEl.pause();
                        }
                    }
                }

                function changeBGM(trackId) {
                    const track = BGM_TRACKS.find(t => t.id === trackId);
                    if (!track) return;

                    state.interior.bgm = trackId;
                    state.ownedInterior.bgm = [trackId];
                    saveGameData();

                    applyBGM(trackId, true);
                    openJukebox();
                    showFloatingText(`🎵 BGM: ${track.name}`, '#8b5cf6', dom.gameContainerEl);
                }


                // (Jukebox logic exists above)


                function openInquiry() {
                    document.getElementById('inquiry-overlay').classList.remove('hidden');
                    closeMenu();
                }

                function closeInquiry() {
                    document.getElementById('inquiry-overlay').classList.add('hidden');
                }

                async function submitInquiry() {
                    const type = document.getElementById('inquiry-type').value;
                    const message = document.getElementById('inquiry-message').value;
                    const btn = document.getElementById('inquiry-submit-btn');
                    const status = document.getElementById('inquiry-status');

                    if (!message) return alert('Please enter a message');

                    btn.disabled = true;
                    status.classList.remove('hidden');
                    status.textContent = '🕊️ Preparing carrier pigeon...';
                    status.className = "mt-4 text-center text-yellow-400";

                    try {
                        const response = await fetch('http://localhost:3000/api/report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type, message, sender: 'Player' })
                        });

                        if (response.ok) {
                            status.textContent = '✉️ Sent! The pigeon has flown.';
                            status.className = "mt-4 text-center text-green-400";
                            setTimeout(() => {
                                closeInquiry();
                                document.getElementById('inquiry-message').value = '';
                                btn.disabled = false;
                                status.classList.add('hidden');
                            }, 2000);
                        } else {
                            throw new Error('Server error');
                        }
                    } catch (e) {
                        status.textContent = '❌ Failed. The pigeon got lost.';
                        status.className = "mt-4 text-center text-red-400";
                        btn.disabled = false;
                    }
                }

                window.openInquiry = openInquiry;
                window.closeInquiry = closeInquiry;
                window.submitInquiry = submitInquiry;

                // ===========================================
                // VEGETABLE MARKET & COLLECTION LOGIC
                // ===========================================

                // Defined Vegetable List based on images/vegetable/ content (19 items)
                // Defined Vegetable List based on images/vegetable/ content (19 items)
                const VEGETABLE_ASSETS = [
                    { file: 'tomato.png', name: 'Tomato', price: 120, tags: ['red', 'vegetable'] },
                    { file: 'cherry_tomato.png', name: 'Cherry Tomato', price: 90, tags: ['red', 'vegetable', 'small'] },
                    { file: 'potato.png', name: 'Potato', price: 80, tags: ['root', 'vegetable'] },
                    { file: 'carrot.png', name: 'Carrot', price: 100, tags: ['red', 'root', 'vegetable'] },
                    { file: 'onion.png', name: 'Onion', price: 80, tags: ['root', 'vegetable', 'pungent'] },
                    { file: 'green_onion.png', name: 'Green Onion', price: 110, tags: ['green', 'vegetable', 'pungent'] },
                    { file: 'eggplant.png', name: 'Eggplant', price: 130, tags: ['purple', 'vegetable'] },
                    { file: 'asparagus.png', name: 'Asparagus', price: 200, tags: ['green', 'vegetable'] },
                    { file: 'broccoli.png', name: 'Broccoli', price: 150, tags: ['green', 'vegetable'] },
                    { file: 'cabbage.png', name: 'Cabbage', price: 180, tags: ['green', 'vegetable'] },
                    { file: 'cauliflower.png', name: 'Cauliflower', price: 190, tags: ['white', 'vegetable'] },
                    { file: 'chili_pepper.png', name: 'Chili Pepper', price: 140, tags: ['red', 'spicy', 'vegetable'] },
                    { file: 'corn.png', name: 'Corn', price: 160, tags: ['yellow', 'sweet', 'vegetable'] },
                    { file: 'daikon.png', name: 'Radish', price: 150, tags: ['white', 'root', 'vegetable'] },
                    { file: 'napa_cabbage.png', name: 'Napa Cabbage', price: 180, tags: ['green', 'vegetable'] },
                    { file: 'paprika.png', name: 'Paprika', price: 170, tags: ['red', 'vegetable', 'colorful'] },
                    { file: 'pumpkin.png', name: 'Pumpkin', price: 250, tags: ['yellow', 'sweet', 'vegetable'] },
                    { file: 'sweet_potato.png', name: 'Sweet Potato', price: 130, tags: ['purple', 'sweet', 'root'] },
                    { file: '33.png', name: 'Mystery Veg', price: 500, tags: ['mystery', 'rare'] }
                ];

                const VEGETABLE_DATA = VEGETABLE_ASSETS.map((item, index) => ({
                    id: index + 1,
                    src: `images/vegetable/${item.file}`,
                    name: item.name,
                    basePrice: item.price,
                    tags: item.tags
                }));

                function openCollection() {
                    const grid = document.getElementById('vegetable-grid');
                    grid.innerHTML = '';

                    if (!state.vegetableCollection) state.vegetableCollection = [];

                    document.getElementById('collection-count').textContent = state.vegetableCollection.length;

                    VEGETABLE_DATA.forEach(veg => {
                        const isOwned = state.vegetableCollection.includes(veg.id);
                        const el = document.createElement('div');
                        el.className = `harvest-item ${isOwned ? 'owned' : 'locked'}`;
                        el.title = veg.name;

                        let innerHTML = `<img src="${veg.src}">`;
                        if (isOwned) {
                            innerHTML += `<div class="absolute bottom-0 w-full text-center bg-black/50 text-[10px] text-white font-jp truncate px-1">${veg.name}</div>`;
                        } else {
                            innerHTML += `<div class="absolute bottom-0 w-full text-center text-[10px] text-gray-500 font-jp">???</div>`;
                        }

                        el.innerHTML = innerHTML;
                        grid.appendChild(el);
                    });

                    document.getElementById('collection-overlay').classList.remove('hidden');
                    closeMenu();
                }

                function closeCollection() {
                    document.getElementById('collection-overlay').classList.add('hidden');
                    document.getElementById('menu-overlay').classList.remove('hidden');
                }

                // Market Functions
                let currentMarketStock = [];
                let marketMode = 'buy'; // 'buy' or 'sell'

                function setMarketMode(mode) {
                    marketMode = mode;

                    // UI Update
                    const btnBuy = document.getElementById('market-btn-buy');
                    const btnSell = document.getElementById('market-btn-sell');

                    if (mode === 'buy') {
                        btnBuy.className = "px-4 py-1 rounded bg-green-600 text-white font-bold font-jp border-2 border-green-400 shadow-lg scale-105 transition-all";
                        btnSell.className = "px-4 py-1 rounded bg-gray-700 text-gray-400 font-bold font-jp border-2 border-gray-600 hover:bg-red-900/50 hover:text-red-200 hover:border-red-800 transition-all";
                    } else {
                        btnBuy.className = "px-4 py-1 rounded bg-gray-700 text-gray-400 font-bold font-jp border-2 border-gray-600 hover:bg-green-900/50 hover:text-green-200 hover:border-green-800 transition-all";
                        btnSell.className = "px-4 py-1 rounded bg-red-600 text-white font-bold font-jp border-2 border-red-400 shadow-lg scale-105 transition-all";
                    }

                    renderMarket();
                }

                function openMarketOverlay() {
                    // 1. Check Opening Hours (08:00 - 19:00)
                    const now = new Date();
                    const hour = now.getHours();
                    if (hour < 8 || hour >= 19) {
                        alert("Market is closed.\nOpen Hours: 8:00 - 19:00");
                        return;
                    }

                    document.getElementById('collection-overlay').classList.add('hidden');
                    document.getElementById('vegetable-market-overlay').classList.remove('hidden');

                    document.getElementById('vegetable-market-money-display').textContent = state.totalMoney.toLocaleString();

                    // 2. Check Daily Restock
                    const today = new Date().toLocaleDateString();
                    if (state.lastRestockDate !== today) {
                        restockMarket(today);
                    } else if (!state.marketStock || state.marketStock.length === 0) {
                        restockMarket(today); // Fallback if missing
                    } else {
                        // Load saved stock
                        currentMarketStock = state.marketStock;
                        renderMarket();
                    }
                }

                function closeMarketOverlay() {
                    document.getElementById('vegetable-market-overlay').classList.add('hidden');
                    openCollection();
                }

                function restockMarket(todayDate) {
                    // Pick 8 random items
                    currentMarketStock = [];
                    const pool = [...VEGETABLE_DATA];

                    for (let i = 0; i < 8; i++) {
                        if (pool.length === 0) break;
                        const idx = Math.floor(Math.random() * pool.length);
                        const item = pool.splice(idx, 1)[0];

                        // Fluctuating Price (80% - 150%)
                        const multiplier = 0.8 + (Math.random() * 0.7);
                        const price = Math.floor(item.basePrice * multiplier);

                        currentMarketStock.push({ ...item, currentPrice: price });
                    }

                    // Save State
                    state.marketStock = currentMarketStock;
                    state.lastRestockDate = todayDate || new Date().toLocaleDateString();
                    saveGameData();

                    renderMarket();
                }

                function renderMarket() {
                    const grid = document.getElementById('vegetable-market-grid');
                    grid.innerHTML = '';

                    if (marketMode === 'buy') {
                        // === BUY MODE ===
                        currentMarketStock.forEach(item => {
                            const isOwned = state.vegetableCollection && state.vegetableCollection.includes(item.id);

                            const el = document.createElement('div');
                            el.className = 'market-grid-item bg-[#5d4037]';

                            el.innerHTML = `
                                <div class="h-24 w-24 bg-black/20 rounded-full flex items-center justify-center mb-2">
                                    <img src="${item.src}" class="h-20 w-20 object-contain drop-shadow-md">
                                </div>
                                <div class="text-white font-bold font-jp text-lg">${item.name}</div>
                                <div class="market-price-tag">¥${item.currentPrice}</div>
                                <button onclick="buyVegetable(${item.id}, ${item.currentPrice})" 
                                    class="mt-2 w-full py-1 rounded font-bold text-sm transition-colors ${isOwned
                                    ? 'bg-gray-500 text-gray-300 cursor-not-allowed'
                                    : 'bg-green-600 hover:bg-green-500 text-white'
                                }" ${isOwned ? 'disabled' : ''}>
                                    ${isOwned ? 'Owned' : 'Buy'}
                                </button>
                            `;
                            grid.appendChild(el);
                        });
                    } else {
                        // === SELL MODE ===
                        // Display items user owns
                        const userItems = VEGETABLE_DATA.filter(v => state.vegetableCollection.includes(v.id));

                        if (userItems.length === 0) {
                            grid.innerHTML = '<div class="col-span-full text-center text-gray-400 font-jp py-8">No vegetables to sell</div>';
                            return;
                        }

                        // Daily Market Fluctuation for Selling
                        // We use the date string hash to make it deterministic per day per item if we wanted, 
                        // but simple randomization seeded by date is hard in JS without lib. 
                        // Let's just use a global daily multiplier generated in restockMarket?
                        // Actually, let's just generate a Sell Price on fly but keep it consistent? 
                        // For simplicity MVP: Sell Price = Base Price * 0.5 (Standard) + Random Daily logic?
                        // To make it fun, we need high variance.

                        // Let's use the currentMarketStock pricing if the item is "In Season" (in stock)?
                        // Idea: If item is in Market Stock today, Sell Price is higher!
                        // Else: Low base price.

                        userItems.forEach(item => {
                            // Determine Sell Price
                            const inStock = currentMarketStock.find(s => s.id === item.id);
                            let sellPrice = 0;
                            let priceLabel = "";
                            let tagClass = "bg-gray-500";

                            if (inStock) {
                                // "In Demand" - Sell for 80% of current Buy Price (Good deal usually)
                                sellPrice = Math.floor(inStock.currentPrice * 0.9);
                                priceLabel = "🔥High Demand";
                                tagClass = "bg-red-500 animate-pulse";
                            } else {
                                // Standard - Sell for 30-40% of Base
                                sellPrice = Math.floor(item.basePrice * 0.4);
                                tagClass = "bg-blue-500";
                            }

                            const el = document.createElement('div');
                            el.className = 'market-grid-item bg-[#3e2723] border-red-900/50'; // Darker for sell

                            el.innerHTML = `
                                <div class="h-24 w-24 bg-black/20 rounded-full flex items-center justify-center mb-2 relative">
                                    <img src="${item.src}" class="h-20 w-20 object-contain drop-shadow-md">
                                    ${priceLabel ? `<div class="absolute -top-2 -right-2 text-[10px] bg-yellow-500 text-black font-bold px-2 py-0.5 rounded-full shadow-md animate-bounce">${priceLabel}</div>` : ''}
                                </div>
                                <div class="text-white font-bold font-jp text-lg">${item.name}</div>
                                <div class="market-price-tag ${tagClass}">売値: ¥${sellPrice}</div>
                                <button onclick="sellVegetable(${item.id}, ${sellPrice}, '${item.name}')" 
                                    class="mt-2 w-full py-1 rounded font-bold text-sm transition-colors bg-red-700 hover:bg-red-600 text-white">
                                    Sell
                                </button>
                            `;
                            grid.appendChild(el);
                        });
                    }
                }

                function sellVegetable(id, price, name) {
                    if (!confirm(`Sell ${name} for ¥${price}?`)) return;

                    // Remove from collection
                    // Note: collection is array of IDs.
                    const idx = state.vegetableCollection.indexOf(id);
                    if (idx > -1) {
                        state.vegetableCollection.splice(idx, 1);
                        state.totalMoney = (Number(state.totalMoney) || 0) + price;

                        document.getElementById('vegetable-market-money-display').textContent = state.totalMoney.toLocaleString();

                        renderMarket(); // re-render to remove item
                        saveGameData();

                        showFloatingText(`💰 ¥${price} GET!`, '#fbbf24', document.getElementById('vegetable-market-overlay'));
                    }
                }

                function buyVegetable(id, price) {
                    const currentMoney = Number(state.totalMoney) || 0;
                    const cost = Number(price) || 0;

                    if (currentMoney < cost) {
                        alert("Not enough money!");
                        return;
                    }
                    if (state.vegetableCollection.includes(id)) {
                        return; // Should be disabled anyway
                    }

                    // Purchase
                    state.totalMoney = currentMoney - cost;
                    state.vegetableCollection.push(id);
                    document.getElementById('vegetable-market-money-display').textContent = state.totalMoney.toLocaleString();

                    // Update UI
                    renderMarket();
                    saveGameData();

                    // Simple Feedback
                    const veg = VEGETABLE_DATA.find(v => v.id === id);
                    const vegName = veg ? veg.name : 'Vegetable';
                    showFloatingText(`🥬 ${vegName} GET!`, '#4ade80', document.getElementById('vegetable-market-overlay'));
                }

                // Expose
                window.openMarketOverlay = openMarketOverlay;
                window.closeMarketOverlay = closeMarketOverlay;
                window.restockMarket = restockMarket;
                window.setMarketMode = setMarketMode;
                window.buyVegetable = buyVegetable;
                window.sellVegetable = sellVegetable;
                window.openCollection = openCollection;
                window.closeCollection = closeCollection;

                // ===========================================
                // KITCHEN LOGIC
                // ===========================================
                let kitchenSlots = [null, null];
                const SMOOTHIE_RECIPES = [
                    { id: 'S1', name: '🥤 Red Vitamin', ingredients: [1, 4], price: 500, desc: 'Healthy mix of Tomato and Carrot' }, // Tomato + Carrot
                    { id: 'S2', name: '🥤 Green Detox', ingredients: [9, 8], price: 600, desc: 'Strong combo of Broccoli and Asparagus' }, // Broccoli + Asparagus
                    { id: 'S3', name: '🥣 Root Potage', ingredients: [3, 5], price: 450, desc: 'Gentle taste of Potato and Onion' }, // Potato + Onion
                    { id: 'S4', name: '🌽 Golden Soup', ingredients: [13, 17], price: 700, desc: 'Sweet temptation of Corn and Pumpkin' }, // Corn + Pumpkin
                    { id: 'S5', name: '🔥 Spicy Red', ingredients: [12, 16], price: 550, desc: 'Stimulating experience of Chili and Paprika' } // Chili + Paprika
                ];

                function openKitchenOverlay() {
                    document.getElementById('collection-overlay').classList.add('hidden');
                    document.getElementById('vegetable-market-overlay').classList.add('hidden'); // Ensure market is closed
                    document.getElementById('kitchen-overlay').classList.remove('hidden');

                    kitchenSlots = [null, null];
                    updateKitchenUI();
                    renderKitchenInventory();
                }

                function closeKitchenOverlay() {
                    document.getElementById('kitchen-overlay').classList.add('hidden');
                    openCollection(); // Return to collection
                }

                function renderKitchenInventory() {
                    const grid = document.getElementById('kitchen-inventory-grid');
                    grid.innerHTML = '';

                    // Filter: Owned Items AND NOT currently in slots
                    const userItems = VEGETABLE_DATA.filter(v => state.vegetableCollection.includes(v.id));

                    userItems.forEach(item => {
                        // Count how many we have? Logic assumes 1 of each ID for now (Set).
                        // If slots handle consumption, we need to check if used.
                        // Since collection is unique IDs list, if we put "Tomato" in slot, we effectively "hold" it.
                        // Filter out if ID is in slot
                        if (kitchenSlots.includes(item.id)) return;

                        const el = document.createElement('div');
                        el.className = 'bg-gray-800 p-2 rounded cursor-pointer hover:bg-gray-700 border border-gray-600 flex flex-col items-center';
                        el.onclick = () => addToKitchenSlot(item.id);
                        el.innerHTML = `
                            <img src="${item.src}" class="w-10 h-10 object-contain">
                            <span class="text-[10px] text-white font-jp truncate w-full text-center">${item.name}</span>
                        `;
                        grid.appendChild(el);
                    });
                }

                function addToKitchenSlot(id) {
                    if (kitchenSlots[0] === null) kitchenSlots[0] = id;
                    else if (kitchenSlots[1] === null) kitchenSlots[1] = id;
                    else return; // Full

                    updateKitchenUI();
                    renderKitchenInventory();
                }

                function clearKitchenSlot(index) {
                    kitchenSlots[index] = null;
                    updateKitchenUI();
                    renderKitchenInventory();
                }

                function updateKitchenUI() {
                    [0, 1].forEach(i => {
                        const div = document.getElementById(`kitchen-slot-${i + 1}`);
                        const id = kitchenSlots[i];
                        if (id) {
                            const item = VEGETABLE_DATA.find(v => v.id === id);
                            div.innerHTML = `<img src="${item.src}" class="w-16 h-16 object-contain">`;
                            div.classList.replace('border-dashed', 'border-solid');
                            div.classList.add('bg-gray-700');
                        } else {
                            div.innerHTML = `<span class="text-gray-500 text-2xl font-bold">+</span>`;
                            div.classList.replace('border-solid', 'border-dashed');
                            div.classList.remove('bg-gray-700');
                        }
                    });

                    // Check Mix Button
                    const btn = document.getElementById('kitchen-mix-btn');
                    btn.disabled = kitchenSlots[0] === null || kitchenSlots[1] === null;
                }

                function mixSmoothie() {
                    const [id1, id2] = kitchenSlots;

                    // Find Recipe (Order doesn't matter)
                    const recipe = SMOOTHIE_RECIPES.find(r =>
                        (r.ingredients[0] === id1 && r.ingredients[1] === id2) ||
                        (r.ingredients[0] === id2 && r.ingredients[1] === id1)
                    );

                    if (recipe) {
                        // Success!
                        // Remove ingredients? Or keep? Usually crafting consumes.
                        // Logic: Remove IDs from state.vegetableCollection
                        const idx1 = state.vegetableCollection.indexOf(id1);
                        if (idx1 > -1) state.vegetableCollection.splice(idx1, 1);
                        const idx2 = state.vegetableCollection.indexOf(id2);
                        if (idx2 > -1) state.vegetableCollection.splice(idx2, 1);

                        // Add Result to Collection (Special ID)
                        // But wait, our collection logic assumes numeric IDs for vegetables?
                        // If we add "S1", renderMarket/renderCollection might fail if they expect Number or check VEGETABLE_DATA.
                        // We need to add "Smoothies" to VEGETABLE_DATA or handle them separately.
                        // Let's add them to a new state.smoothieStock?
                        if (!state.smoothieStock) state.smoothieStock = [];
                        state.smoothieStock.push(recipe.id);

                        saveGameData();

                        alert(`Success!\n${recipe.name} created!\n"${recipe.desc}"`);

                        kitchenSlots = [null, null];
                        updateKitchenUI();
                        renderKitchenInventory();
                    } else {
                        // Fail
                        alert("Failed...\nDoesn't taste good.\n(Ingredients returned)");
                        kitchenSlots = [null, null];
                        updateKitchenUI();
                        renderKitchenInventory();
                    }
                }

                window.openKitchenOverlay = openKitchenOverlay;
                window.closeKitchenOverlay = closeKitchenOverlay;
                window.addToKitchenSlot = addToKitchenSlot;
                window.clearKitchenSlot = clearKitchenSlot;
                window.mixSmoothie = mixSmoothie;

                // ===========================================
                // GIFTING LOGIC
                // ===========================================

                // Helper to define preferences based on Customer Name
                const GIFT_PREFERENCES = {
                    // Morning
                    "Young Farmer": { likes: ['green', 'vegetable'], dislikes: ['spicy'] },
                    "Elderly Farmer": { likes: ['root', 'soft'], dislikes: ['mystery'] },
                    "Farmer's Daughter": { likes: ['sweet', 'red'], dislikes: ['spicy', 'bitter'] },

                    // Noon
                    "Bald Merchant": { likes: ['gold', 'yellow'], dislikes: ['common'] },
                    "Noble Lady": { likes: ['smoothie', 'colorful'], dislikes: ['root', 'dirt'] },
                    "Town Girl": { likes: ['sweet', 'cute', 'pink'], dislikes: ['bitter'] },
                    "Blacksmith": { likes: ['spicy', 'root'], dislikes: ['sweet'] },

                    // Night
                    "Old Sage": { likes: ['mystery', 'root'], dislikes: ['artificial'] },
                    "Mercenary": { likes: ['spicy', 'meat'], dislikes: ['sweet'] },
                    "King": { likes: ['smoothie', 'rare'], dislikes: ['common'] },
                    "Witch": { likes: ['mystery', 'purple'], dislikes: ['holy'] },
                    "Green Mage": { likes: ['mystery', 'rare', 'smoothie'], dislikes: ['common'] },
                    "Red King": { likes: ['red', 'spicy'], dislikes: ['green'] }
                };

                const DEFAULT_PREFS = { likes: ['vegetable'], dislikes: [] };

                function openGiftMenu() {
                    if (!state.currentCustomer) {
                        alert("No customer!");
                        return;
                    }

                    document.getElementById('gift-overlay').classList.remove('hidden');
                    renderGiftInventory();
                }

                function closeGiftMenu() {
                    document.getElementById('gift-overlay').classList.add('hidden');
                }

                function renderGiftInventory() {
                    const grid = document.getElementById('gift-grid');
                    grid.innerHTML = '';

                    // 1. Vegetables
                    if (state.vegetableCollection) {
                        // Unique counts logic could be useful, but for gifting, simple list is fine. Or grouped.
                        // Let's list individual items so user can give one of many.
                        // Actually, grouped is better for UI.

                        const vegCounts = {};
                        state.vegetableCollection.forEach(id => {
                            vegCounts[id] = (vegCounts[id] || 0) + 1;
                        });

                        Object.keys(vegCounts).forEach(idStr => {
                            const id = parseInt(idStr);
                            const count = vegCounts[id];
                            const data = VEGETABLE_DATA.find(v => v.id === id);
                            if (!data) return;

                            const el = document.createElement('div');
                            el.className = 'bg-gray-800 p-2 rounded flex flex-col items-center cursor-pointer hover:bg-gray-700 border border-gray-600';
                            el.innerHTML = `
                                <img src="${data.src}" class="w-12 h-12 object-contain mb-1">
                                <span class="text-xs font-bold text-white font-jp">${data.name}</span>
                                <span class="text-xs text-gray-400">x${count}</span>
                            `;
                            el.onclick = () => giveGift(id, 'vegetable', data.name);
                            grid.appendChild(el);
                        });
                    }

                    // 2. Smoothies
                    if (state.smoothieStock) {
                        const smoothieCounts = {};
                        state.smoothieStock.forEach(id => {
                            smoothieCounts[id] = (smoothieCounts[id] || 0) + 1;
                        });

                        Object.keys(smoothieCounts).forEach(sId => {
                            const count = smoothieCounts[sId];
                            const data = SMOOTHIE_RECIPES.find(r => r.id === sId);
                            if (!data) return;

                            const el = document.createElement('div');
                            el.className = 'bg-pink-900/50 p-2 rounded flex flex-col items-center cursor-pointer hover:bg-pink-800/50 border border-pink-600';
                            el.innerHTML = `
                                <div class="text-2xl mb-1">🥤</div>
                                <span class="text-xs font-bold text-white font-jp">${data.name}</span>
                                <span class="text-xs text-gray-400">x${count}</span>
                            `;
                            el.onclick = () => giveGift(sId, 'smoothie', data.name);
                            grid.appendChild(el);
                        });
                    }
                }

                function giveGift(itemId, type, itemName) {
                    if (!confirm(`Give ${itemName}?`)) return;

                    closeGiftMenu();

                    // Remove item
                    if (type === 'vegetable') {
                        const idx = state.vegetableCollection.indexOf(itemId);
                        if (idx > -1) state.vegetableCollection.splice(idx, 1);
                    } else if (type === 'smoothie') {
                        const idx = state.smoothieStock.indexOf(itemId);
                        if (idx > -1) state.smoothieStock.splice(idx, 1);
                    }
                    saveGameData();

                    // Check Preferences
                    const custName = state.currentCustomer.name;
                    const prefs = GIFT_PREFERENCES[custName] || DEFAULT_PREFS;

                    let itemTags = [];
                    if (type === 'vegetable') {
                        const v = VEGETABLE_DATA.find(i => i.id === itemId);
                        if (v && v.tags) itemTags = v.tags;
                    } else if (type === 'smoothie') {
                        // Inherit tags from ingredients? Or just generic tags?
                        itemTags = ['smoothie', 'sweet', 'drink', 'special'];
                        // Find recipe to get ingredients
                        const r = SMOOTHIE_RECIPES.find(i => i.id === itemId);
                        if (r) {
                            r.ingredients.forEach(ingId => {
                                const ing = VEGETABLE_DATA.find(v => v.id === ingId);
                                if (ing && ing.tags) itemTags.push(...ing.tags);
                            });
                        }
                    }

                    // Matching Logic
                    let score = 0; // Neutral
                    // Check Match
                    const isLike = prefs.likes.some(tag => itemTags.includes(tag));
                    const isDislike = prefs.dislikes.some(tag => itemTags.includes(tag));

                    if (isDislike) {
                        score = -1;
                    } else if (isLike) {
                        score = 1;
                    }

                    // Result Effect
                    if (score === 1) {
                        // LOVE IT
                        playSound('success');
                        state.score += 500;
                        state.totalMoney += 200; // Tip
                        showDialogue([`Wow! I love this! Thank you!`, `What a wonderful gift!`, `You are the best!`]);
                        showFloatingText("❤️ LOVE IT! +¥200", "#f472b6", dom.customerEl);
                        createHearts(dom.customerEl);
                    } else if (score === -1) {
                        // HATE IT
                        playSound('fail');
                        showDialogue([`Eh... I'm not fond of this...`, `I'll take it since it's a gift...`, `...... (Bitter face)`]);
                        showFloatingText("💔 Oh no...", "#94a3b8", dom.customerEl);
                    } else {
                        // NEUTRAL
                        state.score += 100;
                        showDialogue([`Thanks, I'll cherish it.`, `Oh, thoughtful of you.`, `I'll accept this.`]);
                        showFloatingText("🎁 Thanks!", "#fbbf24", dom.customerEl);
                    }

                    updateScore();
                    updateUIDisplays();
                }

                // Expose globally
                window.openGiftMenu = openGiftMenu;
                window.closeGiftMenu = closeGiftMenu;
                window.giveGift = giveGift;
                window.openCocktailEncyclopedia = openCocktailEncyclopedia;
                window.closeCocktailEncyclopedia = closeCocktailEncyclopedia;
                window.openCustomerEncyclopedia = openCustomerEncyclopedia;
                window.closeCustomerEncyclopedia = closeCustomerEncyclopedia;
                window.openTitleList = openTitleList;
                window.closeTitleList = closeTitleList;
                window.openInteriorShop = openInteriorShop;
                window.closeInteriorShop = closeInteriorShop;
                window.saveGameManually = saveGameManually;
                window.openInquiry = openInquiry;
                window.closeInquiry = closeInquiry;
                window.submitInquiry = submitInquiry;
                window.openCollection = openCollection;
                window.closeCollection = closeCollection;
                window.returnToTitle = returnToTitle;
                window.closeMenu = closeMenu;
                window.closeDetailModal = closeDetailModal;
                window.closeTitleCelebration = closeTitleCelebration;
                window.openMarketOverlay = openMarketOverlay;
                window.closeMarketOverlay = closeMarketOverlay;
                window.openJukebox = openJukebox;
                window.closeJukebox = closeJukebox;
                window.openMarket = openMarket;
                window.closeMarket = closeMarket;
                window.setMarketMode = setMarketMode;
                window.showSaveSlots = showSaveSlots;
                window.hideSaveSlots = hideSaveSlots;
                window.clearKitchenSlot = clearKitchenSlot;
                window.mixSmoothie = mixSmoothie;
                window.selectGlass = selectGlass;
                window.toggleGestureShake = toggleGestureShake;
                window.openPhotoMode = openPhotoMode;
                window.closePhotoMode = closePhotoMode;
                window.downloadPhoto = downloadPhoto;
                window.shareToTwitter = shareToTwitter;
                window.shareToLINE = shareToLINE;
                window.openKitchenOverlay = openKitchenOverlay;
                window.closeKitchenOverlay = closeKitchenOverlay;

                // Ensure state init
                if (!state.vegetableCollection) state.vegetableCollection = [];

                initialSetup();

                // 「続きから」ボタンを常に有効化
                const continueBtn = document.getElementById('continue-game-btn');
                if (continueBtn) {
                    continueBtn.removeAttribute('disabled');
                    continueBtn.onclick = function () { loadAndStart(1); };
                    console.log('[Init] Continue button ENABLED (always)');
                }
            } catch (e) {
                alert("Init Error: " + e.message + "\n" + e.stack);
            }
        });
    </script>
    <audio id="bgm-audio" loop></audio>
    <audio id="title-bgm" src="sound/街の道路.mp3" loop preload="auto"></audio>

    <!-- Jukebox Overlay (Merged) -->
    <div id="jukebox-overlay" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center">
        <div class="bg-gray-900 p-6 rounded-xl max-w-md w-full border-4 border-indigo-500 relative shadow-2xl">
            <button onclick="closeJukebox()"
                class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h2
                class="text-2xl font-bold mb-6 font-jp text-indigo-300 text-center flex items-center justify-center gap-2">
                <span class="animate-spin-slow text-3xl">💿</span> Jukebox
            </h2>

            <div id="jukebox-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- Tracks injected by JS -->
            </div>

            <div class="mt-6 text-center text-gray-500 text-xs font-jp">
                Playing: <span id="current-bgm-name" class="text-indigo-400 font-bold">Standard Jazz</span>
            </div>
        </div>
    </div>


    <!-- Counseling Overlay -->
    <div id="counseling-overlay"
        class="fixed inset-0 bg-black/90 hidden z-[120] flex flex-col items-center justify-center p-6">
        <div class="bg-slate-800 rounded-2xl p-6 max-w-md w-full border border-slate-600 shadow-2xl">
            <div class="flex items-center gap-4 mb-4">
                <img id="counseling-customer-img" src=""
                    class="w-16 h-16 rounded-full bg-slate-900 border-2 border-slate-500">
                <div class="font-bold text-slate-200 font-jp text-lg">Consultation</div>
            </div>
            <p id="counseling-question" class="text-xl text-white font-jp mb-6 min-h-[3rem]">...</p>
            <div id="counseling-choices" class="flex flex-col gap-3">
                <!-- Injected buttons -->
            </div>
        </div>
    </div>

    <!-- Matchmaking Overlay -->
    <div id="matchmaking-overlay"
        class="fixed inset-0 bg-black/90 hidden z-[120] flex flex-col items-center justify-center p-6"
        onclick="closeMatchmaking()">
        <div class="bg-slate-800 rounded-2xl p-6 max-w-sm w-full border border-pink-500/50 shadow-2xl relative"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-pink-400 font-jp mb-4 text-center">Who to introduce?</h3>
            <div id="matchmaking-list" class="flex flex-col gap-2 max-h-[60vh] overflow-y-auto custom-scrollbar">
                <!-- Injected list -->
            </div>
            <button onclick="closeMatchmaking()"
                class="mt-4 w-full py-2 bg-slate-700 text-slate-300 rounded hover:bg-slate-600 font-jp">Cancel</button>
        </div>
    </div>
</body>

</html>